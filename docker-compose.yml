version: "3.9"

services:
  # Trusted Agent Hub - エージェント審査プラットフォーム
  trusted_agent_hub:
    build:
      context: .
      dockerfile: ./trusted_agent_hub/Dockerfile
    container_name: trusted_agent_hub
    ports:
      - "8080:8080"
    env_file:
      - .env
    environment:
      # Override only non-secret variables
      - DATABASE_URL=sqlite:////app/data/agent_store.db
      - PYTHONPATH=/app:/app/inspect-worker:/app/evaluation-runner/src
    volumes:
      # Mount data directory to host for easy access
      - ./trusted_agent_hub/data:/app/data
      # Development: Mount source code for hot reload
      - ./trusted_agent_hub/app:/app/app
      - ./trusted_agent_hub/evaluation-runner/src:/app/evaluation-runner/src
      - ./trusted_agent_hub/inspect-worker:/app/inspect-worker
    networks:
      - agent-net
    command: uvicorn app.main:app --host 0.0.0.0 --port 8080 --reload
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Secure Mediation Agent - メディエーションエージェント（Web UI）
  secure_mediation_agent:
    build:
      context: .
      dockerfile: ./secure-mediation-agent/Dockerfile
    container_name: secure_mediation_agent
    ports:
      - "8000:8000"
    environment:
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - GOOGLE_GENAI_USE_VERTEXAI=${GOOGLE_GENAI_USE_VERTEXAI:-0}
    networks:
      - agent-net
    depends_on:
      - airline_agent
      - hotel_agent
      - car_rental_agent
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Airline Agent - 航空会社エージェント
  airline_agent:
    build:
      context: .
      dockerfile: ./external-agents/trusted-agents/airline_agent/Dockerfile
    container_name: airline_agent
    ports:
      - "8002:8002"
    environment:
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - GOOGLE_GENAI_USE_VERTEXAI=${GOOGLE_GENAI_USE_VERTEXAI:-0}
      - AGENT_HOST=airline_agent
      - AGENT_PORT=8002
    networks:
      - agent-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/a2a/airline_agent/.well-known/agent.json"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Hotel Agent - ホテル予約エージェント
  hotel_agent:
    build:
      context: .
      dockerfile: ./external-agents/trusted-agents/hotel_agent/Dockerfile
    container_name: hotel_agent
    ports:
      - "8003:8003"
    environment:
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - GOOGLE_GENAI_USE_VERTEXAI=${GOOGLE_GENAI_USE_VERTEXAI:-0}
      - AGENT_HOST=hotel_agent
      - AGENT_PORT=8003
    networks:
      - agent-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/a2a/hotel_agent/.well-known/agent.json"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Car Rental Agent - レンタカーエージェント
  car_rental_agent:
    build:
      context: .
      dockerfile: ./external-agents/trusted-agents/car_rental_agent/Dockerfile
    container_name: car_rental_agent
    ports:
      - "8004:8004"
    environment:
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - GOOGLE_GENAI_USE_VERTEXAI=${GOOGLE_GENAI_USE_VERTEXAI:-0}
      - AGENT_HOST=car_rental_agent
      - AGENT_PORT=8004
    networks:
      - agent-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8004/a2a/car_rental_agent/.well-known/agent.json"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  agent-net:
    driver: bridge
