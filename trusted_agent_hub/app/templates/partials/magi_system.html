{# MAGI SYSTEM - Jury Judge Panel Component - Evangelion Faithful Design #}
{# Variables expected:
   - submission: The submission object
   - show_waiting_state: Boolean to show waiting state (for pre-evaluation)
#}

{% set show_realtime = submission.state == 'judge_panel_running' %}
{% set show_historical = submission.score_breakdown and submission.score_breakdown.judge_summary and submission.score_breakdown.judge_summary.scenarios %}
{% set collective = namespace(found=none) %}
{% if show_historical %}
    {% for scenario in submission.score_breakdown.judge_summary.scenarios %}
        {% if scenario.scenarioId == 'collective_judgment' %}
            {% set collective.found = scenario %}
        {% endif %}
    {% endfor %}
{% endif %}

{# Extract evaluation data for each juror from historical data #}
{% set balthasar_eval = namespace(found=none) %}
{% set casper_eval = namespace(found=none) %}
{% set melchior_eval = namespace(found=none) %}
{% if show_historical and collective.found and collective.found.phase1Evaluations %}
    {% for eval in collective.found.phase1Evaluations %}
        {% if 'claude' in eval.jurorId %}
            {% set balthasar_eval.found = eval %}
        {% elif 'gemini' in eval.jurorId %}
            {% set casper_eval.found = eval %}
        {% elif 'gpt-4o' in eval.jurorId %}
            {% set melchior_eval.found = eval %}
        {% endif %}
    {% endfor %}
{% endif %}

{# Helper to get vote text #}
{% macro vote_text(verdict) %}
{% if verdict == 'safe_pass' %}PASS{% elif verdict == 'unsafe_fail' %}FAIL{% elif verdict == 'needs_review' %}REVIEW{% else %}---{% endif %}
{% endmacro %}

{% macro vote_class(verdict) %}
{% if verdict == 'safe_pass' %}magi-vote-pass{% elif verdict == 'unsafe_fail' %}magi-vote-fail{% elif verdict == 'needs_review' %}magi-vote-review{% else %}{% endif %}
{% endmacro %}

<!-- Jury Judge - MAGI SYSTEM -->
<details id="details-judge" class="mb-6 rounded-lg overflow-hidden" {% if not show_waiting_state %}open{% endif %}>
    <summary class="text-lg font-semibold p-4 flex items-center cursor-pointer bg-gray-800 text-white">
        <span class="mr-2">⚖️</span> Jury Judge Panel - MAGI SYSTEM
        <span id="magi-phase-indicator" class="magi-phase-badge-title ml-4">
            {%- if show_historical and collective.found and collective.found.finalJudgment -%}Phase 3 完了
            {%- elif show_historical and collective.found and collective.found.discussionRounds -%}Phase 2
            {%- elif show_historical and collective.found and collective.found.phase1Evaluations -%}Phase 1
            {%- else -%}Phase 1{%- endif -%}
        </span>
        {% if show_realtime %}
        <span id="ws-status" class="ml-auto text-xs px-2 py-1 rounded bg-green-500 text-white animate-pulse">接続済み</span>
        {% elif show_waiting_state %}
        <span id="ws-status" class="ml-auto text-xs px-2 py-1 rounded bg-gray-500 text-white">待機中</span>
        {% endif %}
    </summary>

    <!-- MAGI System Container - Evangelion Faithful Design -->
    <div id="magi-container" class="magi-eva-container">

        <!-- Header Row: 提訴 label + System Info | Verdict Box (否決/決議) -->
        <div class="magi-header-row">
            <div class="magi-header-left">
                <div class="magi-label-teiso">提訴</div>
                <div class="magi-system-info">
                    <div class="magi-info-line">CODE: {{ submission.id[:8] if submission.id else '--------' }}</div>
                    <div class="magi-info-line">PHASE: <span id="magi-phase-display">{%- if show_historical and collective.found and collective.found.finalJudgment -%}3{%- elif show_historical and collective.found and collective.found.discussionRounds -%}2{%- else -%}1{%- endif -%}</span></div>
                    <div class="magi-info-line">TRUST: <span id="magi-trust-display">{{ submission.trust_score if submission.trust_score else '--' }}</span>/100</div>
                </div>
            </div>
            <div class="magi-header-right">
                <div class="magi-label-ketsugi">決議</div>
                <div class="magi-verdict-box">
                    <div id="magi-verdict-display" class="magi-verdict-text
                        {% if show_historical and collective.found and collective.found.finalJudgment %}
                            {% if collective.found.finalJudgment.finalVerdict == 'safe_pass' %}magi-verdict-pass
                            {% elif collective.found.finalJudgment.finalVerdict == 'unsafe_fail' %}magi-verdict-fail
                            {% else %}magi-verdict-review{% endif %}
                        {% else %}magi-verdict-pending{% endif %}">
                        {% if show_historical and collective.found and collective.found.finalJudgment %}
                            {% if collective.found.finalJudgment.finalVerdict == 'safe_pass' %}可決
                            {% elif collective.found.finalJudgment.finalVerdict == 'unsafe_fail' %}否決
                            {% else %}要確認{% endif %}
                        {% else %}---{% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Main MAGI Triangle Layout -->
        <div class="magi-triangle-container">
            <!-- BALTHASAR-2 (Top Center) - Large Red Octagon with Chat -->
            <div class="magi-balthasar-row">
                <div class="magi-unit-with-chat">
                    <div id="magi-balthasar" class="magi-unit magi-balthasar" data-juror="claude-3-haiku-20240307">
                        <div class="magi-unit-name">BALTHASAR・2</div>
                        <div class="magi-unit-vote {{ vote_class(balthasar_eval.found.verdict if balthasar_eval.found else none) }}" id="balthasar-vote">
                            {{ vote_text(balthasar_eval.found.verdict if balthasar_eval.found else none) }}
                        </div>
                        <div class="magi-unit-model">claude-3-haiku</div>
                        <div class="magi-unit-status" id="balthasar-status">{% if balthasar_eval.found %}完了{% else %}待機中{% endif %}</div>
                        <div class="magi-unit-scores" id="balthasar-scores">
                            {% set tc = balthasar_eval.found.taskCompletion or 0 if balthasar_eval.found else 0 %}
                            {% set tu = balthasar_eval.found.toolUsage or 0 if balthasar_eval.found else 0 %}
                            {% set au = balthasar_eval.found.autonomy or 0 if balthasar_eval.found else 0 %}
                            {% set sf = balthasar_eval.found.safety or 0 if balthasar_eval.found else 0 %}
                            <div class="magi-score-bar" data-axis="task"><span>T</span><div class="bar"><div class="fill" style="width:{{ (tc / 40 * 100) | int }}%"></div></div><span class="val">{{ tc | int }}</span></div>
                            <div class="magi-score-bar" data-axis="tool"><span>U</span><div class="bar"><div class="fill" style="width:{{ (tu / 30 * 100) | int }}%"></div></div><span class="val">{{ tu | int }}</span></div>
                            <div class="magi-score-bar" data-axis="auto"><span>A</span><div class="bar"><div class="fill" style="width:{{ (au / 20 * 100) | int }}%"></div></div><span class="val">{{ au | int }}</span></div>
                            <div class="magi-score-bar" data-axis="safe"><span>S</span><div class="bar"><div class="fill" style="width:{{ (sf / 10 * 100) | int }}%"></div></div><span class="val">{{ sf | int }}</span></div>
                        </div>
                    </div>
                    <div class="magi-chat-box magi-chat-balthasar" id="balthasar-chat">
                        <div class="magi-chat-content" id="balthasar-chat-content">
                            {% if balthasar_eval.found and balthasar_eval.found.rationale %}
                            <div class="magi-chat-message">{{ balthasar_eval.found.rationale }}</div>
                            {% else %}
                            <div class="magi-chat-placeholder">待機中...</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Connection from BALTHASAR to MAGI -->
            <div class="magi-connector magi-connector-top"></div>

            <!-- MAGI Logo (Center) -->
            <div class="magi-logo-row">
                <div class="magi-logo">MAGI</div>
            </div>

            <!-- Connectors from MAGI to bottom units -->
            <div class="magi-connectors-bottom">
                <div class="magi-connector magi-connector-left"></div>
                <div class="magi-connector magi-connector-right"></div>
            </div>

            <!-- Bottom Row: CASPER-3 (Cyan) and MELCHIOR-1 (Red) with Chats -->
            <div class="magi-bottom-row">
                <!-- CASPER-3 (Left) - Cyan Pentagon -->
                <div class="magi-unit-with-chat magi-unit-left">
                    <div class="magi-chat-box magi-chat-casper" id="casper-chat">
                        <div class="magi-chat-content" id="casper-chat-content">
                            {% if casper_eval.found and casper_eval.found.rationale %}
                            <div class="magi-chat-message">{{ casper_eval.found.rationale }}</div>
                            {% else %}
                            <div class="magi-chat-placeholder">待機中...</div>
                            {% endif %}
                        </div>
                    </div>
                    <div id="magi-casper" class="magi-unit magi-casper" data-juror="gemini-2.5-flash">
                        <div class="magi-unit-name">CASPER・3</div>
                        <div class="magi-unit-vote {{ vote_class(casper_eval.found.verdict if casper_eval.found else none) }}" id="casper-vote">
                            {{ vote_text(casper_eval.found.verdict if casper_eval.found else none) }}
                        </div>
                        <div class="magi-unit-model">gemini-2.5-flash</div>
                        <div class="magi-unit-status" id="casper-status">{% if casper_eval.found %}完了{% else %}待機中{% endif %}</div>
                        <div class="magi-unit-scores" id="casper-scores">
                            {% set tc = casper_eval.found.taskCompletion or 0 if casper_eval.found else 0 %}
                            {% set tu = casper_eval.found.toolUsage or 0 if casper_eval.found else 0 %}
                            {% set au = casper_eval.found.autonomy or 0 if casper_eval.found else 0 %}
                            {% set sf = casper_eval.found.safety or 0 if casper_eval.found else 0 %}
                            <div class="magi-score-bar" data-axis="task"><span>T</span><div class="bar"><div class="fill" style="width:{{ (tc / 40 * 100) | int }}%"></div></div><span class="val">{{ tc | int }}</span></div>
                            <div class="magi-score-bar" data-axis="tool"><span>U</span><div class="bar"><div class="fill" style="width:{{ (tu / 30 * 100) | int }}%"></div></div><span class="val">{{ tu | int }}</span></div>
                            <div class="magi-score-bar" data-axis="auto"><span>A</span><div class="bar"><div class="fill" style="width:{{ (au / 20 * 100) | int }}%"></div></div><span class="val">{{ au | int }}</span></div>
                            <div class="magi-score-bar" data-axis="safe"><span>S</span><div class="bar"><div class="fill" style="width:{{ (sf / 10 * 100) | int }}%"></div></div><span class="val">{{ sf | int }}</span></div>
                        </div>
                    </div>
                </div>

                <!-- MELCHIOR-1 (Right) - Red Pentagon -->
                <div class="magi-unit-with-chat magi-unit-right">
                    <div id="magi-melchior" class="magi-unit magi-melchior" data-juror="gpt-4o">
                        <div class="magi-unit-name">MELCHIOR・1</div>
                        <div class="magi-unit-vote {{ vote_class(melchior_eval.found.verdict if melchior_eval.found else none) }}" id="melchior-vote">
                            {{ vote_text(melchior_eval.found.verdict if melchior_eval.found else none) }}
                        </div>
                        <div class="magi-unit-model">gpt-4o</div>
                        <div class="magi-unit-status" id="melchior-status">{% if melchior_eval.found %}完了{% else %}待機中{% endif %}</div>
                        <div class="magi-unit-scores" id="melchior-scores">
                            {% set tc = melchior_eval.found.taskCompletion or 0 if melchior_eval.found else 0 %}
                            {% set tu = melchior_eval.found.toolUsage or 0 if melchior_eval.found else 0 %}
                            {% set au = melchior_eval.found.autonomy or 0 if melchior_eval.found else 0 %}
                            {% set sf = melchior_eval.found.safety or 0 if melchior_eval.found else 0 %}
                            <div class="magi-score-bar" data-axis="task"><span>T</span><div class="bar"><div class="fill" style="width:{{ (tc / 40 * 100) | int }}%"></div></div><span class="val">{{ tc | int }}</span></div>
                            <div class="magi-score-bar" data-axis="tool"><span>U</span><div class="bar"><div class="fill" style="width:{{ (tu / 30 * 100) | int }}%"></div></div><span class="val">{{ tu | int }}</span></div>
                            <div class="magi-score-bar" data-axis="auto"><span>A</span><div class="bar"><div class="fill" style="width:{{ (au / 20 * 100) | int }}%"></div></div><span class="val">{{ au | int }}</span></div>
                            <div class="magi-score-bar" data-axis="safe"><span>S</span><div class="bar"><div class="fill" style="width:{{ (sf / 10 * 100) | int }}%"></div></div><span class="val">{{ sf | int }}</span></div>
                        </div>
                    </div>
                    <div class="magi-chat-box magi-chat-melchior" id="melchior-chat">
                        <div class="magi-chat-content" id="melchior-chat-content">
                            {% if melchior_eval.found and melchior_eval.found.rationale %}
                            <div class="magi-chat-message">{{ melchior_eval.found.rationale }}</div>
                            {% else %}
                            <div class="magi-chat-placeholder">待機中...</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Scores (Collapsed by default) -->
        {% if submission.score_breakdown and submission.score_breakdown.judge_summary %}
        <details class="magi-details-section mt-6">
            <summary class="magi-details-summary">詳細スコア・設定</summary>
            <div class="magi-details-content bg-gray-800 p-4 rounded-lg mt-2">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                    <div class="bg-blue-900/50 p-3 rounded border border-blue-500/30">
                        <div class="text-xs text-blue-300">Task Completion</div>
                        <div class="text-2xl font-bold text-blue-400" data-judge-task>{{ submission.score_breakdown.judge_summary.taskCompletion or 0 }}/40</div>
                    </div>
                    <div class="bg-green-900/50 p-3 rounded border border-green-500/30">
                        <div class="text-xs text-green-300">Tool Usage</div>
                        <div class="text-2xl font-bold text-green-400" data-judge-tool>{{ submission.score_breakdown.judge_summary.tool or 0 }}/30</div>
                    </div>
                    <div class="bg-yellow-900/50 p-3 rounded border border-yellow-500/30">
                        <div class="text-xs text-yellow-300">Autonomy</div>
                        <div class="text-2xl font-bold text-yellow-400" data-judge-autonomy>{{ submission.score_breakdown.judge_summary.autonomy or 0 }}/20</div>
                    </div>
                    <div class="bg-red-900/50 p-3 rounded border border-red-500/30">
                        <div class="text-xs text-red-300">Safety</div>
                        <div class="text-2xl font-bold text-red-400" data-judge-safety>{{ submission.score_breakdown.judge_summary.safety or 0 }}/10</div>
                    </div>
                </div>
            </div>
        </details>
        {% endif %}
    </div>
</details>

<!-- MAGI System CSS - Evangelion Faithful Design -->
<style>
    /* ===== Container ===== */
    .magi-eva-container {
        font-family: 'Courier New', monospace;
        color: #eaeaea;
        padding: 20px;
        background: linear-gradient(180deg, #2a2a3e 0%, #1a1a2e 100%);
        position: relative;
    }

    /* ===== Phase Badge ===== */
    .magi-phase-badge-title {
        display: inline-block;
        font-size: 11px;
        padding: 4px 12px;
        background: linear-gradient(135deg, #be4bdb, #e94560);
        border-radius: 12px;
        font-weight: bold;
    }

    /* ===== Header Row ===== */
    .magi-header-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 16px;
        padding: 0 10px;
    }
    .magi-header-left, .magi-header-right {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    .magi-header-right {
        align-items: flex-end;
    }

    /* 提訴/決議 Labels */
    .magi-label-teiso, .magi-label-ketsugi {
        font-size: 24px;
        font-weight: bold;
        padding: 4px 16px;
        border: 2px solid;
    }
    .magi-label-teiso {
        color: #00e5ff;
        border-color: #00e5ff;
        text-shadow: 0 0 10px #00e5ff;
    }
    .magi-label-ketsugi {
        color: #ff5252;
        border-color: #ff5252;
        text-shadow: 0 0 10px #ff5252;
    }

    /* System Info */
    .magi-system-info {
        font-size: 11px;
        color: #ffd43b;
        text-shadow: 0 0 5px rgba(255, 212, 59, 0.5);
        padding: 8px;
        background: rgba(0, 0, 0, 0.4);
    }
    .magi-info-line {
        margin-bottom: 2px;
    }

    /* Verdict Box */
    .magi-verdict-box {
        display: flex;
        justify-content: center;
    }
    .magi-verdict-text {
        font-size: 36px;
        font-weight: bold;
        padding: 12px 24px;
        border: 3px solid;
        text-align: center;
        min-width: 100px;
    }
    .magi-verdict-pass {
        color: #51cf66;
        border-color: #51cf66;
        text-shadow: 0 0 20px #51cf66;
        background: rgba(81, 207, 102, 0.15);
    }
    .magi-verdict-fail {
        color: #ff5252;
        border-color: #ff5252;
        text-shadow: 0 0 20px #ff5252;
        background: rgba(255, 82, 82, 0.15);
        animation: verdict-pulse-red 1.5s ease-in-out infinite;
    }
    .magi-verdict-review {
        color: #ffd43b;
        border-color: #ffd43b;
        text-shadow: 0 0 20px #ffd43b;
        background: rgba(255, 212, 59, 0.15);
    }
    .magi-verdict-pending {
        color: #718096;
        border-color: #718096;
        background: rgba(113, 128, 150, 0.1);
    }

    @keyframes verdict-pulse-red {
        0%, 100% { box-shadow: 0 0 15px rgba(255, 82, 82, 0.5); }
        50% { box-shadow: 0 0 30px rgba(255, 82, 82, 0.8), 0 0 50px rgba(255, 82, 82, 0.4); }
    }

    /* ===== Triangle Container ===== */
    .magi-triangle-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0;
    }

    /* ===== BALTHASAR Row (Top) ===== */
    .magi-balthasar-row {
        display: flex;
        justify-content: center;
        width: 100%;
    }

    /* ===== MAGI Unit with Chat ===== */
    .magi-unit-with-chat {
        display: flex;
        align-items: stretch;
        gap: 12px;
    }
    .magi-unit-left {
        flex-direction: row;
    }
    .magi-unit-right {
        flex-direction: row;
    }

    /* ===== MAGI Units ===== */
    .magi-unit {
        padding: 20px 16px;
        border: 3px solid;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
        min-width: 160px;
        position: relative;
    }

    /* BALTHASAR - Red Octagon (Large) */
    .magi-balthasar {
        background: linear-gradient(180deg, #c62828 0%, #8e0000 100%);
        border-color: #ff5252;
        clip-path: polygon(30% 0%, 70% 0%, 100% 30%, 100% 70%, 70% 100%, 30% 100%, 0% 70%, 0% 30%);
        min-width: 200px;
        min-height: 220px;
        padding: 30px 20px;
    }

    /* CASPER - Cyan Pentagon */
    .magi-casper {
        background: linear-gradient(180deg, #00acc1 0%, #006064 100%);
        border-color: #00e5ff;
        clip-path: polygon(50% 0%, 100% 38%, 82% 100%, 18% 100%, 0% 38%);
        min-width: 180px;
        min-height: 180px;
    }

    /* MELCHIOR - Red Pentagon */
    .magi-melchior {
        background: linear-gradient(180deg, #c62828 0%, #8e0000 100%);
        border-color: #ff5252;
        clip-path: polygon(50% 0%, 100% 38%, 82% 100%, 18% 100%, 0% 38%);
        min-width: 180px;
        min-height: 180px;
    }

    .magi-unit-name {
        font-size: 16px;
        font-weight: bold;
        color: #fff;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
        letter-spacing: 1px;
    }

    .magi-unit-vote {
        font-size: 18px;
        font-weight: bold;
        padding: 4px 12px;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 4px;
        color: #fff;
    }
    .magi-vote-pass { color: #51cf66; text-shadow: 0 0 10px #51cf66; }
    .magi-vote-fail { color: #ff5252; text-shadow: 0 0 10px #ff5252; }
    .magi-vote-review { color: #ffd43b; text-shadow: 0 0 10px #ffd43b; }

    .magi-unit-model {
        font-size: 9px;
        opacity: 0.7;
        color: #ccc;
    }

    .magi-unit-status {
        font-size: 9px;
        padding: 2px 6px;
        background: rgba(0, 0, 0, 0.4);
        border-radius: 3px;
    }

    /* Score Bars */
    .magi-unit-scores {
        display: flex;
        flex-direction: column;
        gap: 2px;
        width: 100%;
        max-width: 120px;
        margin-top: 6px;
    }
    .magi-score-bar {
        display: flex;
        align-items: center;
        font-size: 8px;
        gap: 3px;
    }
    .magi-score-bar > span:first-child {
        width: 10px;
        font-weight: bold;
    }
    .magi-score-bar .bar {
        flex: 1;
        height: 5px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 2px;
        overflow: hidden;
    }
    .magi-score-bar .fill {
        height: 100%;
        border-radius: 2px;
        transition: width 0.5s ease;
    }
    .magi-score-bar .val {
        width: 16px;
        text-align: right;
        font-size: 7px;
        opacity: 0.8;
    }
    .magi-score-bar[data-axis="task"] .fill { background: #4dabf7; }
    .magi-score-bar[data-axis="tool"] .fill { background: #51cf66; }
    .magi-score-bar[data-axis="auto"] .fill { background: #ffd43b; }
    .magi-score-bar[data-axis="safe"] .fill { background: #ff6b6b; }

    /* ===== Chat Boxes ===== */
    .magi-chat-box {
        background: rgba(0, 0, 0, 0.5);
        border: 2px solid;
        border-radius: 4px;
        padding: 8px;
        min-width: 200px;
        max-width: 280px;
        max-height: 180px;
        overflow-y: auto;
    }
    .magi-chat-balthasar {
        border-color: #ff5252;
    }
    .magi-chat-casper {
        border-color: #00e5ff;
    }
    .magi-chat-melchior {
        border-color: #ff5252;
    }
    .magi-chat-content {
        font-size: 10px;
        line-height: 1.4;
        color: #ddd;
    }
    .magi-chat-message {
        white-space: pre-wrap;
        word-break: break-word;
    }
    .magi-chat-placeholder {
        opacity: 0.5;
        font-style: italic;
        text-align: center;
        padding: 20px 0;
    }

    /* ===== Connectors ===== */
    .magi-connector {
        background: linear-gradient(180deg, #ffa500, #ff6600);
        box-shadow: 0 0 8px rgba(255, 165, 0, 0.6);
    }
    .magi-connector-top {
        width: 4px;
        height: 30px;
    }

    /* ===== MAGI Logo ===== */
    .magi-logo-row {
        display: flex;
        justify-content: center;
        margin: 8px 0;
    }
    .magi-logo {
        font-size: 24px;
        font-weight: bold;
        color: #ffd43b;
        text-shadow: 0 0 15px #ffd43b;
        padding: 8px 24px;
        border: 3px solid #ffd43b;
        background: rgba(0, 0, 0, 0.7);
        letter-spacing: 6px;
    }

    /* Bottom Connectors */
    .magi-connectors-bottom {
        display: flex;
        justify-content: center;
        gap: 200px;
        margin-bottom: 8px;
    }
    .magi-connector-left, .magi-connector-right {
        width: 4px;
        height: 30px;
        background: linear-gradient(180deg, #ffa500, #ff6600);
        box-shadow: 0 0 8px rgba(255, 165, 0, 0.6);
    }

    /* ===== Bottom Row ===== */
    .magi-bottom-row {
        display: flex;
        justify-content: center;
        gap: 60px;
        width: 100%;
    }

    /* ===== Animations ===== */
    .magi-unit.evaluating {
        animation: pulse-evaluating 1.5s ease-in-out infinite;
    }
    @keyframes pulse-evaluating {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
    }

    .magi-unit.vote-confirmed {
        animation: vote-glow 1s ease-in-out 3;
    }
    @keyframes vote-glow {
        0%, 100% { box-shadow: 0 0 10px var(--glow-color, #51cf66); }
        50% { box-shadow: 0 0 30px var(--glow-color, #51cf66), 0 0 50px var(--glow-color, #51cf66); }
    }

    /* Typing cursor for chat */
    .magi-chat-message.typing::after {
        content: '|';
        color: #00ff88;
        animation: cursor-blink 0.7s infinite;
    }
    @keyframes cursor-blink {
        0%, 50% { opacity: 1; }
        51%, 100% { opacity: 0; }
    }

    /* Position changed message (during discussion) */
    .magi-chat-message.position-changed {
        background: rgba(77, 171, 247, 0.2);
        border-left: 2px solid #4dabf7;
        padding-left: 8px;
        margin-left: -8px;
    }

    /* ===== Details Section ===== */
    .magi-details-section {
        color: #eaeaea;
    }
    .magi-details-summary {
        cursor: pointer;
        padding: 10px 14px;
        background: rgba(255, 255, 255, 0.08);
        border-radius: 4px;
        font-size: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .magi-details-summary:hover {
        background: rgba(255, 255, 255, 0.12);
    }

    /* ===== Responsive ===== */
    @media (max-width: 900px) {
        .magi-unit-with-chat {
            flex-direction: column;
        }
        .magi-bottom-row {
            flex-direction: column;
            align-items: center;
            gap: 24px;
        }
        .magi-connectors-bottom {
            display: none;
        }
        .magi-chat-box {
            max-width: 100%;
        }
    }
</style>
