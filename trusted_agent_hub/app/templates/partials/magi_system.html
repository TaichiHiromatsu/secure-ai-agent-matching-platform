{# MAGI SYSTEM - Jury Judge Panel Component - Evangelion Faithful Design (Phase 3) #}
{# Variables expected:
   - submission: The submission object
   - show_waiting_state: Boolean to show waiting state (for pre-evaluation)
#}

{% set show_realtime = submission.state == 'judge_panel_running' %}
{% set show_historical = submission.score_breakdown and submission.score_breakdown.judge_summary and submission.score_breakdown.judge_summary.scenarios %}
{% set collective = namespace(found=none) %}
{% if show_historical %}
    {% for scenario in submission.score_breakdown.judge_summary.scenarios %}
        {% if scenario.scenarioId == 'collective_judgment' %}
            {% set collective.found = scenario %}
        {% endif %}
    {% endfor %}
{% endif %}

{# Extract evaluation data for each juror from historical data #}
{% set balthasar_eval = namespace(found=none) %}
{% set casper_eval = namespace(found=none) %}
{% set melchior_eval = namespace(found=none) %}
{% if show_historical and collective.found and collective.found.phase1Evaluations %}
    {% for eval in collective.found.phase1Evaluations %}
        {% if 'claude' in eval.jurorId %}
            {% set balthasar_eval.found = eval %}
        {% elif 'gemini' in eval.jurorId %}
            {% set casper_eval.found = eval %}
        {% elif 'gpt-4o' in eval.jurorId %}
            {% set melchior_eval.found = eval %}
        {% endif %}
    {% endfor %}
{% endif %}

{# Extract final judgment data #}
{% set final_judgment = namespace(found=none) %}
{% if show_historical and collective.found and collective.found.finalJudgment %}
    {% set final_judgment.found = collective.found.finalJudgment %}
{% endif %}

{# Helper to get vote text #}
{% macro vote_text(verdict) %}
{% if verdict == 'safe_pass' %}PASS{% elif verdict == 'unsafe_fail' %}FAIL{% elif verdict == 'needs_review' %}REVIEW{% else %}---{% endif %}
{% endmacro %}

{% macro vote_class(verdict) %}
{% if verdict == 'safe_pass' %}magi-vote-pass{% elif verdict == 'unsafe_fail' %}magi-vote-fail{% elif verdict == 'needs_review' %}magi-vote-review{% else %}{% endif %}
{% endmacro %}

{# Helper to get verdict class for unit background - only after verdict is set #}
{% macro unit_verdict_class(verdict) %}
{% if verdict == 'safe_pass' %}verdict-pass{% elif verdict == 'unsafe_fail' %}verdict-fail{% elif verdict == 'needs_review' %}verdict-review{% else %}{% endif %}
{% endmacro %}

<!-- Jury Judge - MAGI SYSTEM -->
<details id="details-judge" class="mb-6 rounded-lg overflow-hidden" {% if not show_waiting_state %}open{% endif %}>
    <summary class="text-lg font-semibold p-4 flex items-center cursor-pointer bg-gray-800 text-white">
        <span class="mr-2">⚖️</span> Jury Judge Panel - MAGI SYSTEM
        <span id="magi-phase-indicator" class="magi-phase-badge-title ml-4">
            {%- if show_historical and collective.found and collective.found.finalJudgment -%}Phase 3 完了
            {%- elif show_historical and collective.found and collective.found.discussionRounds -%}Phase 2
            {%- elif show_historical and collective.found and collective.found.phase1Evaluations -%}Phase 1
            {%- else -%}Phase 1{%- endif -%}
        </span>
        {% if show_realtime %}
        <span id="ws-status" class="ml-auto text-xs px-2 py-1 rounded bg-green-500 text-white animate-pulse">接続済み</span>
        {% elif show_waiting_state %}
        <span id="ws-status" class="ml-auto text-xs px-2 py-1 rounded bg-gray-500 text-white">待機中</span>
        {% endif %}
    </summary>

    <!-- MAGI System Container - Evangelion Faithful Design (Phase 3) -->
    <div id="magi-container" class="magi-eva-container">

        <!-- 3-Column Grid Layout -->
        <div class="magi-grid-layout">

            <!-- ===== 左列: 提訴 + BALTHASARチャット + CASPERチャット ===== -->
            <div class="magi-left-column">
                <div class="magi-label-teiso">提訴</div>
                <div class="magi-system-info">
                    <div class="magi-info-line">CODE: {{ submission.id[:8] if submission.id else '--------' }}</div>
                    <div class="magi-info-line">PHASE: <span id="magi-phase-display">{%- if show_historical and collective.found and collective.found.finalJudgment -%}3{%- elif show_historical and collective.found and collective.found.discussionRounds -%}2{%- else -%}1{%- endif -%}</span></div>
                    <div class="magi-info-line">TRUST: <span id="magi-trust-display">{{ submission.trust_score if submission.trust_score else '--' }}</span>/100</div>
                </div>

                <!-- BALTHASAR Chat (黄色枠) -->
                <div class="magi-chat-box magi-chat-yellow" id="balthasar-chat">
                    <div class="magi-chat-header">BALTHASAR・2</div>
                    <div class="magi-chat-content" id="balthasar-chat-content">
                        {% if balthasar_eval.found and balthasar_eval.found.rationale %}
                        <div class="magi-chat-message">{{ balthasar_eval.found.rationale }}</div>
                        {% else %}
                        <div class="magi-chat-placeholder">待機中...</div>
                        {% endif %}
                    </div>
                </div>

                <!-- CASPER Chat (黄色枠) -->
                <div class="magi-chat-box magi-chat-yellow" id="casper-chat">
                    <div class="magi-chat-header">CASPER・3</div>
                    <div class="magi-chat-content" id="casper-chat-content">
                        {% if casper_eval.found and casper_eval.found.rationale %}
                        <div class="magi-chat-message">{{ casper_eval.found.rationale }}</div>
                        {% else %}
                        <div class="magi-chat-placeholder">待機中...</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- ===== 中央列: BALTHASAR + MAGI + CASPER/MELCHIOR ===== -->
            <div class="magi-center-column">
                <!-- BALTHASAR-2 (縦長六角形 - 下角2つカット) -->
                <div id="magi-balthasar" class="magi-unit magi-balthasar {{ unit_verdict_class(balthasar_eval.found.verdict if balthasar_eval.found else none) }}" data-juror="claude-3-haiku-20240307">
                    <div class="magi-unit-name">BALTHASAR・2</div>
                    <div class="magi-unit-vote {{ vote_class(balthasar_eval.found.verdict if balthasar_eval.found else none) }}" id="balthasar-vote">
                        {{ vote_text(balthasar_eval.found.verdict if balthasar_eval.found else none) }}
                    </div>
                    <div class="magi-unit-model">claude-3-haiku</div>
                    <div class="magi-unit-status" id="balthasar-status">{% if balthasar_eval.found %}完了{% else %}待機中{% endif %}</div>
                    <div class="magi-unit-scores" id="balthasar-scores">
                        {% set tc = balthasar_eval.found.taskCompletion or 0 if balthasar_eval.found else 0 %}
                        {% set tu = balthasar_eval.found.toolUsage or 0 if balthasar_eval.found else 0 %}
                        {% set au = balthasar_eval.found.autonomy or 0 if balthasar_eval.found else 0 %}
                        {% set sf = balthasar_eval.found.safety or 0 if balthasar_eval.found else 0 %}
                        <div class="magi-score-bar" data-axis="task"><span>T</span><div class="bar"><div class="fill" style="width:{{ (tc / 40 * 100) | int }}%"></div></div><span class="val">{{ tc | int }}</span></div>
                        <div class="magi-score-bar" data-axis="tool"><span>U</span><div class="bar"><div class="fill" style="width:{{ (tu / 30 * 100) | int }}%"></div></div><span class="val">{{ tu | int }}</span></div>
                        <div class="magi-score-bar" data-axis="auto"><span>A</span><div class="bar"><div class="fill" style="width:{{ (au / 20 * 100) | int }}%"></div></div><span class="val">{{ au | int }}</span></div>
                        <div class="magi-score-bar" data-axis="safe"><span>S</span><div class="bar"><div class="fill" style="width:{{ (sf / 10 * 100) | int }}%"></div></div><span class="val">{{ sf | int }}</span></div>
                    </div>
                </div>

                <!-- Connection from BALTHASAR to MAGI -->
                <div class="magi-connector"></div>

                <!-- MAGI Logo (Center) -->
                <div class="magi-logo">MAGI</div>

                <!-- Connectors from MAGI to bottom units -->
                <div class="magi-connectors-split">
                    <div class="magi-connector-branch magi-connector-left"></div>
                    <div class="magi-connector-branch magi-connector-right"></div>
                </div>

                <!-- Bottom Row: CASPER-3 and MELCHIOR-1 -->
                <div class="magi-bottom-units">
                    <!-- CASPER-3 (左下角欠け四角形) -->
                    <div id="magi-casper" class="magi-unit magi-casper {{ unit_verdict_class(casper_eval.found.verdict if casper_eval.found else none) }}" data-juror="gemini-2.5-flash">
                        <div class="magi-unit-name">CASPER・3</div>
                        <div class="magi-unit-vote {{ vote_class(casper_eval.found.verdict if casper_eval.found else none) }}" id="casper-vote">
                            {{ vote_text(casper_eval.found.verdict if casper_eval.found else none) }}
                        </div>
                        <div class="magi-unit-model">gemini-2.5-flash</div>
                        <div class="magi-unit-status" id="casper-status">{% if casper_eval.found %}完了{% else %}待機中{% endif %}</div>
                        <div class="magi-unit-scores" id="casper-scores">
                            {% set tc = casper_eval.found.taskCompletion or 0 if casper_eval.found else 0 %}
                            {% set tu = casper_eval.found.toolUsage or 0 if casper_eval.found else 0 %}
                            {% set au = casper_eval.found.autonomy or 0 if casper_eval.found else 0 %}
                            {% set sf = casper_eval.found.safety or 0 if casper_eval.found else 0 %}
                            <div class="magi-score-bar" data-axis="task"><span>T</span><div class="bar"><div class="fill" style="width:{{ (tc / 40 * 100) | int }}%"></div></div><span class="val">{{ tc | int }}</span></div>
                            <div class="magi-score-bar" data-axis="tool"><span>U</span><div class="bar"><div class="fill" style="width:{{ (tu / 30 * 100) | int }}%"></div></div><span class="val">{{ tu | int }}</span></div>
                            <div class="magi-score-bar" data-axis="auto"><span>A</span><div class="bar"><div class="fill" style="width:{{ (au / 20 * 100) | int }}%"></div></div><span class="val">{{ au | int }}</span></div>
                            <div class="magi-score-bar" data-axis="safe"><span>S</span><div class="bar"><div class="fill" style="width:{{ (sf / 10 * 100) | int }}%"></div></div><span class="val">{{ sf | int }}</span></div>
                        </div>
                    </div>

                    <!-- MELCHIOR-1 (右下角欠け四角形) -->
                    <div id="magi-melchior" class="magi-unit magi-melchior {{ unit_verdict_class(melchior_eval.found.verdict if melchior_eval.found else none) }}" data-juror="gpt-4o">
                        <div class="magi-unit-name">MELCHIOR・1</div>
                        <div class="magi-unit-vote {{ vote_class(melchior_eval.found.verdict if melchior_eval.found else none) }}" id="melchior-vote">
                            {{ vote_text(melchior_eval.found.verdict if melchior_eval.found else none) }}
                        </div>
                        <div class="magi-unit-model">gpt-4o</div>
                        <div class="magi-unit-status" id="melchior-status">{% if melchior_eval.found %}完了{% else %}待機中{% endif %}</div>
                        <div class="magi-unit-scores" id="melchior-scores">
                            {% set tc = melchior_eval.found.taskCompletion or 0 if melchior_eval.found else 0 %}
                            {% set tu = melchior_eval.found.toolUsage or 0 if melchior_eval.found else 0 %}
                            {% set au = melchior_eval.found.autonomy or 0 if melchior_eval.found else 0 %}
                            {% set sf = melchior_eval.found.safety or 0 if melchior_eval.found else 0 %}
                            <div class="magi-score-bar" data-axis="task"><span>T</span><div class="bar"><div class="fill" style="width:{{ (tc / 40 * 100) | int }}%"></div></div><span class="val">{{ tc | int }}</span></div>
                            <div class="magi-score-bar" data-axis="tool"><span>U</span><div class="bar"><div class="fill" style="width:{{ (tu / 30 * 100) | int }}%"></div></div><span class="val">{{ tu | int }}</span></div>
                            <div class="magi-score-bar" data-axis="auto"><span>A</span><div class="bar"><div class="fill" style="width:{{ (au / 20 * 100) | int }}%"></div></div><span class="val">{{ au | int }}</span></div>
                            <div class="magi-score-bar" data-axis="safe"><span>S</span><div class="bar"><div class="fill" style="width:{{ (sf / 10 * 100) | int }}%"></div></div><span class="val">{{ sf | int }}</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ===== 右列: FINAL JUDGEチャット + 判定表示 + MELCHIORチャット ===== -->
            <div class="magi-right-column">
                <!-- FINAL JUDGE Chat (水色枠 - Phase 3まで非表示) -->
                <div class="magi-chat-box magi-chat-cyan magi-final-judge-chat" id="final-judge-chat" style="{% if not (show_historical and collective.found and collective.found.finalJudgment) %}display: none;{% endif %}">
                    <div class="magi-chat-header">FINAL JUDGE</div>
                    <div class="magi-chat-content" id="final-judge-content">
                        {% if final_judgment.found and final_judgment.found.rationale %}
                        <div class="magi-chat-message">{{ final_judgment.found.rationale }}</div>
                        {% else %}
                        <div class="magi-chat-placeholder">最終判定待ち...</div>
                        {% endif %}
                    </div>
                </div>

                <!-- 判定表示 (赤枠 - 真ん中右) -->
                <div class="magi-verdict-box">
                    <div class="magi-verdict-label">決議</div>
                    <div id="magi-verdict-display" class="magi-verdict-text
                        {% if show_historical and collective.found and collective.found.finalJudgment %}
                            {% if collective.found.finalJudgment.finalVerdict == 'safe_pass' %}magi-verdict-pass
                            {% elif collective.found.finalJudgment.finalVerdict == 'unsafe_fail' %}magi-verdict-fail
                            {% else %}magi-verdict-review{% endif %}
                        {% else %}magi-verdict-pending{% endif %}">
                        {% if show_historical and collective.found and collective.found.finalJudgment %}
                            {% if collective.found.finalJudgment.finalVerdict == 'safe_pass' %}可決
                            {% elif collective.found.finalJudgment.finalVerdict == 'unsafe_fail' %}否決
                            {% else %}要確認{% endif %}
                        {% else %}---{% endif %}
                    </div>
                </div>

                <!-- MELCHIOR Chat (黄色枠) -->
                <div class="magi-chat-box magi-chat-yellow" id="melchior-chat">
                    <div class="magi-chat-header">MELCHIOR・1</div>
                    <div class="magi-chat-content" id="melchior-chat-content">
                        {% if melchior_eval.found and melchior_eval.found.rationale %}
                        <div class="magi-chat-message">{{ melchior_eval.found.rationale }}</div>
                        {% else %}
                        <div class="magi-chat-placeholder">待機中...</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Scores (Collapsed by default) -->
        {% if submission.score_breakdown and submission.score_breakdown.judge_summary %}
        <details class="magi-details-section mt-6">
            <summary class="magi-details-summary">詳細スコア・設定</summary>
            <div class="magi-details-content bg-gray-800 p-4 rounded-lg mt-2">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                    <div class="bg-blue-900/50 p-3 rounded border border-blue-500/30">
                        <div class="text-xs text-blue-300">Task Completion</div>
                        <div class="text-2xl font-bold text-blue-400" data-judge-task>{{ submission.score_breakdown.judge_summary.taskCompletion or 0 }}/40</div>
                    </div>
                    <div class="bg-green-900/50 p-3 rounded border border-green-500/30">
                        <div class="text-xs text-green-300">Tool Usage</div>
                        <div class="text-2xl font-bold text-green-400" data-judge-tool>{{ submission.score_breakdown.judge_summary.tool or 0 }}/30</div>
                    </div>
                    <div class="bg-yellow-900/50 p-3 rounded border border-yellow-500/30">
                        <div class="text-xs text-yellow-300">Autonomy</div>
                        <div class="text-2xl font-bold text-yellow-400" data-judge-autonomy>{{ submission.score_breakdown.judge_summary.autonomy or 0 }}/20</div>
                    </div>
                    <div class="bg-red-900/50 p-3 rounded border border-red-500/30">
                        <div class="text-xs text-red-300">Safety</div>
                        <div class="text-2xl font-bold text-red-400" data-judge-safety>{{ submission.score_breakdown.judge_summary.safety or 0 }}/10</div>
                    </div>
                </div>
            </div>
        </details>
        {% endif %}
    </div>
</details>

<!-- MAGI System CSS - Evangelion Faithful Design (Phase 3) -->
<style>
    /* ===== Container ===== */
    .magi-eva-container {
        font-family: 'Courier New', monospace;
        color: #eaeaea;
        padding: 20px;
        background: linear-gradient(180deg, #2a2a3e 0%, #1a1a2e 100%);
        position: relative;
    }

    /* ===== Phase Badge ===== */
    .magi-phase-badge-title {
        display: inline-block;
        font-size: 11px;
        padding: 4px 12px;
        background: linear-gradient(135deg, #be4bdb, #e94560);
        border-radius: 12px;
        font-weight: bold;
    }

    /* ===== 3-Column Grid Layout ===== */
    .magi-grid-layout {
        display: grid;
        grid-template-columns: 1fr 2fr 1fr;
        gap: 16px;
        min-height: 500px;
    }

    /* ===== 左列 ===== */
    .magi-left-column {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    /* 提訴 Label */
    .magi-label-teiso {
        font-size: 24px;
        font-weight: bold;
        padding: 4px 16px;
        border: 2px solid #00e5ff;
        color: #00e5ff;
        text-shadow: 0 0 10px #00e5ff;
        text-align: center;
    }

    /* System Info */
    .magi-system-info {
        font-size: 11px;
        color: #ffd43b;
        text-shadow: 0 0 5px rgba(255, 212, 59, 0.5);
        padding: 8px;
        background: rgba(0, 0, 0, 0.4);
    }
    .magi-info-line {
        margin-bottom: 2px;
    }

    /* ===== Chat Boxes ===== */
    .magi-chat-box {
        background: rgba(0, 0, 0, 0.6);
        border: 2px solid;
        border-radius: 4px;
        padding: 12px;
        display: flex;
        flex-direction: column;
        min-height: 100px;
        max-height: 180px;
    }

    /* 黄色枠 - 各エージェントのチャット */
    .magi-chat-yellow {
        border-color: #ffd43b;
    }

    /* 水色枠 - FINAL JUDGEチャット */
    .magi-chat-cyan {
        border-color: #00e5ff;
    }

    .magi-chat-header {
        font-size: 12px;
        font-weight: bold;
        color: #ffd43b;
        margin-bottom: 8px;
        padding-bottom: 4px;
        border-bottom: 1px solid rgba(255, 212, 59, 0.3);
    }

    .magi-chat-cyan .magi-chat-header {
        color: #00e5ff;
        border-bottom-color: rgba(0, 229, 255, 0.3);
    }

    .magi-chat-content {
        font-size: 11px;
        line-height: 1.5;
        color: #ddd;
        flex: 1;
        overflow-y: auto;
        max-height: 130px;
    }
    .magi-chat-message {
        white-space: pre-wrap;
        word-break: break-word;
        margin-bottom: 8px;
    }
    .magi-chat-placeholder {
        opacity: 0.5;
        font-style: italic;
        text-align: center;
        padding: 20px 0;
    }

    /* ===== 中央列 ===== */
    .magi-center-column {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        justify-content: center;
    }

    /* ===== MAGI Units - 審議中は全て水色、結果で色変化 ===== */
    .magi-unit {
        padding: 20px 16px;
        border: 3px solid #00e5ff;
        background: linear-gradient(180deg, #00acc1 0%, #006064 100%);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
        position: relative;
    }

    /* BALTHASAR - 縦長四角形の下側の角2つをカット（六角形） */
    .magi-balthasar {
        clip-path: polygon(0% 0%, 100% 0%, 100% 85%, 85% 100%, 15% 100%, 0% 85%);
        min-width: 180px;
        min-height: 220px;
        padding: 25px 20px;
    }

    /* CASPER - 横長四角形の右上の角を斜めにカット */
    .magi-casper {
        clip-path: polygon(0% 0%, 85% 0%, 100% 20%, 100% 100%, 0% 100%);
        min-width: 180px;
        min-height: 120px;
        padding: 15px 20px;
    }

    /* MELCHIOR - 横長四角形の左上の角を斜めにカット */
    .magi-melchior {
        clip-path: polygon(15% 0%, 100% 0%, 100% 100%, 0% 100%, 0% 20%);
        min-width: 180px;
        min-height: 120px;
        padding: 15px 20px;
    }

    /* ===== Verdict-based Unit Colors ===== */
    /* PASS判定 - 水色維持 + グロウ */
    .magi-unit.verdict-pass {
        background: linear-gradient(180deg, #00acc1 0%, #006064 100%);
        border-color: #00e5ff;
        box-shadow: 0 0 20px rgba(0, 229, 255, 0.5);
    }

    /* FAIL判定 - 赤に変化 */
    .magi-unit.verdict-fail {
        background: linear-gradient(180deg, #c62828 0%, #8e0000 100%);
        border-color: #ff5252;
        box-shadow: 0 0 20px rgba(255, 82, 82, 0.5);
    }

    /* REVIEW判定 - オレンジに変化 */
    .magi-unit.verdict-review {
        background: linear-gradient(180deg, #f9a825 0%, #c17900 100%);
        border-color: #ff9800;
        box-shadow: 0 0 20px rgba(255, 152, 0, 0.5);
    }

    .magi-unit-name {
        font-size: 14px;
        font-weight: bold;
        color: #fff;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
        letter-spacing: 1px;
    }

    .magi-unit-vote {
        font-size: 16px;
        font-weight: bold;
        padding: 4px 12px;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 4px;
        color: #fff;
    }
    /* Vote colors */
    .magi-vote-pass { color: #00e5ff; text-shadow: 0 0 10px #00e5ff; }
    .magi-vote-fail { color: #ff5252; text-shadow: 0 0 10px #ff5252; }
    .magi-vote-review { color: #ff9800; text-shadow: 0 0 10px #ff9800; }

    .magi-unit-model {
        font-size: 9px;
        opacity: 0.7;
        color: #ccc;
    }

    .magi-unit-status {
        font-size: 9px;
        padding: 2px 6px;
        background: rgba(0, 0, 0, 0.4);
        border-radius: 3px;
    }

    /* Score Bars */
    .magi-unit-scores {
        display: flex;
        flex-direction: column;
        gap: 2px;
        width: 100%;
        max-width: 100px;
        margin-top: 6px;
    }
    .magi-score-bar {
        display: flex;
        align-items: center;
        font-size: 8px;
        gap: 3px;
    }
    .magi-score-bar > span:first-child {
        width: 10px;
        font-weight: bold;
    }
    .magi-score-bar .bar {
        flex: 1;
        height: 5px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 2px;
        overflow: hidden;
    }
    .magi-score-bar .fill {
        height: 100%;
        border-radius: 2px;
        transition: width 0.5s ease;
    }
    .magi-score-bar .val {
        width: 16px;
        text-align: right;
        font-size: 7px;
        opacity: 0.8;
    }
    .magi-score-bar[data-axis="task"] .fill { background: #4dabf7; }
    .magi-score-bar[data-axis="tool"] .fill { background: #51cf66; }
    .magi-score-bar[data-axis="auto"] .fill { background: #ffd43b; }
    .magi-score-bar[data-axis="safe"] .fill { background: #ff6b6b; }

    /* ===== Connectors ===== */
    .magi-connector {
        width: 4px;
        height: 25px;
        background: linear-gradient(180deg, #ffa500, #ff6600);
        box-shadow: 0 0 8px rgba(255, 165, 0, 0.6);
    }

    /* ===== MAGI Logo ===== */
    .magi-logo {
        font-size: 22px;
        font-weight: bold;
        color: #ffd43b;
        text-shadow: 0 0 15px #ffd43b;
        padding: 6px 20px;
        border: 3px solid #ffd43b;
        background: rgba(0, 0, 0, 0.7);
        letter-spacing: 6px;
    }

    /* Split Connectors */
    .magi-connectors-split {
        display: flex;
        justify-content: center;
        gap: 80px;
    }
    .magi-connector-branch {
        width: 4px;
        height: 25px;
        background: linear-gradient(180deg, #ffa500, #ff6600);
        box-shadow: 0 0 8px rgba(255, 165, 0, 0.6);
    }

    /* ===== Bottom Units Row ===== */
    .magi-bottom-units {
        display: flex;
        justify-content: center;
        gap: 40px;
    }

    /* ===== 右列 ===== */
    .magi-right-column {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    /* 判定表示 (赤枠) */
    .magi-verdict-box {
        border: 3px solid #ff5252;
        background: rgba(255, 82, 82, 0.15);
        padding: 16px;
        text-align: center;
    }
    .magi-verdict-label {
        font-size: 14px;
        color: #ff5252;
        margin-bottom: 8px;
        text-shadow: 0 0 10px #ff5252;
    }
    .magi-verdict-text {
        font-size: 36px;
        font-weight: bold;
        padding: 8px 16px;
    }
    .magi-verdict-pass {
        color: #00e5ff;
        text-shadow: 0 0 20px #00e5ff;
    }
    .magi-verdict-fail {
        color: #ff5252;
        text-shadow: 0 0 20px #ff5252;
        animation: verdict-pulse-red 1.5s ease-in-out infinite;
    }
    .magi-verdict-review {
        color: #ff9800;
        text-shadow: 0 0 20px #ff9800;
    }
    .magi-verdict-pending {
        color: #718096;
    }

    @keyframes verdict-pulse-red {
        0%, 100% { box-shadow: 0 0 15px rgba(255, 82, 82, 0.5); }
        50% { box-shadow: 0 0 30px rgba(255, 82, 82, 0.8), 0 0 50px rgba(255, 82, 82, 0.4); }
    }

    /* ===== Animations ===== */
    .magi-unit.evaluating {
        animation: pulse-evaluating 1.5s ease-in-out infinite;
    }
    @keyframes pulse-evaluating {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
    }

    .magi-unit.vote-confirmed {
        animation: vote-glow 1s ease-in-out 3;
    }
    @keyframes vote-glow {
        0%, 100% { box-shadow: 0 0 10px var(--glow-color, #00e5ff); }
        50% { box-shadow: 0 0 30px var(--glow-color, #00e5ff), 0 0 50px var(--glow-color, #00e5ff); }
    }

    /* Typing cursor for chat */
    .magi-chat-message.typing::after {
        content: '|';
        color: #00ff88;
        animation: cursor-blink 0.7s infinite;
    }
    @keyframes cursor-blink {
        0%, 50% { opacity: 1; }
        51%, 100% { opacity: 0; }
    }

    /* Position changed message (during discussion) */
    .magi-chat-message.position-changed {
        background: rgba(77, 171, 247, 0.2);
        border-left: 2px solid #4dabf7;
        padding-left: 8px;
        margin-left: -8px;
    }

    /* ===== Details Section ===== */
    .magi-details-section {
        color: #eaeaea;
    }
    .magi-details-summary {
        cursor: pointer;
        padding: 10px 14px;
        background: rgba(255, 255, 255, 0.08);
        border-radius: 4px;
        font-size: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .magi-details-summary:hover {
        background: rgba(255, 255, 255, 0.12);
    }

    /* ===== Responsive ===== */
    @media (max-width: 900px) {
        .magi-grid-layout {
            grid-template-columns: 1fr;
            gap: 20px;
        }
        .magi-left-column, .magi-right-column {
            order: 2;
        }
        .magi-center-column {
            order: 1;
        }
        .magi-bottom-units {
            flex-direction: column;
            align-items: center;
            gap: 24px;
        }
        .magi-connectors-split {
            display: none;
        }
    }
</style>
