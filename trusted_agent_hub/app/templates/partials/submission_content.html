<div class="p-6 bg-gray-50 border-b border-gray-200">
    {% if submission.card_document.translations and submission.card_document.translations|length > 0 %}
    <h1 class="text-3xl font-bold text-gray-800">{{ submission.card_document.translations[0].displayName }}</h1>
    <p class="text-gray-600">{{ submission.card_document.translations[0].shortDescription }}</p>
    {% else %}
    <h1 class="text-3xl font-bold text-gray-800">{{ submission.card_document.name or submission.agent_id }}</h1>
    <p class="text-gray-600">{{ submission.card_document.description or "No description available" }}</p>
    {% endif %}
</div>

<div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-8">
    <div>
        <h2 class="text-xl font-semibold mb-4">Submission Details</h2>
        <div class="space-y-2">
            <p><span class="font-medium">ID:</span> {{ submission.id }}</p>
            <p><span class="font-medium">Organization:</span> {{ submission.organization_meta.name }}</p>
            <p><span class="font-medium">Status:</span> {{ submission.state }}</p>
            <p><span class="font-medium">Submitted At:</span> {{ submission.created_at }}</p>
        </div>
    </div>

    <div>
        <div class="bg-blue-50 p-4 rounded-lg">
            <div class="flex items-center justify-between mb-3">
                <div>
                    <span class="text-lg font-bold">Trust Score</span>
                </div>
                <span class="text-2xl font-bold text-blue-600"><span data-score="trust">{{ submission.trust_score }}</span> / 100</span>
            </div>
            <div class="space-y-2 text-sm text-gray-700">
                {% set sec = submission.score_breakdown.security_summary or {} %}
                <div>
                    <div class="text-xs text-gray-500">Security Gate</div>
                    <div class="font-medium leading-tight">
                        passed {{ sec.passed or 0 }}/{{ sec.total or 0 }}<br>
                        needs {{ sec.needsReview or 0 }}/{{ sec.total or 0 }}<br>
                        failed {{ sec.failed or 0 }}/{{ sec.total or 0 }}
                    </div>
                </div>
                {% set fn = submission.score_breakdown.functional_summary or {} %}
                <div>
                    <div class="text-xs text-gray-500">Agent Card Accuracy</div>
                    <div class="font-medium leading-tight">
                        passed {{ fn.passed_scenarios or 0 }}/{{ fn.total_scenarios or 0 }}<br>
                        needs {{ fn.needsReview or 0 }}/{{ fn.total_scenarios or 0 }}<br>
                        failed {{ fn.failed_scenarios or 0 }}/{{ fn.total_scenarios or 0 }}
                    </div>
                </div>
                {% if submission.score_breakdown.jury_judge and submission.score_breakdown.jury_judge.rationale %}
                <details class="text-xs bg-white border rounded p-2">
                    <summary class="font-semibold cursor-pointer text-blue-700">ğŸ“‹ Final Judge Rationale</summary>
                    <div class="mt-2 whitespace-pre-wrap text-gray-700">{{ submission.score_breakdown.jury_judge.rationale }}</div>
                </details>
                {% endif %}
            </div>
        </div>
    </div>


</div>

<div class="p-6 border-t border-gray-200">
    <h2 class="text-xl font-semibold mb-4">Review Progress</h2>
    <div id="review-progress" class="flex items-center justify-between mb-8">
        {% include 'partials/progress_bar.html' %}
    </div>
</div>

<!-- W&B Report Section -->
{% if submission.score_breakdown and submission.score_breakdown.wandb %}
<div class="p-6 border-t border-gray-200">
    <h2 class="text-xl font-semibold mb-4">Weights & Biases Reports</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- W&B Core Card -->
        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
            <div class="flex items-center gap-2 mb-3">
                <span class="text-2xl">ğŸ“Š</span>
                <div>
            <p class="text-sm font-medium text-gray-900">W&B Core Dashboard</p>
            <p class="text-xs text-gray-500">Experiment Tracking & Metrics</p>
                </div>
            </div>
            <div class="mb-3 text-xs text-gray-500">
                <p>Run ID: <span class="font-mono">{{ submission.score_breakdown.wandb.runId }}</span></p>
                <p>Project: {{ submission.score_breakdown.wandb.project }}</p>
                <p>Entity: {{ submission.score_breakdown.wandb.entity }}</p>
            </div>
            {% if submission.score_breakdown.wandb.url %}
            <a href="{{ submission.score_breakdown.wandb.url }}" target="_blank" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded inline-flex items-center justify-center transition duration-150 ease-in-out shadow-sm w-full">
                <span>Open Core Dashboard</span>
                <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                </svg>
            </a>
            {% else %}
            <span class="text-gray-400 text-sm italic bg-gray-100 px-3 py-1 rounded block text-center">URL Unavailable</span>
            {% endif %}
        </div>

        <!-- W&B Weave Card -->
        <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
            <div class="flex items-center gap-2 mb-3">
                <span class="text-2xl">ğŸ”®</span>
                <div>
            <p class="text-sm font-medium text-gray-900">W&B Weave Traces</p>
            <p class="text-xs text-gray-500">LLM Call Observability</p>
                </div>
            </div>
            <div class="mb-3 text-xs text-gray-500">
                <p>Project: {{ submission.score_breakdown.wandb.project }}</p>
                <p>Entity: {{ submission.score_breakdown.wandb.entity }}</p>
                <p class="mt-2 text-xs">Track LLM evaluations across Jury Judge, Security Gate, and Agent Card Accuracy stages</p>
            </div>
            <a href="https://wandb.ai/{{ submission.score_breakdown.wandb.entity }}/{{ submission.score_breakdown.wandb.project }}/weave" target="_blank" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded inline-flex items-center justify-center transition duration-150 ease-in-out shadow-sm w-full">
                <span>Open Weave Traces</span>
                <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                </svg>
            </a>
        </div>
    </div>
</div>
{% endif %}

<div class="p-6 border-t border-gray-200">
    <h2 class="text-xl font-semibold mb-4">Automated Review Steps</h2>
    {% if submission.score_breakdown %}
    <!-- PreCheck -->
    <details id="details-precheck" class="mb-6 bg-gray-50 p-4 rounded-lg">
        <summary class="text-lg font-semibold mb-2 flex items-center cursor-pointer">
            <span class="mr-2">ğŸ§¾</span> PreCheck
        </summary>
        {% if submission.score_breakdown.precheck_summary %}
        <div class="ml-7 space-y-2 mt-2">
            <p class="text-sm text-gray-700">
                <span class="font-semibold">Status:</span>
                <span class="{% if submission.score_breakdown.precheck_summary.passed %}text-green-600{% else %}text-red-600{% endif %}">
            {{ "Passed" if submission.score_breakdown.precheck_summary.passed else "Failed" }}
                </span>
            </p>
            <p class="text-sm text-gray-700">
                <span class="font-semibold">Agent ID:</span> {{ submission.score_breakdown.precheck_summary.agentId or "N/A" }}
            </p>
            {% if submission.score_breakdown.precheck_summary.warnings %}
            <p class="text-sm text-yellow-600">
                <span class="font-semibold">Warnings:</span> {{ submission.score_breakdown.precheck_summary.warnings|length }}
            </p>
            <ul class="ml-4 text-xs text-yellow-600">
                {% for warning in submission.score_breakdown.precheck_summary.warnings %}
                <li>â€¢ {{ warning }}</li>
                {% endfor %}
            </ul>
            {% endif %}
            {% if submission.score_breakdown.precheck_summary.errors %}
            <p class="text-sm text-red-600">
                <span class="font-semibold">Errors:</span>
            </p>
            <ul class="ml-4 text-xs text-red-600">
                {% for error in submission.score_breakdown.precheck_summary.errors %}
                <li>â€¢ {{ error }}</li>
                {% endfor %}
            </ul>
            {% endif %}
        </div>
        {% else %}
        <p class="ml-7 text-sm text-gray-500">PreCheck not yet executed</p>
        {% endif %}
    </details>
    <!-- Security Gate -->
    <details id="details-security" class="mb-6 bg-gray-50 p-4 rounded-lg">
        <summary class="text-lg font-semibold mb-2 flex items-center cursor-pointer">
            <span class="mr-2">ğŸ›¡ï¸</span> Security Gate
        </summary>
        {% if submission.score_breakdown.security_summary %}
        <div class="ml-7 space-y-4 mt-2">
            <!-- Basic Counts -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-white p-3 rounded border">
            <div class="text-xs text-gray-500">Total Tests</div>
            <div class="text-2xl font-bold">{{ submission.score_breakdown.security_summary.total or 0 }}</div>
                </div>
                <div class="bg-green-50 p-3 rounded border border-green-200">
            <div class="text-xs text-gray-500">Blocked (Safe)</div>
            <div class="text-2xl font-bold text-green-600">{{ submission.score_breakdown.security_summary.blocked or 0 }}</div>
                </div>
                <div class="bg-yellow-50 p-3 rounded border border-yellow-200">
            <div class="text-xs text-gray-500">Needs Review</div>
            <div class="text-2xl font-bold text-yellow-600">{{ submission.score_breakdown.security_summary.needsReview or 0 }}</div>
                </div>
                <div class="bg-red-50 p-3 rounded border border-red-200">
            <div class="text-xs text-gray-500">Errors</div>
            <div class="text-2xl font-bold text-red-600">{{ submission.score_breakdown.security_summary.errors or 0 }}</div>
                </div>
            </div>

            <!-- Categories Breakdown -->
            {% if submission.score_breakdown.security_summary.categories %}
            <div class="border-t pt-4">
                <h4 class="font-semibold mb-2">Attack Category Breakdown</h4>
                <div class="grid grid-cols-2 gap-2">
            {% for category, count in submission.score_breakdown.security_summary.categories.items() %}
            <div class="text-xs bg-white p-2 rounded border">
                <span class="font-medium">{{ category }}:</span> {{ count }}
            </div>
            {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Context Terms -->
            {% if submission.score_breakdown.security_summary.contextTerms %}
            <div class="border-t pt-4">
                <h4 class="font-semibold mb-2">Context Terms Used</h4>
                <div class="flex flex-wrap gap-2">
            {% for term in submission.score_breakdown.security_summary.contextTerms %}
            <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">{{ term }}</span>
            {% endfor %}
                </div>
            </div>
            {% endif %}
            <!-- Security Test Scenarios (Needs Review) -->
            {% if submission.score_breakdown.security_summary.scenarios %}
            <div class="border-t pt-4">
                <h4 class="font-semibold mb-2">âš ï¸ è¦ç¢ºèªã‚·ãƒŠãƒªã‚ªï¼ˆNeeds Review/Errorï¼‰</h4>
                {% set needs_review_scenarios = submission.score_breakdown.security_summary.scenarios | selectattr('verdict', 'defined') | selectattr('verdict', 'in', ['needs_review', 'error']) | list %}
                {% if needs_review_scenarios | length > 0 %}
                <div class="space-y-3">
            {% for scenario in needs_review_scenarios[:10] %}
            <div class="border border-yellow-300 rounded-lg p-3 bg-yellow-50">
                <div class="font-semibold text-sm mb-1">
                    {{ scenario.promptId or 'åŒ¿å' }}
                    <span class="ml-2 text-xs px-2 py-1 rounded
                        {% if scenario.verdict == 'needs_review' %}bg-yellow-100 text-yellow-800
                        {% elif scenario.verdict == 'error' %}bg-red-100 text-red-800
                        {% elif scenario.verdict == 'blocked' %}bg-green-100 text-green-800
                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                        {{ scenario.verdict }}
                    </span>
                </div>
                <div class="text-xs text-gray-600 mb-2">
                    Category: {{ scenario.category or 'N/A' }}
                    {% if scenario.perspective %}
                    | Perspective: {{ scenario.perspective }}
                    {% endif %}
                </div>
                <div class="text-xs mb-2">
                    <strong>Prompt:</strong>
                    <pre class="mt-1 whitespace-pre-wrap bg-white p-2 rounded">{{ scenario.prompt or scenario.basePrompt or 'N/A' }}</pre>
                </div>
                {% if scenario.response %}
                <div class="text-xs mb-2">
                    <strong>Response:</strong>
                    <pre class="mt-1 whitespace-pre-wrap bg-white p-2 rounded">{{ scenario.response }}</pre>
                </div>
                {% endif %}
                {% if scenario.reason %}
                <div class="text-xs text-gray-700">
                    <strong>Reason:</strong> {{ scenario.reason }}
                </div>
                {% endif %}
            </div>
            {% endfor %}
                </div>
                {% else %}
                <div class="text-sm text-gray-600">è¦ç¢ºèªé …ç›®ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>
                {% endif %}
            </div>
            <!-- All Security Scenarios Table -->
            <div class="border-t pt-4">
                <h4 class="font-semibold mb-2">ğŸ“ å…¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆä¸€è¦§</h4>
                <div class="mb-3">
            <label class="text-xs">
                ãƒ•ã‚£ãƒ«ã‚¿:
                <select id="securityVerdictFilter" class="ml-2 text-xs border rounded px-2 py-1" onchange="filterSecurityScenarios()">
                    <option value="all">å…¨ä»¶</option>
                    <option value="blocked">Blocked</option>
                    <option value="needs_review">Needs Review</option>
                    <option value="error">Error</option>
                    <option value="not_executed">Not Executed</option>
                </select>
            </label>
                </div>
                <div class="max-h-80 overflow-auto border rounded">
            <table class="w-full text-xs border-collapse">
                <thead class="bg-gray-100 sticky top-0">
                    <tr>
                        <th class="text-left p-2 border-b">Prompt ID</th>
                        <th class="text-left p-2 border-b">Prompt</th>
                        <th class="text-left p-2 border-b">Response</th>
                        <th class="text-left p-2 border-b">Verdict</th>
                    </tr>
                </thead>
                <tbody id="securityScenariosTableBody">
                    {% for scenario in submission.score_breakdown.security_summary.scenarios %}
                    {% if scenario.verdict %}
                    <tr class="border-b security-scenario-row" data-verdict="{{ scenario.verdict }}">
                        <td class="p-2">
                            {{ scenario.promptId or 'IDãªã—' }}
                        </td>
                        <td class="p-2">
                            <pre class="whitespace-pre-wrap text-xs">{{ (scenario.prompt or scenario.basePrompt or '(æœªè¨­å®š)')[:100] }}...</pre>
                        </td>
                        <td class="p-2">
                            <pre class="whitespace-pre-wrap text-xs">{{ (scenario.response or '(å¿œç­”ãªã—)')[:100] }}...</pre>
                        </td>
                        <td class="p-2">
                            <span class="px-2 py-1 rounded text-xs
                                {% if scenario.verdict == 'blocked' %}bg-green-100 text-green-800
                                {% elif scenario.verdict == 'needs_review' %}bg-yellow-100 text-yellow-800
                                {% elif scenario.verdict == 'error' %}bg-red-100 text-red-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ scenario.verdict }}
                            </span>
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
                </div>
            </div>
            {% endif %}
            <!-- Confirmation Points -->
            <div class="border-t pt-4">
                <h4 class="font-semibold mb-2">ğŸ“‹ ç¢ºèªãƒã‚¤ãƒ³ãƒˆ (ç™»éŒ²è€…å‘ã‘)</h4>
                <ul class="text-sm space-y-1 list-disc ml-5">
            <li>å¤šãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆæ”»æ’ƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè©•ä¾¡ã®çµæœã‚’ç¢ºèª (AISI Security/Toxic/Robustness/Fairness + AdvBench)</li>
            <li>å„ªå…ˆåº¦åˆ¥ãƒ»ã‚«ãƒ†ã‚´ãƒªåˆ¥ã®çµæœã‚’ç¢ºèªã—ã€æƒ³å®šã—ãŸæ”»æ’ƒè¦³ç‚¹ãŒç¶²ç¾…ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’æ¤œè¨¼</li>
            <li>ã€Œè¦ç¢ºèªã‚·ãƒŠãƒªã‚ªã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§needs_reviewé …ç›®ã®è©³ç´°ã‚’ç¢ºèªã—ã€é©åˆ‡ãªæ‹’å¦å¿œç­”ã‹ã‚’åˆ¤æ–­</li>
            <li>blocked/total ã®æ¯”ç‡ã‚’ç¢ºèªã—ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚³ã‚¢ã®å¦¥å½“æ€§ã‚’è©•ä¾¡</li>
                </ul>
            </div>

            <div class="border-t pt-4">
                <h4 class="font-semibold mb-2">ğŸ”§ ç¢ºèªãƒã‚¤ãƒ³ãƒˆ (ç®¡ç†è€…å‘ã‘)</h4>
                <ul class="text-sm space-y-1 list-disc ml-5">
            <li>security_report.jsonl ã‚’ç¢ºèªã—ã€å„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®è©³ç´°ãƒ­ã‚°ã¨LLMè©•ä¾¡çµæœã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼</li>
            <li>ä¿¡é ¼åº¦(confidence)ãŒ0.5æœªæº€ã®ã‚¨ãƒ³ãƒˆãƒªã‚’ç‰¹å®šã—ã€å†è©•ä¾¡ãŒå¿…è¦ã‹åˆ¤æ–­</li>
            <li>ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå¤±æ•—(endpointFailures)ã‚„ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ(timeoutFailures)ã®åŸå› ã‚’èª¿æŸ»</li>
            <li>ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆé©ç”¨ã«ã‚ˆã‚Šã€å°‚é–€åˆ†é‡å¤–ã®è¦æ±‚ãŒé©åˆ‡ã«è­˜åˆ¥ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª</li>
                </ul>
            </div>

            <!-- Artifacts -->
            {% if submission.score_breakdown.security_summary.artifacts %}
            <div class="border-t pt-4">
                <h4 class="font-semibold mb-2">ğŸ“ Artifacts</h4>
                <div class="space-y-2">
            {% if submission.score_breakdown.security_summary.artifacts.prompts %}
            <div class="text-sm">
                <span class="font-medium">Prompts:</span>
                <code class="text-xs bg-gray-100 px-2 py-1 rounded">{{ submission.score_breakdown.security_summary.artifacts.prompts }}</code>
            </div>
            {% endif %}
            {% if submission.score_breakdown.security_summary.artifacts.report %}
            <div class="text-sm">
                <span class="font-medium">Report:</span>
                <code class="text-xs bg-gray-100 px-2 py-1 rounded">{{ submission.score_breakdown.security_summary.artifacts.report }}</code>
            </div>
            {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
        {% else %}
        <p class="ml-7 text-sm text-gray-500">No security test results available</p>
        {% endif %}
    </details>
    <!-- Agent Card Accuracy -->
    <details id="details-functional" class="mb-6 bg-gray-50 p-4 rounded-lg">
        <summary class="text-lg font-semibold mb-2 flex items-center cursor-pointer">
            <span class="mr-2">ğŸ“‹</span> Agent Card Accuracy
        </summary>
        {% if submission.score_breakdown.functional_summary %}
        <div class="ml-7 space-y-4 mt-2">
            <!-- Basic Counts -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-white p-3 rounded border">
            <div class="text-xs text-gray-500">Total Scenarios</div>
            <div class="text-2xl font-bold">{{ submission.score_breakdown.functional_summary.total_scenarios or 0 }}</div>
                </div>
                <div class="bg-green-50 p-3 rounded border border-green-200">
            <div class="text-xs text-gray-500">Passed</div>
            <div class="text-2xl font-bold text-green-600">{{ submission.score_breakdown.functional_summary.passed_scenarios or 0 }}</div>
                </div>
                <div class="bg-yellow-50 p-3 rounded border border-yellow-200">
            <div class="text-xs text-gray-500">Needs Review</div>
            <div class="text-2xl font-bold text-yellow-600">{{ submission.score_breakdown.functional_summary.needsReview or 0 }}</div>
                </div>
                <div class="bg-red-50 p-3 rounded border border-red-200">
            <div class="text-xs text-gray-500">Errors</div>
            <div class="text-2xl font-bold text-red-600">{{ submission.score_breakdown.functional_summary.responsesWithError or 0 }}</div>
                </div>
            </div>


            <!-- Failed Scenarios (Top 3) with Multi-turn Dialogue -->
            {% if submission.score_breakdown.functional_summary.scenarios %}
            <div class="border-t pt-4">
                <h4 class="font-semibold mb-2">âŒ å¤±æ•—ã‚·ãƒŠãƒªã‚ªã®è©³ç´° (ä¸Šä½3ä»¶)</h4>
                {% set failed_scenarios = submission.score_breakdown.functional_summary.scenarios | selectattr('evaluation.verdict', 'defined') | selectattr('evaluation.verdict', 'ne', 'pass') | list %}
                {% if failed_scenarios | length > 0 %}
                <div class="space-y-3">
            {% for scenario in (failed_scenarios | sort(attribute='evaluation.distance', reverse=true))[:3] %}
            <div class="border border-gray-300 rounded-lg p-3 bg-white">
                <div class="font-semibold text-sm mb-1">
                    {{ scenario.scenarioId or 'åŒ¿å' }}
                    <span class="ml-2 text-xs px-2 py-1 rounded
                        {% if scenario.evaluation.verdict == 'fail' %}bg-red-100 text-red-800
                        {% elif scenario.evaluation.verdict == 'needs_review' %}bg-yellow-100 text-yellow-800
                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                        {{ scenario.evaluation.verdict }}
                    </span>
                </div>
                <div class="text-xs text-gray-600 mb-2">
                    Distance: {{ "%.4f"|format(scenario.evaluation.distance) if scenario.evaluation.distance is not none else '-' }}
                    {% if scenario.evaluation.get('topic_relevance') is not none %}
                    | Topic Relevance: {{ 'âœ“' if scenario.evaluation.topic_relevance else 'âœ—' }}
                    {% endif %}
                    {% if scenario.evaluation.get('dialogue_progress') is not none %}
                    | Dialogue Progress: {{ 'âœ“' if scenario.evaluation.dialogue_progress else 'âœ—' }}
                    {% endif %}
                    {% if scenario.evaluation.get('total_turns') %}
                    | Turns: {{ scenario.evaluation.total_turns }}
                    {% endif %}
                </div>

                <!-- Multi-turn Dialogue History -->
                {% if scenario.evaluation.dialogue_history %}
                <div class="text-xs mb-2 border-l-4 border-purple-400 pl-3">
                    <strong class="text-purple-700">ğŸ’¬ å¯¾è©±å±¥æ­´ ({{ scenario.evaluation.total_turns }} turns):</strong>
                    <div class="space-y-2 mt-2">
                        {% for turn in scenario.evaluation.dialogue_history %}
                        <div class="bg-white p-2 rounded border">
                            <div class="font-semibold text-purple-600 mb-1">Turn {{ turn.turn }}</div>
                            <div class="mb-1">
                                <span class="font-medium text-gray-700">User:</span>
                                <pre class="mt-0.5 whitespace-pre-wrap bg-blue-50 p-1.5 rounded text-xs">{{ turn.user }}</pre>
                            </div>
                            <div>
                                <span class="font-medium text-gray-700">Agent:</span>
                                <pre class="mt-0.5 whitespace-pre-wrap bg-green-50 p-1.5 rounded text-xs">{{ turn.agent }}</pre>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% else %}
                <!-- Single-turn display -->
                <div class="text-xs mb-2">
                    <strong>Prompt:</strong>
                    <pre class="mt-1 whitespace-pre-wrap bg-gray-50 p-2 rounded">{{ scenario.prompt or scenario.output or 'N/A' }}</pre>
                </div>
                <div class="text-xs mb-2">
                    <strong>Response:</strong>
                    <pre class="mt-1 whitespace-pre-wrap bg-gray-50 p-2 rounded">{{ scenario.response or 'N/A' }}</pre>
                </div>
                {% endif %}

                <div class="text-xs mb-2">
                    <strong>Expected:</strong>
                    <pre class="mt-1 whitespace-pre-wrap bg-gray-50 p-2 rounded">{{ scenario.expected or 'N/A' }}</pre>
                </div>

                <!-- Multi-turn Quality Metrics -->
                {% if scenario.evaluation.task_completion is not none %}
                <div class="text-xs mb-2 bg-purple-50 p-2 rounded border border-purple-200">
                    <strong class="text-purple-700">ãƒãƒ«ãƒã‚¿ãƒ¼ãƒ³å“è³ªæŒ‡æ¨™:</strong>
                    <div class="grid grid-cols-3 gap-2 mt-1">
                        <div>
                            <span class="text-gray-600">Task Completion:</span>
                            <span class="font-medium">{{ "%.2f"|format(scenario.evaluation.task_completion) }}</span>
                        </div>
                        {% if scenario.evaluation.dialogue_naturalness is not none %}
                        <div>
                            <span class="text-gray-600">Naturalness:</span>
                            <span class="font-medium">{{ "%.2f"|format(scenario.evaluation.dialogue_naturalness) }}</span>
                        </div>
                        {% endif %}
                        {% if scenario.evaluation.information_gathering is not none %}
                        <div>
                            <span class="text-gray-600">Info Gathering:</span>
                            <span class="font-medium">{{ "%.2f"|format(scenario.evaluation.information_gathering) }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                {% if scenario.evaluation.errors and scenario.evaluation.errors | length > 0 %}
                <div class="text-xs mb-2 text-red-600">
                    <strong>Errors:</strong> {{ scenario.evaluation.errors | join(', ') }}
                </div>
                {% endif %}
                {% if scenario.evaluation.rationale %}
                <div class="text-xs text-gray-700">
                    <strong>Rationale:</strong> {{ scenario.evaluation.rationale }}
                </div>
                {% endif %}
            </div>
            {% endfor %}
                </div>
                {% else %}
                <div class="text-sm text-gray-600">ä»Šã®ã¨ã“ã‚å¤±æ•—åˆ¤å®šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>
                {% endif %}
            </div>
            <!-- Prompts/Responses Table -->
            <div class="border-t pt-4">
                <h4 class="font-semibold mb-2">ğŸ“ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ/å¿œç­”ä¸€è¦§</h4>
                <div class="mb-3">
            <label class="text-xs">
                ãƒ•ã‚£ãƒ«ã‚¿:
                <select id="verdictFilter" class="ml-2 text-xs border rounded px-2 py-1" onchange="filterScenarios()">
                    <option value="all">å…¨ä»¶</option>
                    <option value="pass">Pass</option>
                    <option value="needs_review">Needs Review</option>
                    <option value="fail">Fail</option>
                </select>
            </label>
                </div>
                <div class="max-h-80 overflow-auto border rounded">
            <table class="w-full text-xs border-collapse">
                <thead class="bg-gray-100 sticky top-0">
                    <tr>
                        <th class="text-left p-2 border-b">ã‚·ãƒŠãƒªã‚ª</th>
                        <th class="text-left p-2 border-b">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</th>
                        <th class="text-left p-2 border-b">å¿œç­”</th>
                        <th class="text-left p-2 border-b">åˆ¤å®š</th>
                    </tr>
                </thead>
                <tbody id="scenariosTableBody">
                    {% for scenario in submission.score_breakdown.functional_summary.scenarios[:10] %}
                    {% if scenario.evaluation and scenario.evaluation.verdict %}
                    <tr class="border-b scenario-row" data-verdict="{{ scenario.evaluation.verdict }}">
                        <td class="p-2">
                            {{ scenario.scenarioId or 'IDãªã—' }}
                            {% if scenario.scenarioId and 'advbench' in scenario.scenarioId.lower() %}
                            <span class="text-xs text-gray-500 ml-1">[AdvBench]</span>
                            {% endif %}
                        </td>
                        <td class="p-2">
                            <pre class="whitespace-pre-wrap text-xs">{{ scenario.prompt or '(æœªè¨­å®š)' }}</pre>
                        </td>
                        <td class="p-2">
                            <pre class="whitespace-pre-wrap text-xs">{{ scenario.response or '(å¿œç­”ãªã—)' }}</pre>
                        </td>
                        <td class="p-2">
                            <span class="px-2 py-1 rounded text-xs
                                {% if scenario.evaluation.verdict == 'pass' %}bg-green-100 text-green-800
                                {% elif scenario.evaluation.verdict == 'needs_review' %}bg-yellow-100 text-yellow-800
                                {% elif scenario.evaluation.verdict == 'fail' %}bg-red-100 text-red-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ scenario.evaluation.verdict }}
                            </span>
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
                </div>
            </div>
            {% endif %}
            <!-- Confirmation Points -->
            <div class="border-t pt-4">
                <h4 class="font-semibold mb-2">ğŸ“‹ ç¢ºèªãƒã‚¤ãƒ³ãƒˆ (ç™»éŒ²è€…å‘ã‘)</h4>
                <ul class="text-sm space-y-1 list-disc ml-5">
            <li>Agent Card skillsã‹ã‚‰è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸã‚·ãƒŠãƒªã‚ªã®å†…å®¹ã‚’ç¢ºèªã—ã€æœŸå¾…ã™ã‚‹èƒ½åŠ›ãŒé©åˆ‡ã«ãƒ†ã‚¹ãƒˆã•ã‚Œã¦ã„ã‚‹ã‹ã‚’æ¤œè¨¼</li>
            <li>pass/needs_review/fail ã®åˆ¤å®šç†ç”±ã‚’ç¢ºèªã—ã€å¤±æ•—ã‚·ãƒŠãƒªã‚ªã®æ”¹å–„ãƒã‚¤ãƒ³ãƒˆã‚’ç‰¹å®š</li>
            <li>Topic Relevance(è©±é¡Œé–¢é€£æ€§)ã¨Dialogue Progress(å¯¾è©±é€²å±•)ã®è©•ä¾¡çµæœã‚’ç¢ºèª</li>
            <li>è·é›¢ãƒ¡ãƒˆãƒªã‚¯ã‚¹(averageDistance, similarity)ã‚’ç¢ºèªã—ã€å¿œç­”å“è³ªã®å®šé‡è©•ä¾¡ã‚’æŠŠæ¡</li>
                </ul>
            </div>

            <div class="border-t pt-4">
                <h4 class="font-semibold mb-2">ğŸ”§ ç¢ºèªãƒã‚¤ãƒ³ãƒˆ (ç®¡ç†è€…å‘ã‘)</h4>
                <ul class="text-sm space-y-1 list-disc ml-5">
            <li>functional_report.jsonl ã‚’ç¢ºèªã—ã€5æ®µéšLLMè©•ä¾¡(Intent/Topic/Dialogue/Error/Verdict)ã®è©³ç´°ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼</li>
            <li>è³ªå•å½¢å¼ã®å¿œç­”ãŒã€Œpassã€ã¨åˆ¤å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª(é©åˆ‡ãªå¯¾è©±ç¶™ç¶šã¨ã—ã¦è©•ä¾¡ã•ã‚Œã‚‹ã¹ã)</li>
            <li>RAGTruthãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã¨ã®ãƒãƒƒãƒãƒ³ã‚°çµæœã‚’ç¢ºèª(æœŸå¾…ç­”ã®è¨­å®šã«ä½¿ç”¨)</li>
            <li>ã‚¨ãƒ©ãƒ¼å¿œç­”(responsesWithError)ã®å†…å®¹ã‚’ç¢ºèªã—ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚„ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå•é¡Œã‚’èª¿æŸ»</li>
            <li>ãƒãƒ«ãƒã‚¿ãƒ¼ãƒ³å¯¾è©±è©•ä¾¡ãƒ¢ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ãªå ´åˆã€å¯¾è©±å±¥æ­´ã®è‡ªç„¶ã•ã¨é€²å±•ã‚’ç¢ºèª</li>
                </ul>
            </div>

            <!-- Artifacts -->
            {% if submission.score_breakdown.functional_summary.artifacts %}
            <div class="border-t pt-4">
                <h4 class="font-semibold mb-2">ğŸ“ Artifacts</h4>
                <div class="space-y-2">
            {% if submission.score_breakdown.functional_summary.artifacts.report %}
            <div class="text-sm">
                <span class="font-medium">Report (JSONL):</span>
                <code class="text-xs bg-gray-100 px-2 py-1 rounded">{{ submission.score_breakdown.functional_summary.artifacts.report }}</code>
            </div>
            {% endif %}
            {% if submission.score_breakdown.functional_summary.artifacts.prompts %}
            <div class="text-sm">
                <span class="font-medium">Prompts:</span>
                <code class="text-xs bg-gray-100 px-2 py-1 rounded">{{ submission.score_breakdown.functional_summary.artifacts.prompts }}</code>
            </div>
            {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
        {% else %}
        <p class="ml-7 text-sm text-gray-500">No functional test results available</p>
        {% endif %}
    </details>
    <!-- Jury Judge -->
    <details id="details-judge" class="mb-6 bg-gray-50 p-4 rounded-lg" open>
        <summary class="text-lg font-semibold mb-2 flex items-center cursor-pointer">
            <span class="mr-2">âš–ï¸</span> Jury Judge (Agents-as-a-Judge)
        </summary>

        <!-- Show real-time updates when judge panel is running -->
        {% if submission.state == 'judge_panel_running' %}
        <div class="ml-7 mb-4 p-3 bg-blue-50 border border-blue-200 rounded">
            <p class="text-sm text-blue-800">
                <span class="mr-2">â³</span>
                <strong>Jury Judgeè©•ä¾¡å®Ÿè¡Œä¸­...</strong> ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€²æ—ã‚’ä¸‹è¨˜ã§ç¢ºèªã§ãã¾ã™ã€‚
            </p>
        </div>
        {% endif %}

        <!-- Unified Collaborative Jury Judge Panel (Real-time + Historical) -->
        {% set show_realtime = submission.state == 'judge_panel_running' %}
        {% set show_historical = submission.score_breakdown.judge_summary and submission.score_breakdown.judge_summary.scenarios %}

        {% if show_realtime or show_historical %}
        <div class="ml-7 space-y-4 mt-2">
            {# Extract collective_judgment scenario which contains the collaborative discussion #}
            {% set collective = namespace(found=none) %}
            {% if show_historical %}
                {% for scenario in submission.score_breakdown.judge_summary.scenarios %}
                    {% if scenario.scenarioId == 'collective_judgment' %}
                        {% set collective.found = scenario %}
                    {% endif %}
                {% endfor %}
            {% endif %}

            <details id="jury-unified-container" class="bg-blue-50 border border-blue-200 rounded-lg p-4" open>
            <summary class="text-sm font-semibold mb-2 cursor-pointer flex items-center">
                <span class="mr-2">âš–ï¸</span>
                <span>å”èª¿è©•ä¾¡ (Collaborative Jury Judge)</span>
                {% if show_realtime %}
                <span id="ws-status" class="ml-auto text-xs px-2 py-1 rounded bg-green-100 text-green-800">å®Ÿè¡Œä¸­</span>
                {% endif %}
            </summary>

            <div class="ml-6 mt-3 space-y-3">
                <!-- Real-time Progress (shown during execution) -->
                {% if show_realtime %}
                <div id="jury-realtime-progress" class="mb-4 p-3 bg-white border border-purple-200 rounded">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium">ç¾åœ¨ã®ãƒ•ã‚§ãƒ¼ã‚º:</span>
                        <span id="current-phase-text" class="text-sm font-bold text-purple-700">-</span>
                    </div>
                </div>
                {% endif %}

                <!-- Phase Status Indicator (used by both real-time and historical) -->
                <div id="phase-indicator" class="mb-4">
                    <div class="flex gap-2">
                        {% if show_historical and collective.found %}
                            {% set phase1_complete = collective.found.phase1Evaluations and collective.found.phase1Evaluations | length > 0 %}
                            {% set phase2_complete = collective.found.discussionRounds and collective.found.discussionRounds | length > 0 %}
                            {% set phase3_complete = collective.found.finalJudgment %}
                        {% else %}
                            {% set phase1_complete = false %}
                            {% set phase2_complete = false %}
                            {% set phase3_complete = false %}
                        {% endif %}

                        <div id="phase-1" class="flex-1 p-2 rounded border text-center text-xs
                            {% if phase1_complete %}bg-green-100 border-green-300 text-green-800{% else %}bg-gray-100 text-gray-500{% endif %}">
                            Phase 1: ç‹¬ç«‹è©•ä¾¡
                            {% if phase1_complete %}âœ“{% endif %}
                        </div>
                        <div id="phase-2" class="flex-1 p-2 rounded border text-center text-xs
                            {% if phase2_complete %}bg-green-100 border-green-300 text-green-800{% else %}bg-gray-100 text-gray-500{% endif %}">
                            Phase 2: ãƒ‡ã‚£ã‚¹ã‚«ãƒƒã‚·ãƒ§ãƒ³
                            {% if phase2_complete %}âœ“{% elif collective.found and collective.found.earlyTermination %}â©{% endif %}
                        </div>
                        <div id="phase-3" class="flex-1 p-2 rounded border text-center text-xs
                            {% if phase3_complete %}bg-green-100 border-green-300 text-green-800{% else %}bg-gray-100 text-gray-500{% endif %}">
                            Phase 3: æœ€çµ‚åˆ¤å®š
                            {% if phase3_complete %}âœ“{% endif %}
                        </div>
                    </div>
                </div>

                <!-- Real-time WebSocket containers (only shown during execution) -->
                <div id="jury-realtime-container" class="hidden">
                    <div id="juror-evaluations-container" class="mb-4 hidden">
                        <h5 class="text-sm font-semibold mb-2">é™ªå¯©å“¡ã®è©•ä¾¡:</h5>
                        <div id="juror-evaluations" class="grid md:grid-cols-3 gap-2"></div>
                    </div>

                    <div id="consensus-container" class="mb-4 hidden">
                        <div class="bg-white p-3 rounded border">
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-semibold">åˆæ„çŠ¶æ³:</span>
                                <span id="consensus-status" class="text-sm font-bold"></span>
                            </div>
                            <div id="consensus-details" class="text-xs text-gray-600 mt-1"></div>
                        </div>
                    </div>

                    <div id="discussion-container" class="mb-4 hidden">
                        <h5 class="text-sm font-semibold mb-2">ãƒ‡ã‚£ã‚¹ã‚«ãƒƒã‚·ãƒ§ãƒ³:</h5>
                        <div id="current-turn-info" class="text-xs text-gray-600 mb-2"></div>
                        <div id="discussion-messages" class="space-y-2 max-h-96 overflow-y-auto"></div>
                    </div>

                    <div id="final-judgment-container" class="mb-4 hidden">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                            <h5 class="text-sm font-semibold mb-2">æœ€çµ‚åˆ¤å®šçµæœ:</h5>
                            <div class="grid md:grid-cols-2 gap-3">
                                <div>
                                    <div class="text-xs text-gray-600">åˆ¤å®š:</div>
                                    <div id="final-verdict" class="text-lg font-bold"></div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-600">ã‚¹ã‚³ã‚¢:</div>
                                    <div id="final-score" class="text-lg font-bold"></div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-600">ä¿¡é ¼åº¦:</div>
                                    <div id="final-confidence" class="text-sm font-medium"></div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-600">åˆ¤å®šæ–¹æ³•:</div>
                                    <div id="final-method" class="text-sm font-medium"></div>
                                </div>
                            </div>
                            <div id="final-rationale" class="mt-2 text-xs"></div>
                        </div>
                    </div>
                </div>

                <!-- Historical Data (only shown after completion) -->
                {% if show_historical and collective.found %}
                <!-- Phase 1 Evaluations -->
                {% if collective.found.phase1Evaluations %}
                <div class="mb-4">
                    <h5 class="text-sm font-semibold mb-2">Phase 1: ç‹¬ç«‹è©•ä¾¡</h5>
                    <div class="space-y-3">
                        {% for evaluation in collective.found.phase1Evaluations %}
                        <div class="p-3 bg-white rounded border">
                            <div class="flex items-center justify-between mb-2">
                                <div class="font-semibold text-sm">
                                    {% if evaluation.roleName %}
                                        {{ evaluation.roleName }}
                                    {% else %}
                                        {{ evaluation.jurorId }}
                                    {% endif %}
                                </div>
                                <span class="px-2 py-1 rounded text-xs
                                    {% if evaluation.verdict == 'safe_pass' %}bg-green-100 text-green-800
                                    {% elif evaluation.verdict == 'unsafe_fail' %}bg-red-100 text-red-800
                                    {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                    {{ evaluation.verdict }}
                                </span>
                            </div>

                            <!-- Score Summary -->
                            <div class="grid grid-cols-2 gap-2 mb-2 text-xs">
                                <div class="bg-gray-50 p-2 rounded">
                                    <div class="text-gray-600">ç·åˆã‚¹ã‚³ã‚¢</div>
                                    <div class="font-bold text-lg">{{ evaluation.overallScore | int }}/100</div>
                                </div>
                                <div class="bg-gray-50 p-2 rounded">
                                    <div class="text-gray-600">ä¿¡é ¼åº¦</div>
                                    <div class="font-bold text-lg">{{ (evaluation.confidence * 100) | int }}%</div>
                                </div>
                            </div>

                            <!-- Score Breakdown (4 Axes) -->
                            {% if evaluation.safetyScore is defined or evaluation.securityScore is defined or evaluation.complianceScore is defined or evaluation.autonomyScore is defined %}
                            <div class="mb-2">
                                <div class="text-xs text-gray-600 font-semibold mb-1">è©•ä¾¡è»¸åˆ¥ã‚¹ã‚³ã‚¢:</div>
                                <div class="grid grid-cols-2 gap-1 text-xs">
                                    {% if evaluation.safetyScore is defined %}
                                    <div class="flex justify-between px-2 py-1 bg-blue-50 rounded">
                                        <span>Safety (raw 0-10):</span>
                                        <span class="font-medium">{{ evaluation.safetyScore }}</span>
                                    </div>
                                    {% endif %}
                                    {% if evaluation.securityScore is defined %}
                                    <div class="flex justify-between px-2 py-1 bg-green-50 rounded">
                                        <span>Security (raw 0-40):</span>
                                        <span class="font-medium">{{ evaluation.securityScore }}</span>
                                    </div>
                                    {% endif %}
                                    {% if evaluation.complianceScore is defined %}
                                    <div class="flex justify-between px-2 py-1 bg-yellow-50 rounded">
                                        <span>Compliance (raw 0-30):</span>
                                        <span class="font-medium">{{ evaluation.complianceScore }}</span>
                                    </div>
                                    {% endif %}
                                    {% if evaluation.autonomyScore is defined %}
                                    <div class="flex justify-between px-2 py-1 bg-purple-50 rounded">
                                        <span>Autonomy (raw 0-20):</span>
                                        <span class="font-medium">{{ evaluation.autonomyScore }}</span>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}

                            <!-- Rationale (Collapsible) -->
                            {% if evaluation.rationale %}
                            <details class="mt-2">
                                <summary class="text-xs font-semibold text-blue-600 cursor-pointer hover:text-blue-800">
                                    è©•ä¾¡ç†ç”±ã‚’è¡¨ç¤º
                                </summary>
                                <div class="mt-2 p-2 bg-gray-50 rounded text-xs text-gray-700 whitespace-pre-wrap">{{ evaluation.rationale }}</div>
                            </details>
                            {% endif %}

                            <!-- Critical Issues -->
                            {% if evaluation.criticalIssues and evaluation.criticalIssues | length > 0 %}
                            <div class="mt-2 p-2 bg-red-50 border border-red-200 rounded">
                                <div class="text-xs font-semibold text-red-800 mb-1">âš ï¸ é‡å¤§ãªå•é¡Œ:</div>
                                <ul class="text-xs text-red-700 list-disc list-inside space-y-1">
                                    {% for issue in evaluation.criticalIssues %}
                                    <li>{{ issue }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Discussion (Continuous Area) -->
                {% if collective.found.discussionRounds %}
                <div class="bg-white border rounded-lg p-3">
                    <div class="text-xs font-semibold text-gray-700 mb-2">
                        Phase 2: ãƒ‡ã‚£ã‚¹ã‚«ãƒƒã‚·ãƒ§ãƒ³
                    </div>

                    <!-- All statements in one continuous area -->
                    <div class="space-y-2">
                        {% for round in collective.found.discussionRounds %}
                            {% for statement in round.statements %}
                            {% set juror_role = collective.found.phase1Evaluations | selectattr('jurorId', 'equalto', statement.jurorId) | first %}
                            <div class="p-2 bg-gray-50 rounded border border-gray-200">
                                <div class="text-xs text-gray-600 mb-1">
                                    <span class="font-semibold">
                                        {% if juror_role and juror_role.roleName %}
                                            {{ juror_role.roleName }}
                                        {% else %}
                                            {{ statement.jurorId }}
                                        {% endif %}
                                    </span>
                                    {% if statement.positionChanged %}
                                    <span class="ml-2 px-2 py-1 rounded text-xs bg-blue-100 text-blue-800">ç«‹å ´å¤‰æ›´</span>
                                    {% endif %}
                                </div>
                                <div class="text-sm">{{ statement.statement }}</div>
                            </div>
                            {% endfor %}
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Final Judgment -->
                {% if collective.found.finalJudgment %}
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <h5 class="text-sm font-semibold mb-3">Phase 3: æœ€çµ‚åˆ¤å®š</h5>

                    <!-- Summary Grid -->
                    <div class="grid md:grid-cols-2 gap-3 mb-3 text-xs">
                        <div class="bg-white p-2 rounded border">
                            <div class="text-gray-600">åˆ¤å®šçµæœ:</div>
                            <div class="text-lg font-bold
                                {% if collective.found.finalJudgment.finalVerdict == 'safe_pass' %}text-green-600
                                {% elif collective.found.finalJudgment.finalVerdict == 'unsafe_fail' %}text-red-600
                                {% else %}text-yellow-600{% endif %}">
                                {{ collective.found.finalJudgment.finalVerdict }}
                            </div>
                        </div>
                        <div class="bg-white p-2 rounded border">
                            <div class="text-gray-600">Trust Score:</div>
                            <div class="text-lg font-bold">{{ submission.trust_score }}/100</div>
                        </div>
                        <div class="bg-white p-2 rounded border">
                            <div class="text-gray-600">ä¿¡é ¼åº¦:</div>
                            <div class="font-medium">{{ (collective.found.finalJudgment.confidence * 100) | int }}%</div>
                        </div>
                        <div class="bg-white p-2 rounded border">
                            <div class="text-gray-600">åˆ¤å®šæ–¹æ³•:</div>
                            <div class="font-medium">
                                {% if collective.found.finalJudgment.method == 'final_judge' %}
                                    ğŸ¤– è­°è«–ã«ã‚ˆã‚‹æœ€çµ‚åˆ¤å®š
                                {% elif collective.found.finalJudgment.method == 'weighted_average' %}
                                    âš–ï¸ Weighted Average
                                {% else %}
                                    {{ collective.found.finalJudgment.method }}
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Final Judge Model (if applicable) -->
                    {% if collective.found.finalJudgment.method == 'final_judge' and collective.found.finalJudgment.finalJudgeModel %}
                    <div class="mb-3 p-2 bg-blue-50 border border-blue-200 rounded text-xs">
                        <span class="font-semibold text-blue-800">æœ€çµ‚åˆ¤å®šã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ:</span>
                        <span class="text-blue-700">{{ collective.found.finalJudgment.finalJudgeModel }}</span>
                    </div>
                    {% endif %}

                    <!-- Vote Distribution (for majority_vote) -->
                    {% if collective.found.finalJudgment.voteDistribution %}
                    <div class="mb-3 p-2 bg-white border rounded text-xs">
                        <div class="font-semibold mb-1">æŠ•ç¥¨åˆ†å¸ƒ:</div>
                        <div class="flex gap-2">
                            {% for verdict, count in collective.found.finalJudgment.voteDistribution.items() %}
                            <div class="px-2 py-1 rounded
                                {% if verdict == 'safe_pass' %}bg-green-100 text-green-800
                                {% elif verdict == 'unsafe_fail' %}bg-red-100 text-red-800
                                {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                {{ verdict }}: {{ count }}ç¥¨
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Final Judge Rationale (detailed reasoning from AI agent) -->
                    {% if collective.found.finalJudgment.finalJudgeRationale %}
                    <details class="mb-3" open>
                        <summary class="text-xs font-semibold text-green-700 cursor-pointer hover:text-green-900 mb-2">
                            ğŸ“‹ æœ€çµ‚åˆ¤å®šã®ç†ç”± (Final Judge)
                        </summary>
                        <div class="p-3 bg-white border rounded text-xs text-gray-700 whitespace-pre-wrap">{{ collective.found.finalJudgment.finalJudgeRationale }}</div>
                    </details>
                    {% elif collective.found.finalJudgment.rationale %}
                    <details class="mb-3" open>
                        <summary class="text-xs font-semibold text-green-700 cursor-pointer hover:text-green-900 mb-2">
                            ğŸ“‹ æœ€çµ‚åˆ¤å®šã®ç†ç”±
                        </summary>
                        <div class="p-3 bg-white border rounded text-xs text-gray-700 whitespace-pre-wrap">{{ collective.found.finalJudgment.rationale }}</div>
                    </details>
                    {% endif %}

                    <!-- Discussion Summary -->
                    {% if collective.found.finalJudgment.discussionSummary %}
                    <details class="mb-2">
                        <summary class="text-xs font-semibold text-purple-700 cursor-pointer hover:text-purple-900 mb-2">
                            ğŸ’¬ è­°è«–ã®è¦ç´„
                        </summary>
                        <div class="p-3 bg-white border rounded text-xs text-gray-700 whitespace-pre-wrap">{{ collective.found.finalJudgment.discussionSummary }}</div>
                    </details>
                    {% endif %}
                </div>
                {% endif %}
                {% endif %} {# End show_historical and collective.found #}
            </div>
                </details>
        </div>
        {% endif %} {# End show_realtime or show_historical #}

        {% if submission.score_breakdown.judge_summary %}
        <div class="ml-7 space-y-4 mt-2">
            <!-- AISI Inspect Criteria Scores -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-white p-3 rounded border">
            <div class="text-xs text-gray-500">Task Completion</div>
            <div class="text-2xl font-bold" data-judge-task>{{ submission.score_breakdown.judge_summary.taskCompletion or 0 }}/100</div>
                </div>
                <div class="bg-white p-3 rounded border">
            <div class="text-xs text-gray-500">Tool Usage</div>
            <div class="text-2xl font-bold" data-judge-tool>{{ submission.score_breakdown.judge_summary.tool or 0 }}/100</div>
                </div>
                <div class="bg-white p-3 rounded border">
            <div class="text-xs text-gray-500">Autonomy</div>
            <div class="text-2xl font-bold" data-judge-autonomy>{{ submission.score_breakdown.judge_summary.autonomy or 0 }}/100</div>
                </div>
                <div class="bg-white p-3 rounded border">
            <div class="text-xs text-gray-500">Safety & Security</div>
            <div class="text-2xl font-bold" data-judge-safety>{{ submission.score_breakdown.judge_summary.safety or 0 }}/100</div>
                </div>
            </div>

            <!-- LLM Configuration -->
            {% if submission.score_breakdown.judge_summary.llmJudge %}
            <div class="border-t pt-4">
                <h4 class="font-semibold mb-2">LLM Judge Configuration</h4>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-2 text-sm">
            {% if submission.score_breakdown.judge_summary.llmJudge.models %}
            <div class="bg-white p-2 rounded border col-span-2">
                <span class="text-xs text-gray-500">Models:</span>
                <span class="font-medium ml-2">{{ submission.score_breakdown.judge_summary.llmJudge.models | join(', ') }}</span>
            </div>
            {% elif submission.score_breakdown.judge_summary.llmJudge.model %}
            <div class="bg-white p-2 rounded border">
                <span class="text-xs text-gray-500">Model:</span>
                <span class="font-medium ml-2">{{ submission.score_breakdown.judge_summary.llmJudge.model }}</span>
            </div>
            {% endif %}
            <div class="bg-white p-2 rounded border">
                <span class="text-xs text-gray-500">Temperature (ãƒ©ãƒ³ãƒ€ãƒ åº¦):</span>
                <span class="font-medium ml-2">{{ submission.score_breakdown.judge_summary.llmJudge.temperature or 'default' }}</span>
            </div>
            {% if submission.score_breakdown.judge_summary.llmJudge.vetoThreshold is defined %}
            <div class="bg-white p-2 rounded border">
                <span class="text-xs text-gray-500">Veto Threshold:</span>
                <span class="font-medium ml-2">{{ (submission.score_breakdown.judge_summary.llmJudge.vetoThreshold * 100) | int }}%</span>
            </div>
            {% endif %}
            {% if submission.score_breakdown.judge_summary.llmJudge.dryRun is defined %}
            <div class="bg-white p-2 rounded border">
                <span class="text-xs text-gray-500">Dry Run:</span>
                <span class="font-medium ml-2">{{ submission.score_breakdown.judge_summary.llmJudge.dryRun }}</span>
            </div>
            {% endif %}
                </div>
            </div>
            {% endif %}
<!-- Confirmation Points -->
            <div class="border-t pt-4">
                <h4 class="font-semibold mb-2">ğŸ“‹ ç¢ºèªãƒã‚¤ãƒ³ãƒˆ (ç™»éŒ²è€…å‘ã‘)</h4>
                <ul class="text-sm space-y-1 list-disc ml-5">
            <li>3äººã®é™ªå¯©å“¡ã«ã‚ˆã‚‹å”èª¿è©•ä¾¡ãƒ—ãƒ­ã‚»ã‚¹(Phase 1: ç‹¬ç«‹è©•ä¾¡ â†’ Phase 2: ãƒ‡ã‚£ã‚¹ã‚«ãƒƒã‚·ãƒ§ãƒ³ â†’ Phase 3: æœ€çµ‚åˆ¤å®š)ã®çµæœã‚’ç¢ºèª</li>
            <li>å„é™ªå¯©å“¡ã®ç‹¬ç«‹è©•ä¾¡ã¨åˆæ„å½¢æˆãƒ—ãƒ­ã‚»ã‚¹ã‚’ç¢ºèªã—ã€åˆ¤å®šã®æ ¹æ‹ ã‚’ç†è§£</li>
            <li>AISI InspectåŸºæº–ã‚¹ã‚³ã‚¢(Task Completion/Tool Usage/Autonomy/Safety)ã®å†…è¨³ã‚’ç¢ºèªã—ã€å¼±ç‚¹ã‚’ç‰¹å®š</li>
            <li>æœ€çµ‚åˆ¤å®šã®ä¿¡é ¼åº¦(confidence)ã¨åˆ¤å®šæ–¹æ³•(consensus/majority/fallback)ã‚’ç¢ºèª</li>
                </ul>
            </div>

            <div class="border-t pt-4">
                <h4 class="font-semibold mb-2">ğŸ”§ ç¢ºèªãƒã‚¤ãƒ³ãƒˆ (ç®¡ç†è€…å‘ã‘)</h4>
                <ul class="text-sm space-y-1 list-disc ml-5">
            <li>judge_report.jsonl ã‚’ç¢ºèªã—ã€å„ãƒ•ã‚§ãƒ¼ã‚ºã®è©³ç´°è©•ä¾¡ã¨é™ªå¯©å“¡é–“ã®ãƒ‡ã‚£ã‚¹ã‚«ãƒƒã‚·ãƒ§ãƒ³å†…å®¹ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼</li>
            <li>å”èª¿è©•ä¾¡ãƒ—ãƒ­ã‚»ã‚¹(Phase 1-3)ãŒæ­£å¸¸ã«æ©Ÿèƒ½ã—ã€é©åˆ‡ãªåˆæ„å½¢æˆãŒè¡Œã‚ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª</li>
            <li>ãƒ‡ã‚£ã‚¹ã‚«ãƒƒã‚·ãƒ§ãƒ³ãƒ©ã‚¦ãƒ³ãƒ‰æ•°ã¨åœæ»æ¤œå‡ºã®å‹•ä½œã‚’ç¢ºèªã—ã€å¿…è¦ã«å¿œã˜ã¦è¨­å®šã‚’èª¿æ•´</li>
            <li>W&B Weave Tracesã§è©³ç´°ãªå®Ÿè¡Œãƒ­ã‚°ã¨LLMå‘¼ã³å‡ºã—ã®ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’ç¢ºèª</li>
                </ul>
            </div>

            <!-- Artifacts -->
            {% if submission.score_breakdown.judge_summary.artifacts %}
            <div class="border-t pt-4">
                <h4 class="font-semibold mb-2">ğŸ“ Artifacts</h4>
                <div class="space-y-2">
            {% if submission.score_breakdown.judge_summary.artifacts.report %}
            <div class="text-sm">
                <span class="font-medium">Report (JSONL):</span>
                <code class="text-xs bg-gray-100 px-2 py-1 rounded">{{ submission.score_breakdown.judge_summary.artifacts.report }}</code>
            </div>
            {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
        {% elif submission.state != 'judge_panel_running' %}
        <p class="ml-7 text-sm text-gray-500">No judge panel results available</p>
        {% endif %}
    </details>
    <!-- Publish -->
    <details id="details-publish" class="mb-6 bg-gray-50 p-4 rounded-lg">
        <summary class="text-lg font-semibold mb-2 flex items-center cursor-pointer">
            <span class="mr-2">ğŸš€</span> Publish
        </summary>
        {% if submission.score_breakdown.publish_summary %}
        <div class="ml-7 space-y-2 mt-2">
            <p class="text-sm text-gray-700">
                <span class="font-semibold">Status:</span>
                <span class="{% if submission.score_breakdown.publish_summary.status == 'published' %}text-green-600{% else %}text-yellow-600{% endif %}">
            {{ submission.score_breakdown.publish_summary.status }}
                </span>
            </p>
            {% if submission.score_breakdown.publish_summary.publishedAt %}
            <p class="text-sm text-gray-700">
                <span class="font-semibold">Published At:</span> {{ submission.score_breakdown.publish_summary.publishedAt }}
            </p>
            {% endif %}
            <p class="text-sm text-gray-700">
                <span class="font-semibold">Trust Score:</span> {{ submission.score_breakdown.publish_summary.trustScore }}/100
            </p>
        </div>
        {% else %}
        <p class="ml-7 text-sm text-gray-500">Not yet published</p>
        {% endif %}
    </details>
    {% else %}
    <p class="text-gray-500">Automated review is in progress or not yet started...</p>
    {% endif %}
</div>

<script src="/static/judge-stream.js"></script>
<script>
    // Initialize Jury Judge SSE client for real-time updates
    (function() {
        const submissionId = '{{ submission.id }}';
        const judgeState = '{{ submission.state }}';
        const urlPrefix = '{{ url_prefix }}' || '';

        console.log('[DEBUG] Initializing Jury Judge stream client');
        console.log('[DEBUG] Submission ID:', submissionId);
        console.log('[DEBUG] Judge State:', judgeState);

        const juryStream = new JuryJudgeStream(submissionId, { basePath: urlPrefix });
        console.log('[DEBUG] JuryJudgeStream instance created:', juryStream);

    // Initialize SSE (primary path for real-time streaming)
    let jurySSE = null;
    function connectSSE() {
        const base = window.location.origin.replace(/\/$/, '');
        const sseUrl = `${base}${urlPrefix}/sse/submissions/${submissionId}/judge`;
        console.log('[DEBUG] Attempting SSE connection:', sseUrl);
        try {
            jurySSE = new EventSource(sseUrl, { withCredentials: false });

            jurySSE.onopen = () => {
                console.log('[DEBUG] ğŸŸ¢ SSE connected');
                const wsStatus = document.getElementById('ws-status');
                if (wsStatus) {
                    wsStatus.textContent = 'æ¥ç¶šæ¸ˆã¿ (SSE)';
                    wsStatus.className = 'ml-auto text-xs px-2 py-1 rounded bg-green-100 text-green-800';
                }
            };

            jurySSE.onmessage = (event) => {
                if (!event?.data) return;
                // Reuse existing handler pipeline
                juryStream.handleMessage({ data: event.data });
            };

            jurySSE.addEventListener('ping', () => {
                // Heartbeat; no-op
            });

            jurySSE.onerror = (err) => {
                console.error('[DEBUG] SSE error:', err);
                const wsStatus = document.getElementById('ws-status');
                if (wsStatus) {
                    wsStatus.textContent = 'å†æ¥ç¶šä¸­ (SSE)';
                    wsStatus.className = 'ml-auto text-xs px-2 py-1 rounded bg-yellow-100 text-yellow-800';
                }
                // Browser auto-reconnects EventSource; no manual reconnect needed
            };
        } catch (e) {
            console.error('[DEBUG] SSE init failed:', e);
        }
    }

    // Connection status handlers
    juryStream.on('connected', () => {
        console.log('[DEBUG] ğŸŸ¢ WebSocket connected event fired');

        // Update unified panel status badge
        const wsStatus = document.getElementById('ws-status');
        console.log('[DEBUG] ws-status element:', wsStatus);
        if (wsStatus) {
            wsStatus.textContent = 'æ¥ç¶šæ¸ˆã¿';
            wsStatus.className = 'ml-auto text-xs px-2 py-1 rounded bg-green-100 text-green-800';
            console.log('[DEBUG] Updated ws-status to "æ¥ç¶šæ¸ˆã¿"');
        }
    });

    juryStream.on('disconnected', () => {
        const wsStatus = document.getElementById('ws-status');
        if (wsStatus) {
            wsStatus.textContent = 'åˆ‡æ–­';
            wsStatus.className = 'ml-auto text-xs px-2 py-1 rounded bg-red-100 text-red-800';
        }
    });

            // Phase change handler
    juryStream.on('phase_change', (data) => {
        console.log('[DEBUG] ğŸ”„ phase_change event handler called with data:', data);

        // Show parent realtime container
        const parentContainer = document.getElementById('jury-realtime-container');
        if (parentContainer) {
            parentContainer.classList.remove('hidden');
            console.log('[DEBUG] Removed hidden class from jury-realtime-container (phase_change)');
        }

        const phaseText = document.getElementById('current-phase-text');
        console.log('[DEBUG] current-phase-text element:', phaseText);
        if (phaseText) {
            // Multi-level fallback for robust phase display
            let displayText = data.description;
            if (!displayText && data.phaseNumber) {
                displayText = `Phase ${data.phaseNumber}`;
            }
            if (!displayText && data.phase) {
                const phaseMap = {
                    'initial_evaluation': 'Phase 1: ç‹¬ç«‹è©•ä¾¡',
                    'discussion': 'Phase 2: ãƒ‡ã‚£ã‚¹ã‚«ãƒƒã‚·ãƒ§ãƒ³',
                    'final_judgment': 'Phase 3: æœ€çµ‚åˆ¤å®š'
                };
                displayText = phaseMap[data.phase] || data.phase;
            }
            phaseText.textContent = displayText || 'ä¸æ˜ãªãƒ•ã‚§ãƒ¼ã‚º';
            console.log('[DEBUG] Updated phase text to:', phaseText.textContent);
                }

                // Update phase indicators
                for (let i = 1; i <= 3; i++) {
            const phaseEl = document.getElementById(`phase-${i}`);
            if (phaseEl) {
                if (i === data.phaseNumber) {
                    phaseEl.className = 'flex-1 p-2 rounded border text-center text-xs bg-purple-100 text-purple-800 font-bold';
                } else if (i < data.phaseNumber) {
                    phaseEl.className = 'flex-1 p-2 rounded border text-center text-xs bg-green-100 text-green-800';
                } else {
                    phaseEl.className = 'flex-1 p-2 rounded border text-center text-xs bg-gray-100 text-gray-500';
                }
            }
                }
            });

            // Juror evaluation handler (Phase 1)
    juryStream.on('juror_evaluation', (data) => {
        console.log('[DEBUG] ğŸ‘¨â€âš–ï¸ juror_evaluation event handler called with data:', data);

        // Show parent realtime container
        const parentContainer = document.getElementById('jury-realtime-container');
        if (parentContainer) {
            parentContainer.classList.remove('hidden');
            console.log('[DEBUG] Removed hidden class from jury-realtime-container (juror_evaluation)');
        }

        const container = document.getElementById('juror-evaluations-container');
        const evaluations = document.getElementById('juror-evaluations');
        console.log('[DEBUG] juror-evaluations-container:', container);
        console.log('[DEBUG] juror-evaluations:', evaluations);

        if (container && evaluations) {
            container.classList.remove('hidden');
            console.log('[DEBUG] Removed hidden class from juror-evaluations-container');

            let jurorEl = document.getElementById(`juror-${data.juror}`);
            if (!jurorEl) {
                jurorEl = document.createElement('div');
                jurorEl.id = `juror-${data.juror}`;
                jurorEl.className = 'p-2 bg-white rounded border text-xs';
                evaluations.appendChild(jurorEl);
            }

            const verdictColor = data.verdict === 'safe_pass' ? 'green' : (data.verdict === 'unsafe_fail' ? 'red' : 'yellow');
            jurorEl.innerHTML = `
                <div class="font-semibold mb-1">${data.juror}</div>
                <div class="mb-1">
                    <span class="px-2 py-1 rounded bg-${verdictColor}-100 text-${verdictColor}-800">${data.verdict}</span>
                </div>
                <div class="text-gray-600">Score: ${data.score.toFixed(1)}/100</div>
                <div class="text-gray-600">Confidence: ${(data.confidence * 100).toFixed(0)}%</div>
            `;
                }
            });

            // Consensus check handler
    juryStream.on('consensus_check', (data) => {
        // Show parent realtime container
        const parentContainer = document.getElementById('jury-realtime-container');
        if (parentContainer) {
            parentContainer.classList.remove('hidden');
            console.log('[DEBUG] Removed hidden class from jury-realtime-container (consensus_check)');
        }

        const container = document.getElementById('consensus-container');
        const status = document.getElementById('consensus-status');
        const details = document.getElementById('consensus-details');

        if (container && status && details) {
            container.classList.remove('hidden');

            const statusColor = data.consensusReached ? 'text-green-600' : 'text-yellow-600';
            status.textContent = data.consensusStatus;
            status.className = `text-sm font-bold ${statusColor}`;

            if (data.consensusReached) {
                details.textContent = `åˆæ„æˆç«‹: ${data.consensusVerdict} (Round ${data.round})`;
            } else {
                details.textContent = `åˆæ„ãªã— - ãƒ‡ã‚£ã‚¹ã‚«ãƒƒã‚·ãƒ§ãƒ³ç¶™ç¶š (Round ${data.round})`;
            }
                }
            });

            // Discussion start handler (Phase 2)
    juryStream.on('discussion_start', (data) => {
        console.log('[DEBUG] ğŸ’¬ discussion_start event handler called with data:', data);

        // Show parent realtime container
        const parentContainer = document.getElementById('jury-realtime-container');
        if (parentContainer) {
            parentContainer.classList.remove('hidden');
            console.log('[DEBUG] Removed hidden class from jury-realtime-container (discussion_start)');
        }

        const container = document.getElementById('discussion-container');
        const turnInfo = document.getElementById('current-turn-info');
        console.log('[DEBUG] discussion-container:', container);
        console.log('[DEBUG] current-turn-info:', turnInfo);

        if (container && turnInfo) {
            container.classList.remove('hidden');
            // Show simple discussion header without turn numbers
            turnInfo.textContent = 'è­°è«–ä¸­...';
            console.log('[DEBUG] Updated discussion info');
                }
            });

            // Juror statement handler
    juryStream.on('juror_statement', (data) => {
        console.log('[DEBUG] ğŸ—£ï¸ juror_statement event handler called with data:', data);

        // Show parent realtime container
        const parentContainer = document.getElementById('jury-realtime-container');
        if (parentContainer) {
            parentContainer.classList.remove('hidden');
            console.log('[DEBUG] Removed hidden class from jury-realtime-container (juror_statement)');
        }

        const messages = document.getElementById('discussion-messages');
        console.log('[DEBUG] discussion-messages element:', messages);
        if (messages) {
            const messageEl = document.createElement('div');
            messageEl.className = 'p-3 bg-white rounded border';
            console.log('[DEBUG] Created message element for juror:', data.juror);

            const positionBadge = data.positionChanged ?
                '<span class="ml-2 px-2 py-1 rounded text-xs bg-blue-100 text-blue-800">ç«‹å ´å¤‰æ›´</span>' : '';

            messageEl.innerHTML = `
                <div class="text-xs text-gray-600 mb-1">
                    <span class="font-semibold">${data.juror}</span>
                    ${positionBadge}
                </div>
                <div class="text-sm">${data.statement}</div>
                ${data.positionChanged ? `<div class="text-xs text-gray-600 mt-1">æ–°ã—ã„åˆ¤å®š: ${data.newVerdict} (${data.newScore.toFixed(1)})</div>` : ''}
            `;

            messages.appendChild(messageEl);
            messages.scrollTop = messages.scrollHeight;
                }
            });

            // Round complete handler
    juryStream.on('round_complete', (data) => {
        const roundInfo = document.getElementById('current-round-info');
        if (roundInfo) {
            const status = data.consensusReached ? 'âœ“ åˆæ„æˆç«‹' : (data.stagnant ? 'âš  åœæ»æ¤œå‡º' : 'é€²è¡Œä¸­');
            roundInfo.textContent += ` - ${status}`;
                }
            });

            // Final judgment handler (Phase 3)
    juryStream.on('final_judgment', (data) => {
        // Show parent realtime container
        const parentContainer = document.getElementById('jury-realtime-container');
        if (parentContainer) {
            parentContainer.classList.remove('hidden');
            console.log('[DEBUG] Removed hidden class from jury-realtime-container (final_judgment)');
        }

        const container = document.getElementById('final-judgment-container');
        const verdict = document.getElementById('final-verdict');
        const score = document.getElementById('final-score');
        const confidence = document.getElementById('final-confidence');
        const method = document.getElementById('final-method');
        const rationale = document.getElementById('final-rationale');

        if (container && verdict && score && confidence && method && rationale) {
            container.classList.remove('hidden');

            const verdictColor = data.finalVerdict === 'safe_pass' ? 'text-green-600' :
                                (data.finalVerdict === 'unsafe_fail' ? 'text-red-600' : 'text-yellow-600');
            verdict.textContent = data.finalVerdict;
            verdict.className = `text-lg font-bold ${verdictColor}`;

            score.textContent = `${Math.floor(data.finalScore)}/100`;
            confidence.textContent = `${(data.confidence * 100).toFixed(0)}%`;
            method.textContent = data.method;
            rationale.innerHTML = `<strong>ç†ç”±:</strong> ${data.rationale || 'N/A'}`;
                }
            });

            // Evaluation complete handler
    juryStream.on('evaluation_complete', (data) => {
        console.log('[DEBUG] ğŸ‰ Evaluation complete - keeping real-time display visible');
        console.log('[DEBUG] Evaluation complete data:', data);

                // Keep real-time display visible instead of reloading
                // User can manually reload or navigate to see static results

                // Update status to show evaluation is complete
        const wsStatus = document.getElementById('ws-status');
        if (wsStatus) {
            wsStatus.textContent = 'è©•ä¾¡å®Œäº†';
            wsStatus.className = 'ml-auto text-xs px-2 py-1 rounded bg-blue-100 text-blue-800';
                }

                // WebSocket-only architecture - no AJAX polling needed
                // All updates come via WebSocket in real-time
        console.log('[DEBUG] Evaluation complete - WebSocket-only mode (no polling)');
            });

            // Error handler
    juryStream.on('error', (data) => {
                console.error('Jury Judge WebSocket error:', data);
        const wsStatus = document.getElementById('ws-status');
        if (wsStatus) {
            wsStatus.textContent = 'ã‚¨ãƒ©ãƒ¼';
            wsStatus.className = 'ml-auto text-xs px-2 py-1 rounded bg-red-100 text-red-800';
                }
            });

    // Submission state change handler
    juryStream.on('submission_state_change', (data) => {
        console.log('[DEBUG] ğŸ”„ submission_state_change event:', data);

        // Update state display without full page reload
        const stateEl = document.querySelector('[data-state-display]');
        if (stateEl && data.newState) {
            stateEl.textContent = data.newState;
            console.log(`[DEBUG] âœ… Updated state display to: ${data.newState}`);
        }
    });

    // Score update handler - using data-score attributes
    juryStream.on('score_update', (data) => {
        console.log('[DEBUG] ğŸ“Š score_update event:', data);

        // Update scores in real-time using data-score attributes
        if (data.scores) {
            // Update trust score
            if (data.scores.trust_score !== undefined) {
                const trustScoreEl = document.querySelector('[data-score="trust"]');
                if (trustScoreEl) {
                    trustScoreEl.textContent = data.scores.trust_score;
                    console.log(`[DEBUG] âœ… Updated trust score to: ${data.scores.trust_score}`);
                }
            }

            // Update judge summary breakdown
            if (data.scores.judge_summary) {
                const js = data.scores.judge_summary;
                const taskEl = document.querySelector('[data-judge-task]');
                const toolEl = document.querySelector('[data-judge-tool]');
                const autoEl = document.querySelector('[data-judge-autonomy]');
                const safetyEl = document.querySelector('[data-judge-safety]');
                if (taskEl && js.taskCompletion !== undefined) taskEl.textContent = `${js.taskCompletion}/100`;
                if (toolEl && js.tool !== undefined) toolEl.textContent = `${js.tool}/100`;
                if (autoEl && js.autonomy !== undefined) autoEl.textContent = `${js.autonomy}/100`;
                if (safetyEl && js.safety !== undefined) safetyEl.textContent = `${js.safety}/100`;
            }

        }
    });

    // Stage update handler - for progress bar and content updates
    juryStream.on('stage_update', async (data) => {
        console.log('[DEBUG] ğŸ¯ stage_update event:', data);

        if (data.stage && data.status) {
            // Update progress bar icon immediately
            const stageEl = document.querySelector(`[data-stage="${data.stage}"]`);
            if (stageEl) {
                // Remove all status classes
                stageEl.classList.remove(
                    'bg-green-100', 'border-green-500',
                    'bg-red-100', 'border-red-500',
                    'bg-yellow-100', 'border-yellow-500', 'animate-pulse',
                    'bg-gray-100', 'border-gray-300'
                );

                // Add appropriate classes based on status
                if (data.status === 'completed') {
                    stageEl.classList.add('bg-green-100', 'border-green-500');
                    console.log(`[DEBUG] âœ… Stage ${data.stage} marked as completed`);
                } else if (data.status === 'failed') {
                    stageEl.classList.add('bg-red-100', 'border-red-500');
                    console.log(`[DEBUG] âŒ Stage ${data.stage} marked as failed`);
                } else if (data.status === 'running') {
                    stageEl.classList.add('bg-yellow-100', 'border-yellow-500', 'animate-pulse');
                    console.log(`[DEBUG] â³ Stage ${data.stage} marked as running`);
                } else {
                    stageEl.classList.add('bg-gray-100', 'border-gray-300');
                    console.log(`[DEBUG] â¸ï¸ Stage ${data.stage} marked as pending`);
                }
            }

            // Update status badge text immediately
            const statusBadge = document.querySelector(`[data-stage-status="${data.stage}"]`);
            if (statusBadge) {
                const statusText = {
                    'completed': 'âœ… å®Œäº†',
                    'failed': 'âŒ å¤±æ•—',
                    'running': 'â³ å®Ÿè¡Œä¸­'
                };
                statusBadge.textContent = statusText[data.status] || 'â¸ï¸ å¾…æ©Ÿä¸­';
                console.log(`[DEBUG] ğŸ“ Updated status badge for ${data.stage} to: ${statusBadge.textContent}`);
            }

            // Fetch and update full content to refresh "Automated Review Steps"
            try {
                console.log('[DEBUG] ğŸ”„ Fetching updated content...');
                const response = await fetch(window.location.href);
                if (!response.ok) {
                    console.error('[DEBUG] âŒ Failed to fetch updated content:', response.status);
                    return;
                }

                const htmlText = await response.text();
                const parser = new DOMParser();
                const newDoc = parser.parseFromString(htmlText, 'text/html');
                const newContent = newDoc.getElementById('main-content');
                const currentContent = document.getElementById('main-content');

                if (newContent && currentContent) {
                    // Capture current state
                    const scrollPos = window.scrollY;
                    const openDetails = Array.from(document.querySelectorAll('details[open]'))
                        .map(el => el.id)
                        .filter(id => id);

                    // Replace content
                    currentContent.innerHTML = newContent.innerHTML;

                    // Restore state
                    openDetails.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.open = true;
                    });

                    // Restore scroll position
                    window.scrollTo(0, scrollPos);

                    console.log('[DEBUG] âœ… Content updated successfully');
                }
            } catch (error) {
                console.error('[DEBUG] âŒ Error updating content:', error);
            }
        }
    });

    // Connect SSE client
    juryStream.connect();

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        juryStream.disconnect();
        if (jurySSE) {
            jurySSE.close();
        }
    });
})();
</script>
