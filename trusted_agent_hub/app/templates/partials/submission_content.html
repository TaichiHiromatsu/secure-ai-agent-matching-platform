<div class="p-6 bg-gray-50 border-b border-gray-200">
    {% if submission.card_document.translations and submission.card_document.translations|length > 0 %}
    <h1 class="text-3xl font-bold text-gray-800">{{ submission.card_document.translations[0].displayName }}</h1>
    <p class="text-gray-600">{{ submission.card_document.translations[0].shortDescription }}</p>
    {% else %}
    <h1 class="text-3xl font-bold text-gray-800">{{ submission.card_document.name or submission.agent_id }}</h1>
    <p class="text-gray-600">{{ submission.card_document.description or "No description available" }}</p>
    {% endif %}
</div>

<div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-8">
    <div>
        <h2 class="text-xl font-semibold mb-4">Submission Details</h2>
        <div class="space-y-2">
            <p><span class="font-medium">ID:</span> {{ submission.id }}</p>
            <p><span class="font-medium">Organization:</span> {{ submission.organization_meta.name }}</p>
            <p><span class="font-medium">Status:</span> {{ submission.state }}</p>
            <p><span class="font-medium">Submitted At:</span> {{ submission.created_at }}</p>
        </div>
    </div>

    <div>
        <div class="bg-blue-50 p-4 rounded-lg">
            <div class="flex items-center justify-between mb-3">
                <div>
                    <span class="text-lg font-bold">Trust Score</span>
                </div>
                <span class="text-2xl font-bold text-blue-600"><span data-score="trust">{{ submission.trust_score }}</span> / 100</span>
            </div>
            <div class="space-y-2 text-sm text-gray-700">
                {% set sec = submission.score_breakdown.security_summary or {} %}
                <div>
                    <div class="text-xs text-gray-500">Security Gate</div>
                    <div class="font-medium leading-tight">
                        passed {{ sec.passed or 0 }}/{{ sec.total or 0 }}<br>
                        needs {{ sec.needsReview or 0 }}/{{ sec.total or 0 }}<br>
                        failed {{ sec.failed or 0 }}/{{ sec.total or 0 }}
                    </div>
                </div>
                {% set fn = submission.score_breakdown.functional_summary or {} %}
                <div>
                    <div class="text-xs text-gray-500">Agent Card Accuracy</div>
                    <div class="font-medium leading-tight">
                        passed {{ fn.passed_scenarios or 0 }}/{{ fn.total_scenarios or 0 }}<br>
                        needs {{ fn.needsReview or 0 }}/{{ fn.total_scenarios or 0 }}<br>
                        failed {{ fn.failed_scenarios or 0 }}/{{ fn.total_scenarios or 0 }}
                    </div>
                </div>
                {% if submission.score_breakdown.jury_judge and submission.score_breakdown.jury_judge.rationale %}
                <details class="text-xs bg-white border rounded p-2">
                    <summary class="font-semibold cursor-pointer text-blue-700">üìã Final Judge Rationale</summary>
                    <div class="mt-2 whitespace-pre-wrap text-gray-700">{{ submission.score_breakdown.jury_judge.rationale }}</div>
                </details>
                {% endif %}
            </div>
        </div>
    </div>


</div>

<div class="p-6 border-t border-gray-200">
    <h2 class="text-xl font-semibold mb-4">Review Progress</h2>
    <div id="review-progress" class="flex items-center justify-between mb-8">
        {% include 'partials/progress_bar.html' %}
    </div>
</div>

<!-- W&B Report Section -->
{% if submission.score_breakdown and submission.score_breakdown.wandb %}
<div class="p-6 border-t border-gray-200">
    <h2 class="text-xl font-semibold mb-4">Weights & Biases Reports</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- W&B Core Card -->
        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
            <div class="flex items-center gap-2 mb-3">
                <span class="text-2xl">üìä</span>
                <div>
            <p class="text-sm font-medium text-gray-900">W&B Core Dashboard</p>
            <p class="text-xs text-gray-500">Experiment Tracking & Metrics</p>
                </div>
            </div>
            <div class="mb-3 text-xs text-gray-500">
                <p>Run ID: <span class="font-mono">{{ submission.score_breakdown.wandb.runId }}</span></p>
                <p>Project: {{ submission.score_breakdown.wandb.project }}</p>
                <p>Entity: {{ submission.score_breakdown.wandb.entity }}</p>
            </div>
            {% if submission.score_breakdown.wandb.url %}
            <a href="{{ submission.score_breakdown.wandb.url }}" target="_blank" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded inline-flex items-center justify-center transition duration-150 ease-in-out shadow-sm w-full">
                <span>Open Core Dashboard</span>
                <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                </svg>
            </a>
            {% else %}
            <span class="text-gray-400 text-sm italic bg-gray-100 px-3 py-1 rounded block text-center">URL Unavailable</span>
            {% endif %}
        </div>

        <!-- W&B Weave Card -->
        <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
            <div class="flex items-center gap-2 mb-3">
                <span class="text-2xl">üîÆ</span>
                <div>
            <p class="text-sm font-medium text-gray-900">W&B Weave Traces</p>
            <p class="text-xs text-gray-500">LLM Call Observability</p>
                </div>
            </div>
            <div class="mb-3 text-xs text-gray-500">
                <p>Project: {{ submission.score_breakdown.wandb.project }}</p>
                <p>Entity: {{ submission.score_breakdown.wandb.entity }}</p>
                <p class="mt-2 text-xs">Track LLM evaluations across Jury Judge, Security Gate, and Agent Card Accuracy stages</p>
            </div>
            <a href="https://wandb.ai/{{ submission.score_breakdown.wandb.entity }}/{{ submission.score_breakdown.wandb.project }}/weave" target="_blank" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded inline-flex items-center justify-center transition duration-150 ease-in-out shadow-sm w-full">
                <span>Open Weave Traces</span>
                <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                </svg>
            </a>
        </div>
    </div>
</div>
{% endif %}

<div class="p-6 border-t border-gray-200">
    <h2 class="text-xl font-semibold mb-4">Automated Review Steps</h2>
    {% if submission.score_breakdown %}
    <!-- PreCheck -->
    <details id="details-precheck" class="mb-6 bg-gray-50 p-4 rounded-lg">
        <summary class="text-lg font-semibold mb-2 flex items-center cursor-pointer">
            <span class="mr-2">üßæ</span> PreCheck
        </summary>
        {% if submission.score_breakdown.precheck_summary %}
        <div class="ml-7 space-y-2 mt-2">
            <p class="text-sm text-gray-700">
                <span class="font-semibold">Status:</span>
                <span class="{% if submission.score_breakdown.precheck_summary.passed %}text-green-600{% else %}text-red-600{% endif %}">
            {{ "Passed" if submission.score_breakdown.precheck_summary.passed else "Failed" }}
                </span>
            </p>
            {% if submission.score_breakdown.precheck_summary.warnings %}
            <p class="text-sm text-yellow-600">
                <span class="font-semibold">Warnings:</span> {{ submission.score_breakdown.precheck_summary.warnings|length }}
            </p>
            <ul class="ml-4 text-xs text-yellow-600">
                {% for warning in submission.score_breakdown.precheck_summary.warnings %}
                <li>‚Ä¢ {{ warning }}</li>
                {% endfor %}
            </ul>
            {% endif %}
            {% if submission.score_breakdown.precheck_summary.errors %}
            <p class="text-sm text-red-600">
                <span class="font-semibold">Errors:</span>
            </p>
            <ul class="ml-4 text-xs text-red-600">
                {% for error in submission.score_breakdown.precheck_summary.errors %}
                <li>‚Ä¢ {{ error }}</li>
                {% endfor %}
            </ul>
            {% endif %}
        </div>
        {% else %}
        <p class="ml-7 text-sm text-gray-500">PreCheck not yet executed</p>
        {% endif %}
    </details>
    <!-- Security Gate -->
    <details id="details-security" class="mb-6 bg-gray-50 p-4 rounded-lg">
        <summary class="text-lg font-semibold mb-2 flex items-center cursor-pointer">
            <span class="mr-2">üõ°Ô∏è</span> Security Gate
        </summary>
        {% if submission.score_breakdown.security_summary %}
        <div class="ml-7 space-y-4 mt-2">
            <!-- Basic Counts -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-white p-3 rounded border">
            <div class="text-xs text-gray-500">Total Tests</div>
            <div class="text-2xl font-bold">{{ submission.score_breakdown.security_summary.total or 0 }}</div>
                </div>
                <div class="bg-green-50 p-3 rounded border border-green-200">
            <div class="text-xs text-gray-500">Blocked (Safe)</div>
            <div class="text-2xl font-bold text-green-600">{{ submission.score_breakdown.security_summary.blocked or 0 }}</div>
                </div>
                <div class="bg-yellow-50 p-3 rounded border border-yellow-200">
            <div class="text-xs text-gray-500">Needs Review</div>
            <div class="text-2xl font-bold text-yellow-600">{{ submission.score_breakdown.security_summary.needsReview or 0 }}</div>
                </div>
                <div class="bg-red-50 p-3 rounded border border-red-200">
            <div class="text-xs text-gray-500">Errors</div>
            <div class="text-2xl font-bold text-red-600">{{ submission.score_breakdown.security_summary.errors or 0 }}</div>
                </div>
            </div>

            <!-- Security Test Scenarios (Needs Review) -->
            {% if submission.score_breakdown.security_summary.scenarios %}
            <div class="border-t pt-4">
                <h4 class="font-semibold mb-2">‚ö†Ô∏è Ë¶ÅÁ¢∫Ë™ç„Ç∑„Éä„É™„Ç™ÔºàNeeds Review/ErrorÔºâ</h4>
                {% set needs_review_scenarios = submission.score_breakdown.security_summary.scenarios | selectattr('verdict', 'defined') | selectattr('verdict', 'in', ['needs_review', 'error']) | list %}
                {% if needs_review_scenarios | length > 0 %}
                <div class="space-y-3">
            {% for scenario in needs_review_scenarios[:10] %}
            <div class="border border-yellow-300 rounded-lg p-3 bg-yellow-50">
                <div class="font-semibold text-sm mb-1">
                    {{ scenario.promptId or 'ÂåøÂêç' }}
                    <span class="ml-2 text-xs px-2 py-1 rounded
                        {% if scenario.verdict == 'needs_review' %}bg-yellow-100 text-yellow-800
                        {% elif scenario.verdict == 'error' %}bg-red-100 text-red-800
                        {% elif scenario.verdict == 'blocked' %}bg-green-100 text-green-800
                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                        {{ scenario.verdict }}
                    </span>
                </div>
                <div class="text-xs text-gray-600 mb-2">
                    Category: {{ scenario.category or 'N/A' }}
                    {% if scenario.perspective %}
                    | Perspective: {{ scenario.perspective }}
                    {% endif %}
                </div>
                <div class="text-xs mb-2">
                    <strong>Prompt:</strong>
                    <pre class="mt-1 whitespace-pre-wrap bg-white p-2 rounded">{{ scenario.prompt or scenario.basePrompt or 'N/A' }}</pre>
                </div>
                {% if scenario.response %}
                <div class="text-xs mb-2">
                    <strong>Response:</strong>
                    <pre class="mt-1 whitespace-pre-wrap bg-white p-2 rounded">{{ scenario.response }}</pre>
                </div>
                {% endif %}
                {% if scenario.reason %}
                <div class="text-xs text-gray-700">
                    <strong>Reason:</strong> {{ scenario.reason }}
                </div>
                {% endif %}
            </div>
            {% endfor %}
                </div>
                {% else %}
                <div class="text-sm text-gray-600">Ë¶ÅÁ¢∫Ë™çÈ†ÖÁõÆ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</div>
                {% endif %}
            </div>
            <!-- All Security Scenarios Table -->
            <div class="border-t pt-4">
                <h4 class="font-semibold mb-2">üìù ÂÖ®„Çª„Ç≠„É•„É™„ÉÜ„Ç£„ÉÜ„Çπ„Éà‰∏ÄË¶ß</h4>
                <div class="mb-3">
            <label class="text-xs">
                „Éï„Ç£„É´„Çø:
                <select id="securityVerdictFilter" class="ml-2 text-xs border rounded px-2 py-1" onchange="filterSecurityScenarios()">
                    <option value="all">ÂÖ®‰ª∂</option>
                    <option value="blocked">Blocked</option>
                    <option value="needs_review">Needs Review</option>
                    <option value="error">Error</option>
                    <option value="not_executed">Not Executed</option>
                </select>
            </label>
                </div>
                <div class="max-h-80 overflow-auto border rounded">
            <table class="w-full text-xs border-collapse">
                <thead class="bg-gray-100 sticky top-0">
                    <tr>
                        <th class="text-left p-2 border-b">Prompt ID</th>
                        <th class="text-left p-2 border-b">Prompt</th>
                        <th class="text-left p-2 border-b">Response</th>
                        <th class="text-left p-2 border-b">Verdict</th>
                    </tr>
                </thead>
                <tbody id="securityScenariosTableBody">
                    {% for scenario in submission.score_breakdown.security_summary.scenarios %}
                    {% if scenario.verdict %}
                    <tr class="border-b security-scenario-row" data-verdict="{{ scenario.verdict }}">
                        <td class="p-2">
                            {{ scenario.promptId or 'ID„Å™„Åó' }}
                        </td>
                        <td class="p-2">
                            <pre class="whitespace-pre-wrap text-xs">{{ (scenario.prompt or scenario.basePrompt or '(Êú™Ë®≠ÂÆö)')[:100] }}...</pre>
                        </td>
                        <td class="p-2">
                            <pre class="whitespace-pre-wrap text-xs">{{ (scenario.response or '(ÂøúÁ≠î„Å™„Åó)')[:100] }}...</pre>
                        </td>
                        <td class="p-2">
                            <span class="px-2 py-1 rounded text-xs
                                {% if scenario.verdict == 'blocked' %}bg-green-100 text-green-800
                                {% elif scenario.verdict == 'needs_review' %}bg-yellow-100 text-yellow-800
                                {% elif scenario.verdict == 'error' %}bg-red-100 text-red-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ scenario.verdict }}
                            </span>
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
                </div>
            </div>
            {% endif %}
            <!-- Confirmation Points -->
            <div class="border-t pt-4">
                <h4 class="font-semibold mb-2">üìã Á¢∫Ë™ç„Éù„Ç§„É≥„Éà</h4>
                <ul class="text-sm space-y-1 list-disc ml-5">
            <li><strong>Blocked (Safe)</strong>: „Çª„Ç≠„É•„É™„ÉÜ„Ç£ÊîªÊíÉ„Éó„É≠„É≥„Éó„Éà„ÇíÈÅ©Âàá„Å´„Éñ„É≠„ÉÉ„ÇØ„Åó„Åü„Ç±„Éº„Çπ</li>
            <li><strong>Needs Review</strong>: ‰∫∫ÊâãÁ¢∫Ë™ç„ÅåÂøÖË¶Å„Å™„Ç±„Éº„Çπ„ÄÇ„ÄåË¶ÅÁ¢∫Ë™ç„Ç∑„Éä„É™„Ç™„Äç„ÅßË©≥Á¥∞„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ</li>
            <li>ÂÖ®‰Ωì„ÅÆ„Éñ„É≠„ÉÉ„ÇØÁéá (Blocked/Total) „ÅåÈ´ò„ÅÑ„Åª„Å©„Çª„Ç≠„É•„É™„ÉÜ„Ç£ÂØæÁ≠ñ„ÅåÊúâÂäπ„Åß„Åô</li>
                </ul>
            </div>

            <!-- Artifacts -->
            {% if submission.score_breakdown.security_summary.artifacts %}
            <div class="border-t pt-4">
                <h4 class="font-semibold mb-2">üìÅ Artifacts</h4>
                <div class="space-y-2">
            {% if submission.score_breakdown.security_summary.artifacts.prompts %}
            <div class="text-sm">
                <span class="font-medium">Prompts:</span>
                <code class="text-xs bg-gray-100 px-2 py-1 rounded">{{ submission.score_breakdown.security_summary.artifacts.prompts }}</code>
            </div>
            {% endif %}
            {% if submission.score_breakdown.security_summary.artifacts.report %}
            <div class="text-sm">
                <span class="font-medium">Report:</span>
                <code class="text-xs bg-gray-100 px-2 py-1 rounded">{{ submission.score_breakdown.security_summary.artifacts.report }}</code>
            </div>
            {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
        {% else %}
        <p class="ml-7 text-sm text-gray-500">No security test results available</p>
        {% endif %}
    </details>
    <!-- Agent Card Accuracy -->
    <details id="details-functional" class="mb-6 bg-gray-50 p-4 rounded-lg">
        <summary class="text-lg font-semibold mb-2 flex items-center cursor-pointer">
            <span class="mr-2">üìã</span> Agent Card Accuracy
        </summary>
        {% if submission.score_breakdown.functional_summary %}
        <div class="ml-7 space-y-4 mt-2">
            <!-- Basic Counts -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-white p-3 rounded border">
            <div class="text-xs text-gray-500">Total Scenarios</div>
            <div class="text-2xl font-bold">{{ submission.score_breakdown.functional_summary.total_scenarios or 0 }}</div>
                </div>
                <div class="bg-green-50 p-3 rounded border border-green-200">
            <div class="text-xs text-gray-500">Passed</div>
            <div class="text-2xl font-bold text-green-600">{{ submission.score_breakdown.functional_summary.passed_scenarios or 0 }}</div>
                </div>
                <div class="bg-yellow-50 p-3 rounded border border-yellow-200">
            <div class="text-xs text-gray-500">Needs Review</div>
            <div class="text-2xl font-bold text-yellow-600">{{ submission.score_breakdown.functional_summary.needsReview or 0 }}</div>
                </div>
                <div class="bg-red-50 p-3 rounded border border-red-200">
            <div class="text-xs text-gray-500">Errors</div>
            <div class="text-2xl font-bold text-red-600">{{ submission.score_breakdown.functional_summary.responsesWithError or 0 }}</div>
                </div>
            </div>


            <!-- Failed Scenarios with Multi-turn Dialogue -->
            {% if submission.score_breakdown.functional_summary.scenarios %}
            <div class="border-t pt-4">
                <h4 class="font-semibold mb-2">‚ùå Â§±Êïó„Ç∑„Éä„É™„Ç™„ÅÆË©≥Á¥∞</h4>
                {% set failed_scenarios = submission.score_breakdown.functional_summary.scenarios | selectattr('evaluation.verdict', 'defined') | selectattr('evaluation.verdict', 'ne', 'pass') | list %}
                {% if failed_scenarios | length > 0 %}
                <div class="text-xs text-gray-500 mb-2">{{ failed_scenarios | length }}‰ª∂„ÅÆÂ§±Êïó„Ç∑„Éä„É™„Ç™</div>
                <div class="space-y-3" id="failed-scenarios-container">
            {% for scenario in (failed_scenarios | sort(attribute='evaluation.distance', reverse=true)) %}
            <div class="border border-gray-300 rounded-lg p-3 bg-white failed-scenario-item" {% if loop.index > 10 %}style="display:none"{% endif %} data-index="{{ loop.index }}">
                <div class="font-semibold text-sm mb-1">
                    {{ scenario.scenarioId or 'ÂåøÂêç' }}
                    <span class="ml-2 text-xs px-2 py-1 rounded
                        {% if scenario.evaluation.verdict == 'fail' %}bg-red-100 text-red-800
                        {% elif scenario.evaluation.verdict == 'needs_review' %}bg-yellow-100 text-yellow-800
                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                        {{ scenario.evaluation.verdict }}
                    </span>
                </div>
                <div class="text-xs text-gray-600 mb-2">
                    Distance: {{ "%.4f"|format(scenario.evaluation.distance) if scenario.evaluation.distance is not none else '-' }}
                    {% if scenario.evaluation.get('topic_relevance') is not none %}
                    | Topic Relevance: {{ '‚úì' if scenario.evaluation.topic_relevance else '‚úó' }}
                    {% endif %}
                    {% if scenario.evaluation.get('dialogue_progress') is not none %}
                    | Dialogue Progress: {{ '‚úì' if scenario.evaluation.dialogue_progress else '‚úó' }}
                    {% endif %}
                    {% if scenario.evaluation.get('total_turns') %}
                    | Turns: {{ scenario.evaluation.total_turns }}
                    {% endif %}
                </div>

                <!-- Multi-turn Dialogue History -->
                {% if scenario.evaluation.dialogue_history %}
                <div class="text-xs mb-2 border-l-4 border-purple-400 pl-3">
                    <strong class="text-purple-700">üí¨ ÂØæË©±Â±•Ê≠¥ ({{ scenario.evaluation.total_turns }} turns):</strong>
                    <div class="space-y-2 mt-2">
                        {% for turn in scenario.evaluation.dialogue_history %}
                        <div class="bg-white p-2 rounded border">
                            <div class="font-semibold text-purple-600 mb-1">Turn {{ turn.turn }}</div>
                            <div class="mb-1">
                                <span class="font-medium text-gray-700">User:</span>
                                <pre class="mt-0.5 whitespace-pre-wrap bg-blue-50 p-1.5 rounded text-xs">{{ turn.user }}</pre>
                            </div>
                            <div>
                                <span class="font-medium text-gray-700">Agent:</span>
                                <pre class="mt-0.5 whitespace-pre-wrap bg-green-50 p-1.5 rounded text-xs">{{ turn.agent }}</pre>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% else %}
                <!-- Single-turn display -->
                <div class="text-xs mb-2">
                    <strong>Prompt:</strong>
                    <pre class="mt-1 whitespace-pre-wrap bg-gray-50 p-2 rounded">{{ scenario.prompt or scenario.output or 'N/A' }}</pre>
                </div>
                <div class="text-xs mb-2">
                    <strong>Response:</strong>
                    <pre class="mt-1 whitespace-pre-wrap bg-gray-50 p-2 rounded">{{ scenario.response or 'N/A' }}</pre>
                </div>
                {% endif %}

                <div class="text-xs mb-2">
                    <strong>Expected:</strong>
                    <pre class="mt-1 whitespace-pre-wrap bg-gray-50 p-2 rounded">{{ scenario.expected or 'N/A' }}</pre>
                </div>

                <!-- Multi-turn Quality Metrics -->
                {% if scenario.evaluation.task_completion is not none %}
                <div class="text-xs mb-2 bg-purple-50 p-2 rounded border border-purple-200">
                    <strong class="text-purple-700">„Éû„É´„ÉÅ„Çø„Éº„É≥ÂìÅË≥™ÊåáÊ®ô:</strong>
                    <div class="grid grid-cols-3 gap-2 mt-1">
                        <div>
                            <span class="text-gray-600">Task Completion:</span>
                            <span class="font-medium">{{ "%.2f"|format(scenario.evaluation.task_completion) }}</span>
                        </div>
                        {% if scenario.evaluation.dialogue_naturalness is not none %}
                        <div>
                            <span class="text-gray-600">Naturalness:</span>
                            <span class="font-medium">{{ "%.2f"|format(scenario.evaluation.dialogue_naturalness) }}</span>
                        </div>
                        {% endif %}
                        {% if scenario.evaluation.information_gathering is not none %}
                        <div>
                            <span class="text-gray-600">Info Gathering:</span>
                            <span class="font-medium">{{ "%.2f"|format(scenario.evaluation.information_gathering) }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                {% if scenario.evaluation.errors and scenario.evaluation.errors | length > 0 %}
                <div class="text-xs mb-2 text-red-600">
                    <strong>Errors:</strong> {{ scenario.evaluation.errors | join(', ') }}
                </div>
                {% endif %}
                {% if scenario.evaluation.rationale %}
                <div class="text-xs text-gray-700">
                    <strong>Rationale:</strong> {{ scenario.evaluation.rationale }}
                </div>
                {% endif %}
            </div>
            {% endfor %}
                </div>
                {% if failed_scenarios | length > 10 %}
                <button id="loadMoreFailedBtn" onclick="loadMoreFailedScenarios()" class="mt-3 px-4 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded border">
                    „ÇÇ„Å£„Å®Ë¶ã„Çã (<span id="failedRemainingCount">{{ failed_scenarios | length - 10 }}</span>‰ª∂)
                </button>
                {% endif %}
                {% else %}
                <div class="text-sm text-gray-600">‰ªä„ÅÆ„Å®„Åì„ÇçÂ§±ÊïóÂà§ÂÆö„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</div>
                {% endif %}
            </div>
            <!-- Prompts/Responses Table -->
            <div class="border-t pt-4">
                <h4 class="font-semibold mb-2">üìù „Éó„É≠„É≥„Éó„Éà/ÂøúÁ≠î‰∏ÄË¶ß</h4>
                <div class="mb-3">
            <label class="text-xs">
                „Éï„Ç£„É´„Çø:
                <select id="verdictFilter" class="ml-2 text-xs border rounded px-2 py-1" onchange="filterScenarios()">
                    <option value="all">ÂÖ®‰ª∂</option>
                    <option value="pass">Pass</option>
                    <option value="needs_review">Needs Review</option>
                    <option value="fail">Fail</option>
                </select>
            </label>
                </div>
                <div class="max-h-80 overflow-auto border rounded">
            <table class="w-full text-xs border-collapse">
                <thead class="bg-gray-100 sticky top-0">
                    <tr>
                        <th class="text-left p-2 border-b">„Ç∑„Éä„É™„Ç™</th>
                        <th class="text-left p-2 border-b">„Éó„É≠„É≥„Éó„Éà</th>
                        <th class="text-left p-2 border-b">ÂøúÁ≠î</th>
                        <th class="text-left p-2 border-b">Âà§ÂÆö</th>
                    </tr>
                </thead>
                <tbody id="scenariosTableBody">
                    {% for scenario in submission.score_breakdown.functional_summary.scenarios %}
                    {% if scenario.evaluation and scenario.evaluation.verdict %}
                    <tr class="border-b scenario-row" data-verdict="{{ scenario.evaluation.verdict }}" data-index="{{ loop.index }}" {% if loop.index > 10 %}style="display:none"{% endif %}>
                        <td class="p-2">
                            {{ scenario.scenarioId or 'ID„Å™„Åó' }}
                            {% if scenario.scenarioId and 'advbench' in scenario.scenarioId.lower() %}
                            <span class="text-xs text-gray-500 ml-1">[AdvBench]</span>
                            {% endif %}
                        </td>
                        <td class="p-2">
                            <pre class="whitespace-pre-wrap text-xs">{{ scenario.prompt or '(Êú™Ë®≠ÂÆö)' }}</pre>
                        </td>
                        <td class="p-2">
                            <pre class="whitespace-pre-wrap text-xs">{{ scenario.response or '(ÂøúÁ≠î„Å™„Åó)' }}</pre>
                        </td>
                        <td class="p-2">
                            <span class="px-2 py-1 rounded text-xs
                                {% if scenario.evaluation.verdict == 'pass' %}bg-green-100 text-green-800
                                {% elif scenario.evaluation.verdict == 'needs_review' %}bg-yellow-100 text-yellow-800
                                {% elif scenario.evaluation.verdict == 'fail' %}bg-red-100 text-red-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ scenario.evaluation.verdict }}
                            </span>
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
                </div>
                {% if submission.score_breakdown.functional_summary.scenarios | length > 10 %}
                <button id="loadMoreScenariosBtn" onclick="loadMoreScenarios()" class="mt-3 px-4 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded border">
                    „ÇÇ„Å£„Å®Ë¶ã„Çã (<span id="scenariosRemainingCount">{{ submission.score_breakdown.functional_summary.scenarios | length - 10 }}</span>‰ª∂)
                </button>
                {% endif %}
            </div>
            {% endif %}
            <!-- Confirmation Points -->
            <div class="border-t pt-4">
                <h4 class="font-semibold mb-2">üìã Á¢∫Ë™ç„Éù„Ç§„É≥„Éà</h4>
                <ul class="text-sm space-y-1 list-disc ml-5">
                    <li>Pass: „Ç∑„Éä„É™„Ç™„ÅÆÊúüÂæÖ„Å´Ê≤ø„Å£„ÅüÂøúÁ≠î„Åå„Åß„Åç„Åü„Ç±„Éº„Çπ</li>
                    <li>Needs Review: ‰∫∫ÊâãÁ¢∫Ë™ç„ÅåÂøÖË¶Å„Å™„Ç±„Éº„Çπ„ÄÇÂøúÁ≠îÂÜÖÂÆπ„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ</li>
                    <li>Fail: ÊúüÂæÖ„Å®Áï∞„Å™„ÇãÂøúÁ≠î„Çí„Åó„Åü„Ç±„Éº„Çπ„ÄÇÊîπÂñÑ„ÅåÂøÖË¶Å„Åß„Åô</li>
                    <li>ÂÖ®‰Ωì„ÅÆPassÁéá (Pass/Total) „ÅåÈ´ò„ÅÑ„Åª„Å©Agent Card„ÅÆÁ≤æÂ∫¶„ÅåÈ´ò„ÅÑ„Åß„Åô</li>
                </ul>
            </div>

            <!-- Artifacts -->
            {% if submission.score_breakdown.functional_summary.artifacts %}
            <div class="border-t pt-4">
                <h4 class="font-semibold mb-2">üìÅ Artifacts</h4>
                <div class="space-y-2">
            {% if submission.score_breakdown.functional_summary.artifacts.report %}
            <div class="text-sm">
                <span class="font-medium">Report (JSONL):</span>
                <code class="text-xs bg-gray-100 px-2 py-1 rounded">{{ submission.score_breakdown.functional_summary.artifacts.report }}</code>
            </div>
            {% endif %}
            {% if submission.score_breakdown.functional_summary.artifacts.prompts %}
            <div class="text-sm">
                <span class="font-medium">Prompts:</span>
                <code class="text-xs bg-gray-100 px-2 py-1 rounded">{{ submission.score_breakdown.functional_summary.artifacts.prompts }}</code>
            </div>
            {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
        {% else %}
        <p class="ml-7 text-sm text-gray-500">No functional test results available</p>
        {% endif %}
    </details>
    <!-- Jury Judge - MAGI SYSTEM -->
    <details id="details-judge" class="mb-6 rounded-lg overflow-hidden" open>
        <summary class="text-lg font-semibold p-4 flex items-center cursor-pointer bg-gray-800 text-white">
            <span class="mr-2">‚öñÔ∏è</span> Jury Judge Panel - MAGI SYSTEM
            {% if submission.state == 'judge_panel_running' %}
            <span id="ws-status" class="ml-auto text-xs px-2 py-1 rounded bg-green-500 text-white animate-pulse">RUNNING</span>
            {% endif %}
        </summary>

        <!-- MAGI System Container -->
        <div id="magi-container" class="magi-system p-6" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);">

            {# Extract data for both realtime and historical display #}
            {% set show_realtime = submission.state == 'judge_panel_running' %}
            {% set show_historical = submission.score_breakdown.judge_summary and submission.score_breakdown.judge_summary.scenarios %}
            {% set collective = namespace(found=none) %}
            {% if show_historical %}
                {% for scenario in submission.score_breakdown.judge_summary.scenarios %}
                    {% if scenario.scenarioId == 'collective_judgment' %}
                        {% set collective.found = scenario %}
                    {% endif %}
                {% endfor %}
            {% endif %}

            {# Extract evaluation data for each juror from historical data #}
            {% set balthasar_eval = namespace(found=none) %}
            {% set casper_eval = namespace(found=none) %}
            {% set melchior_eval = namespace(found=none) %}
            {% if show_historical and collective.found and collective.found.phase1Evaluations %}
                {% for eval in collective.found.phase1Evaluations %}
                    {% if 'claude' in eval.jurorId %}
                        {% set balthasar_eval.found = eval %}
                    {% elif 'gemini' in eval.jurorId %}
                        {% set casper_eval.found = eval %}
                    {% elif 'gpt-4o' in eval.jurorId %}
                        {% set melchior_eval.found = eval %}
                    {% endif %}
                {% endfor %}
            {% endif %}

            <!-- MAGI Panel Layout -->
            <div class="magi-panel-container mb-6">
                <!-- BALTHASAR-2 (Top Center) -->
                <div class="flex justify-center mb-4">
                    <div id="magi-balthasar" class="magi-unit magi-balthasar {% if balthasar_eval.found %}vote-confirmed{% endif %}" data-juror="claude-3-haiku-20240307"
                         {% if balthasar_eval.found %}style="--glow-color: {% if balthasar_eval.found.verdict == 'safe_pass' %}#51cf66{% elif balthasar_eval.found.verdict == 'unsafe_fail' %}#ff6b6b{% else %}#ffd43b{% endif %}"{% endif %}>
                        <div class="magi-unit-header">
                            <span class="magi-unit-name">BALTHASAR„Éª2</span>
                            <span class="magi-unit-model">claude-3-haiku</span>
                        </div>
                        <div class="magi-unit-role">Security / ÂÆâÂÖ®ÊÄß</div>
                        <div class="magi-unit-status" id="balthasar-status">{% if balthasar_eval.found %}ÂÆå‰∫Ü{% else %}ÂæÖÊ©ü‰∏≠{% endif %}</div>
                        <div class="magi-unit-vote {% if balthasar_eval.found %}{% if balthasar_eval.found.verdict == 'safe_pass' %}magi-vote-pass{% elif balthasar_eval.found.verdict == 'unsafe_fail' %}magi-vote-fail{% else %}magi-vote-review{% endif %}{% endif %}" id="balthasar-vote">
                            {% if balthasar_eval.found %}{% if balthasar_eval.found.verdict == 'safe_pass' %}PASS{% elif balthasar_eval.found.verdict == 'unsafe_fail' %}FAIL{% else %}REVIEW{% endif %}{% else %}-{% endif %}
                        </div>
                        <div class="magi-unit-scores" id="balthasar-scores">
                            {% set tc = balthasar_eval.found.taskCompletion or 0 if balthasar_eval.found else 0 %}
                            {% set tu = balthasar_eval.found.toolUsage or 0 if balthasar_eval.found else 0 %}
                            {% set au = balthasar_eval.found.autonomy or 0 if balthasar_eval.found else 0 %}
                            {% set sf = balthasar_eval.found.safety or 0 if balthasar_eval.found else 0 %}
                            <div class="magi-score-bar" data-axis="task"><span>T</span><div class="bar"><div class="fill" style="width:{{ (tc / 40 * 100) | int }}%"></div></div></div>
                            <div class="magi-score-bar" data-axis="tool"><span>U</span><div class="bar"><div class="fill" style="width:{{ (tu / 30 * 100) | int }}%"></div></div></div>
                            <div class="magi-score-bar" data-axis="auto"><span>A</span><div class="bar"><div class="fill" style="width:{{ (au / 20 * 100) | int }}%"></div></div></div>
                            <div class="magi-score-bar" data-axis="safe"><span>S</span><div class="bar"><div class="fill" style="width:{{ (sf / 10 * 100) | int }}%"></div></div></div>
                        </div>
                    </div>
                </div>

                <!-- MAGI Central Connector -->
                <div class="flex justify-center mb-4">
                    <div class="magi-central">
                        <span class="magi-central-text">MAGI</span>
                        <div class="magi-connectors">
                            <div class="connector connector-left"></div>
                            <div class="connector connector-right"></div>
                        </div>
                    </div>
                </div>

                <!-- CASPER-3 (Left) and MELCHIOR-1 (Right) -->
                <div class="flex justify-center gap-8">
                    <!-- CASPER-3 -->
                    <div id="magi-casper" class="magi-unit magi-casper {% if casper_eval.found %}vote-confirmed{% endif %}" data-juror="gemini-2.5-flash"
                         {% if casper_eval.found %}style="--glow-color: {% if casper_eval.found.verdict == 'safe_pass' %}#51cf66{% elif casper_eval.found.verdict == 'unsafe_fail' %}#ff6b6b{% else %}#ffd43b{% endif %}"{% endif %}>
                        <div class="magi-unit-header">
                            <span class="magi-unit-name">CASPER„Éª3</span>
                            <span class="magi-unit-model">gemini-2.5-flash</span>
                        </div>
                        <div class="magi-unit-role">Misuse / ÊÇ™Áî®Ê§úÂá∫</div>
                        <div class="magi-unit-status" id="casper-status">{% if casper_eval.found %}ÂÆå‰∫Ü{% else %}ÂæÖÊ©ü‰∏≠{% endif %}</div>
                        <div class="magi-unit-vote {% if casper_eval.found %}{% if casper_eval.found.verdict == 'safe_pass' %}magi-vote-pass{% elif casper_eval.found.verdict == 'unsafe_fail' %}magi-vote-fail{% else %}magi-vote-review{% endif %}{% endif %}" id="casper-vote">
                            {% if casper_eval.found %}{% if casper_eval.found.verdict == 'safe_pass' %}PASS{% elif casper_eval.found.verdict == 'unsafe_fail' %}FAIL{% else %}REVIEW{% endif %}{% else %}-{% endif %}
                        </div>
                        <div class="magi-unit-scores" id="casper-scores">
                            {% set tc = casper_eval.found.taskCompletion or 0 if casper_eval.found else 0 %}
                            {% set tu = casper_eval.found.toolUsage or 0 if casper_eval.found else 0 %}
                            {% set au = casper_eval.found.autonomy or 0 if casper_eval.found else 0 %}
                            {% set sf = casper_eval.found.safety or 0 if casper_eval.found else 0 %}
                            <div class="magi-score-bar" data-axis="task"><span>T</span><div class="bar"><div class="fill" style="width:{{ (tc / 40 * 100) | int }}%"></div></div></div>
                            <div class="magi-score-bar" data-axis="tool"><span>U</span><div class="bar"><div class="fill" style="width:{{ (tu / 30 * 100) | int }}%"></div></div></div>
                            <div class="magi-score-bar" data-axis="auto"><span>A</span><div class="bar"><div class="fill" style="width:{{ (au / 20 * 100) | int }}%"></div></div></div>
                            <div class="magi-score-bar" data-axis="safe"><span>S</span><div class="bar"><div class="fill" style="width:{{ (sf / 10 * 100) | int }}%"></div></div></div>
                        </div>
                    </div>

                    <!-- MELCHIOR-1 -->
                    <div id="magi-melchior" class="magi-unit magi-melchior {% if melchior_eval.found %}vote-confirmed{% endif %}" data-juror="gpt-4o"
                         {% if melchior_eval.found %}style="--glow-color: {% if melchior_eval.found.verdict == 'safe_pass' %}#51cf66{% elif melchior_eval.found.verdict == 'unsafe_fail' %}#ff6b6b{% else %}#ffd43b{% endif %}"{% endif %}>
                        <div class="magi-unit-header">
                            <span class="magi-unit-name">MELCHIOR„Éª1</span>
                            <span class="magi-unit-model">gpt-4o</span>
                        </div>
                        <div class="magi-unit-role">Policy / „Éù„É™„Ç∑„ÉºÈÅµÂÆà</div>
                        <div class="magi-unit-status" id="melchior-status">{% if melchior_eval.found %}ÂÆå‰∫Ü{% else %}ÂæÖÊ©ü‰∏≠{% endif %}</div>
                        <div class="magi-unit-vote {% if melchior_eval.found %}{% if melchior_eval.found.verdict == 'safe_pass' %}magi-vote-pass{% elif melchior_eval.found.verdict == 'unsafe_fail' %}magi-vote-fail{% else %}magi-vote-review{% endif %}{% endif %}" id="melchior-vote">
                            {% if melchior_eval.found %}{% if melchior_eval.found.verdict == 'safe_pass' %}PASS{% elif melchior_eval.found.verdict == 'unsafe_fail' %}FAIL{% else %}REVIEW{% endif %}{% else %}-{% endif %}
                        </div>
                        <div class="magi-unit-scores" id="melchior-scores">
                            {% set tc = melchior_eval.found.taskCompletion or 0 if melchior_eval.found else 0 %}
                            {% set tu = melchior_eval.found.toolUsage or 0 if melchior_eval.found else 0 %}
                            {% set au = melchior_eval.found.autonomy or 0 if melchior_eval.found else 0 %}
                            {% set sf = melchior_eval.found.safety or 0 if melchior_eval.found else 0 %}
                            <div class="magi-score-bar" data-axis="task"><span>T</span><div class="bar"><div class="fill" style="width:{{ (tc / 40 * 100) | int }}%"></div></div></div>
                            <div class="magi-score-bar" data-axis="tool"><span>U</span><div class="bar"><div class="fill" style="width:{{ (tu / 30 * 100) | int }}%"></div></div></div>
                            <div class="magi-score-bar" data-axis="auto"><span>A</span><div class="bar"><div class="fill" style="width:{{ (au / 20 * 100) | int }}%"></div></div></div>
                            <div class="magi-score-bar" data-axis="safe"><span>S</span><div class="bar"><div class="fill" style="width:{{ (sf / 10 * 100) | int }}%"></div></div></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Discussion Log -->
            <div class="magi-discussion-container mb-6">
                <div class="magi-section-header">
                    <span class="magi-section-icon">üí¨</span>
                    <span class="magi-section-title">Discussion Log</span>
                    <span id="magi-phase-indicator" class="magi-phase-badge">
                        {%- if show_historical and collective.found and collective.found.finalJudgment -%}Phase 3 ÂÆå‰∫Ü
                        {%- elif show_historical and collective.found and collective.found.discussionRounds -%}Phase 2
                        {%- elif show_historical and collective.found and collective.found.phase1Evaluations -%}Phase 1
                        {%- else -%}Phase 1{%- endif -%}
                    </span>
                </div>
                <div id="magi-discussion-log" class="magi-discussion-log">
                    {% if show_historical and collective.found %}
                        {# Phase 1 Evaluations #}
                        {% if collective.found.phase1Evaluations %}
                            {% for evaluation in collective.found.phase1Evaluations %}
                            <div class="magi-log-entry magi-log-evaluation" data-juror="{{ evaluation.jurorId }}">
                                <div class="magi-log-header">
                                    <span class="magi-log-speaker
                                        {% if 'gpt-4o' in evaluation.jurorId %}magi-speaker-melchior
                                        {% elif 'claude' in evaluation.jurorId %}magi-speaker-balthasar
                                        {% else %}magi-speaker-casper{% endif %}">
                                        {% if 'gpt-4o' in evaluation.jurorId %}[MELCHIOR-1]
                                        {% elif 'claude' in evaluation.jurorId %}[BALTHASAR-2]
                                        {% else %}[CASPER-3]{% endif %}
                                    </span>
                                    <span class="magi-log-badge magi-badge-{% if evaluation.verdict == 'safe_pass' %}pass{% elif evaluation.verdict == 'unsafe_fail' %}fail{% else %}review{% endif %}">
                                        {{ evaluation.verdict }}
                                    </span>
                                </div>
                                <div class="magi-log-content">
                                    Score: {{ ((evaluation.taskCompletion or 0) + (evaluation.toolUsage or 0) + (evaluation.autonomy or 0) + (evaluation.safety or 0)) | int }}/100
                                    {% if evaluation.rationale %}
                                    <details class="magi-log-details">
                                        <summary>Ë©≥Á¥∞</summary>
                                        <div class="magi-log-rationale">{{ evaluation.rationale }}</div>
                                    </details>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        {% endif %}

                        {# Phase 2 Discussion #}
                        {% if collective.found.discussionRounds %}
                            {% for round in collective.found.discussionRounds %}
                                {% for statement in round.statements %}
                                {% set juror_role = collective.found.phase1Evaluations | selectattr('jurorId', 'equalto', statement.jurorId) | first %}
                                <div class="magi-log-entry magi-log-statement" data-juror="{{ statement.jurorId }}">
                                    <div class="magi-log-header">
                                        <span class="magi-log-speaker
                                            {% if 'gpt-4o' in statement.jurorId %}magi-speaker-melchior
                                            {% elif 'claude' in statement.jurorId %}magi-speaker-balthasar
                                            {% else %}magi-speaker-casper{% endif %}">
                                            {% if 'gpt-4o' in statement.jurorId %}[MELCHIOR-1]
                                            {% elif 'claude' in statement.jurorId %}[BALTHASAR-2]
                                            {% else %}[CASPER-3]{% endif %}
                                        </span>
                                        {% if statement.positionChanged %}
                                        <span class="magi-log-badge magi-badge-changed">Á´ãÂ†¥Â§âÊõ¥</span>
                                        {% endif %}
                                    </div>
                                    <div class="magi-log-content">{{ statement.statement }}</div>
                                </div>
                                {% endfor %}
                            {% endfor %}
                        {% endif %}
                    {% else %}
                        <div class="magi-log-placeholder">Ë©ï‰æ°ÈñãÂßã„ÇíÂæÖÊ©ü‰∏≠...</div>
                    {% endif %}
                </div>
            </div>

            <!-- Final Decision -->
            <div class="magi-decision-container">
                <div class="magi-section-header">
                    <span class="magi-section-icon">üìä</span>
                    <span class="magi-section-title">Final Decision</span>
                </div>
                <div id="magi-final-decision" class="magi-decision-panel">
                    {% if show_historical and collective.found and collective.found.finalJudgment %}
                    <div class="magi-decision-result
                        {% if collective.found.finalJudgment.finalVerdict == 'safe_pass' %}magi-result-pass
                        {% elif collective.found.finalJudgment.finalVerdict == 'unsafe_fail' %}magi-result-fail
                        {% else %}magi-result-review{% endif %}">
                        <div class="magi-decision-verdict">
                            {% if collective.found.finalJudgment.finalVerdict == 'safe_pass' %}ÂèØÊ±∫
                            {% elif collective.found.finalJudgment.finalVerdict == 'unsafe_fail' %}Âê¶Ê±∫
                            {% else %}Ë¶ÅÁ¢∫Ë™ç{% endif %}
                        </div>
                        <div class="magi-decision-score">
                            <span class="magi-score-label">Trust Score</span>
                            <span class="magi-score-value">{{ submission.trust_score }}/100</span>
                        </div>
                        <div class="magi-decision-confidence">
                            ‰ø°È†ºÂ∫¶: {{ (collective.found.finalJudgment.confidence * 100) | int }}%
                        </div>
                    </div>
                    {% else %}
                    <div class="magi-decision-pending">
                        <span class="magi-pending-text">Âà§ÂÆöÂæÖÊ©ü‰∏≠</span>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Detailed Scores (Collapsed by default) -->
            {% if submission.score_breakdown.judge_summary %}
            <details class="magi-details-section mt-6">
                <summary class="magi-details-summary">Ë©≥Á¥∞„Çπ„Ç≥„Ç¢„ÉªË®≠ÂÆö</summary>
                <div class="magi-details-content bg-gray-800 p-4 rounded-lg mt-2">
                    <!-- AISI 4-Axis Scores -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                        <div class="bg-blue-900/50 p-3 rounded border border-blue-500/30">
                            <div class="text-xs text-blue-300">Task Completion</div>
                            <div class="text-2xl font-bold text-blue-400" data-judge-task>{{ submission.score_breakdown.judge_summary.taskCompletion or 0 }}/40</div>
                        </div>
                        <div class="bg-green-900/50 p-3 rounded border border-green-500/30">
                            <div class="text-xs text-green-300">Tool Usage</div>
                            <div class="text-2xl font-bold text-green-400" data-judge-tool>{{ submission.score_breakdown.judge_summary.tool or 0 }}/30</div>
                        </div>
                        <div class="bg-yellow-900/50 p-3 rounded border border-yellow-500/30">
                            <div class="text-xs text-yellow-300">Autonomy</div>
                            <div class="text-2xl font-bold text-yellow-400" data-judge-autonomy>{{ submission.score_breakdown.judge_summary.autonomy or 0 }}/20</div>
                        </div>
                        <div class="bg-red-900/50 p-3 rounded border border-red-500/30">
                            <div class="text-xs text-red-300">Safety</div>
                            <div class="text-2xl font-bold text-red-400" data-judge-safety>{{ submission.score_breakdown.judge_summary.safety or 0 }}/10</div>
                        </div>
                    </div>

                    <!-- LLM Configuration -->
                    {% if submission.score_breakdown.judge_summary.llmJudge %}
                    <div class="text-gray-300 text-sm">
                        <div class="font-semibold mb-2 text-gray-200">LLM Judge Configuration</div>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                            {% if submission.score_breakdown.judge_summary.llmJudge.models %}
                            <div class="bg-gray-700/50 p-2 rounded">
                                <span class="text-xs text-gray-400">Models:</span>
                                <span class="ml-2">{{ submission.score_breakdown.judge_summary.llmJudge.models | join(', ') }}</span>
                            </div>
                            {% endif %}
                            <div class="bg-gray-700/50 p-2 rounded">
                                <span class="text-xs text-gray-400">Temperature:</span>
                                <span class="ml-2">{{ submission.score_breakdown.judge_summary.llmJudge.temperature or 'default' }}</span>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Artifacts -->
                    {% if submission.score_breakdown.judge_summary.artifacts %}
                    <div class="mt-4 text-gray-300 text-sm">
                        <div class="font-semibold mb-2 text-gray-200">Artifacts</div>
                        {% if submission.score_breakdown.judge_summary.artifacts.report %}
                        <code class="text-xs bg-gray-700 px-2 py-1 rounded text-green-400">{{ submission.score_breakdown.judge_summary.artifacts.report }}</code>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </details>
            {% endif %}

            <!-- Confirmation Points (Collapsed) -->
            <details class="magi-details-section mt-4">
                <summary class="magi-details-summary">üìã Á¢∫Ë™ç„Éù„Ç§„É≥„Éà</summary>
                <div class="magi-details-content bg-gray-800 p-4 rounded-lg mt-2 text-gray-300 text-sm">
                    <ul class="space-y-1 list-disc ml-5">
                        <li>3‰∫∫„ÅÆÈô™ÂØ©Âì°„Å´„Çà„ÇãÂçîË™øË©ï‰æ°„Éó„É≠„Çª„Çπ„ÅÆÁµêÊûú„ÇíÁ¢∫Ë™ç</li>
                        <li>AISIÂü∫Ê∫ñ„Çπ„Ç≥„Ç¢(Task/Tool/Autonomy/Safety)„ÅÆÂÜÖË®≥„ÇíÁ¢∫Ë™ç</li>
                        <li>ÊúÄÁµÇÂà§ÂÆö„ÅÆ‰ø°È†ºÂ∫¶„Å®Âà§ÂÆöÊñπÊ≥ï„ÇíÁ¢∫Ë™ç</li>
                    </ul>
                </div>
            </details>
        </div>

        <!-- MAGI System CSS -->
        <style>
            .magi-system {
                font-family: 'Courier New', monospace;
                color: #eaeaea;
            }

            /* MAGI Unit Panels */
            .magi-unit {
                width: 200px;
                padding: 16px;
                border-radius: 8px;
                border: 2px solid;
                position: relative;
                transition: all 0.3s ease;
            }

            .magi-melchior {
                background: rgba(77, 171, 247, 0.1);
                border-color: #4dabf7;
            }
            .magi-balthasar {
                background: rgba(81, 207, 102, 0.1);
                border-color: #51cf66;
            }
            .magi-casper {
                background: rgba(190, 75, 219, 0.1);
                border-color: #be4bdb;
            }

            .magi-unit-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 8px;
            }
            .magi-unit-name {
                font-weight: bold;
                font-size: 14px;
            }
            .magi-unit-model {
                font-size: 10px;
                opacity: 0.7;
            }
            .magi-unit-role {
                font-size: 11px;
                opacity: 0.8;
                margin-bottom: 8px;
            }
            .magi-unit-status {
                font-size: 12px;
                padding: 4px 8px;
                background: rgba(134, 142, 150, 0.3);
                border-radius: 4px;
                text-align: center;
                margin-bottom: 8px;
            }
            .magi-unit-vote {
                font-size: 24px;
                font-weight: bold;
                text-align: center;
                padding: 8px;
                border-radius: 4px;
                background: rgba(0,0,0,0.3);
                margin-bottom: 8px;
            }

            /* Vote States */
            .magi-vote-pass { color: #51cf66; text-shadow: 0 0 10px #51cf66; }
            .magi-vote-fail { color: #ff6b6b; text-shadow: 0 0 10px #ff6b6b; }
            .magi-vote-review { color: #ffd43b; text-shadow: 0 0 10px #ffd43b; }

            /* Glow Animation */
            @keyframes vote-glow {
                0%, 100% { box-shadow: 0 0 5px var(--glow-color, #51cf66); }
                50% { box-shadow: 0 0 20px var(--glow-color, #51cf66), 0 0 30px var(--glow-color, #51cf66); }
            }
            .magi-unit.vote-confirmed {
                animation: vote-glow 1s ease-in-out 3;
            }

            /* Evaluating Animation */
            @keyframes pulse-evaluating {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.5; }
            }
            .magi-unit.evaluating {
                animation: pulse-evaluating 1.5s ease-in-out infinite;
            }
            .magi-unit.evaluating .magi-unit-status {
                background: rgba(255, 212, 59, 0.3);
                color: #ffd43b;
            }

            /* Score Bars */
            .magi-unit-scores {
                display: grid;
                gap: 4px;
            }
            .magi-score-bar {
                display: flex;
                align-items: center;
                font-size: 10px;
            }
            .magi-score-bar span {
                width: 16px;
                text-align: center;
            }
            .magi-score-bar .bar {
                flex: 1;
                height: 6px;
                background: rgba(255,255,255,0.1);
                border-radius: 3px;
                overflow: hidden;
                margin-left: 4px;
            }
            .magi-score-bar .fill {
                height: 100%;
                border-radius: 3px;
                transition: width 0.5s ease;
            }
            .magi-score-bar[data-axis="task"] .fill { background: #4dabf7; }
            .magi-score-bar[data-axis="tool"] .fill { background: #51cf66; }
            .magi-score-bar[data-axis="auto"] .fill { background: #ffd43b; }
            .magi-score-bar[data-axis="safe"] .fill { background: #ff6b6b; }

            /* Central Connector */
            .magi-central {
                background: linear-gradient(180deg, #e94560, #0f3460);
                padding: 12px 32px;
                border-radius: 8px;
                position: relative;
            }
            .magi-central-text {
                font-weight: bold;
                font-size: 18px;
                color: #ffd43b;
                text-shadow: 0 0 10px #ffd43b;
            }

            /* Discussion Log */
            .magi-discussion-container {
                background: rgba(0,0,0,0.3);
                border: 1px solid #0f3460;
                border-radius: 8px;
                overflow: hidden;
            }
            .magi-section-header {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 12px 16px;
                background: rgba(15, 52, 96, 0.5);
                border-bottom: 1px solid #0f3460;
            }
            .magi-section-icon { font-size: 16px; }
            .magi-section-title { font-weight: bold; font-size: 14px; }
            .magi-phase-badge {
                margin-left: auto;
                font-size: 11px;
                padding: 2px 8px;
                background: #be4bdb;
                border-radius: 4px;
            }
            .magi-discussion-log {
                max-height: 300px;
                overflow-y: auto;
                padding: 12px;
            }
            .magi-log-placeholder {
                text-align: center;
                padding: 40px;
                opacity: 0.5;
            }
            .magi-log-entry {
                padding: 8px 12px;
                margin-bottom: 8px;
                background: rgba(255,255,255,0.05);
                border-radius: 4px;
                border-left: 3px solid #868e96;
            }
            .magi-log-header {
                display: flex;
                align-items: center;
                gap: 8px;
                margin-bottom: 4px;
            }
            .magi-log-speaker {
                font-weight: bold;
                font-size: 12px;
            }
            .magi-speaker-melchior { color: #4dabf7; }
            .magi-speaker-balthasar { color: #51cf66; }
            .magi-speaker-casper { color: #be4bdb; }

            .magi-log-badge {
                font-size: 10px;
                padding: 2px 6px;
                border-radius: 3px;
            }
            .magi-badge-pass { background: #51cf66; color: #000; }
            .magi-badge-fail { background: #ff6b6b; color: #000; }
            .magi-badge-review { background: #ffd43b; color: #000; }
            .magi-badge-changed { background: #4dabf7; color: #000; }
            .magi-badge-info { background: #868e96; color: #fff; }

            .magi-speaker-system { color: #e94560; }

            .magi-log-content {
                font-size: 12px;
                line-height: 1.5;
            }
            .magi-log-details {
                margin-top: 4px;
            }
            .magi-log-details summary {
                font-size: 10px;
                cursor: pointer;
                color: #868e96;
            }
            .magi-log-rationale {
                margin-top: 4px;
                padding: 8px;
                background: rgba(0,0,0,0.2);
                border-radius: 4px;
                font-size: 11px;
                white-space: pre-wrap;
            }

            /* Final Decision */
            .magi-decision-container {
                background: rgba(0,0,0,0.3);
                border: 1px solid #0f3460;
                border-radius: 8px;
                overflow: hidden;
            }
            .magi-decision-panel {
                padding: 16px;
                text-align: center;
            }
            .magi-decision-pending {
                padding: 32px;
                opacity: 0.5;
            }
            .magi-pending-text {
                font-size: 14px;
            }
            .magi-decision-result {
                padding: 24px;
                border-radius: 8px;
            }
            .magi-result-pass {
                background: rgba(81, 207, 102, 0.2);
                border: 2px solid #51cf66;
            }
            .magi-result-fail {
                background: rgba(255, 107, 107, 0.2);
                border: 2px solid #ff6b6b;
            }
            .magi-result-review {
                background: rgba(255, 212, 59, 0.2);
                border: 2px solid #ffd43b;
            }
            .magi-decision-verdict {
                font-size: 32px;
                font-weight: bold;
                margin-bottom: 16px;
            }
            .magi-result-pass .magi-decision-verdict { color: #51cf66; text-shadow: 0 0 20px #51cf66; }
            .magi-result-fail .magi-decision-verdict { color: #ff6b6b; text-shadow: 0 0 20px #ff6b6b; }
            .magi-result-review .magi-decision-verdict { color: #ffd43b; text-shadow: 0 0 20px #ffd43b; }

            .magi-decision-score {
                margin-bottom: 8px;
            }
            .magi-score-label {
                font-size: 12px;
                opacity: 0.7;
            }
            .magi-score-value {
                font-size: 28px;
                font-weight: bold;
                margin-left: 8px;
            }
            .magi-decision-confidence {
                font-size: 12px;
                opacity: 0.8;
            }
            .magi-decision-method {
                font-size: 11px;
                opacity: 0.7;
                margin-top: 8px;
            }
            .magi-decision-rationale {
                margin-top: 12px;
                font-size: 12px;
                text-align: left;
                padding: 12px;
                background: rgba(0,0,0,0.2);
                border-radius: 4px;
            }

            .magi-log-footer {
                font-size: 11px;
                margin-top: 4px;
                opacity: 0.8;
                color: #ffd43b;
            }

            /* Log entry types */
            .magi-log-evaluation { border-left-color: #4dabf7; }
            .magi-log-statement { border-left-color: #51cf66; }
            .magi-log-system { border-left-color: #e94560; }
            .magi-log-consensus { border-left-color: #be4bdb; }
            .magi-log-final { border-left-color: #ffd43b; }

            /* Details Sections */
            .magi-details-section {
                color: #eaeaea;
            }
            .magi-details-summary {
                cursor: pointer;
                padding: 8px 12px;
                background: rgba(255,255,255,0.1);
                border-radius: 4px;
                font-size: 12px;
            }
            .magi-details-summary:hover {
                background: rgba(255,255,255,0.15);
            }
        </style>

        {% if submission.state != 'judge_panel_running' and not submission.score_breakdown.judge_summary %}
        <p class="p-4 text-sm text-gray-400 text-center">No judge panel results available</p>
        {% endif %}
    </details>
    <!-- Publish -->
    <details id="details-publish" class="mb-6 bg-gray-50 p-4 rounded-lg">
        <summary class="text-lg font-semibold mb-2 flex items-center cursor-pointer">
            <span class="mr-2">üöÄ</span> Publish
        </summary>
        {% if submission.score_breakdown.publish_summary %}
        <div class="ml-7 space-y-2 mt-2">
            <p class="text-sm text-gray-700">
                <span class="font-semibold">Status:</span>
                <span class="{% if submission.score_breakdown.publish_summary.status == 'published' %}text-green-600{% else %}text-yellow-600{% endif %}">
            {{ submission.score_breakdown.publish_summary.status }}
                </span>
            </p>
            {% if submission.score_breakdown.publish_summary.publishedAt %}
            <p class="text-sm text-gray-700">
                <span class="font-semibold">Published At:</span> {{ submission.score_breakdown.publish_summary.publishedAt }}
            </p>
            {% endif %}
            <p class="text-sm text-gray-700">
                <span class="font-semibold">Trust Score:</span> {{ submission.score_breakdown.publish_summary.trustScore }}/100
            </p>
        </div>
        {% else %}
        <p class="ml-7 text-sm text-gray-500">Not yet published</p>
        {% endif %}
    </details>
    {% else %}
    <p class="text-gray-500">Automated review is in progress or not yet started...</p>
    {% endif %}
</div>

<script src="/static/judge-stream.js"></script>
<script>
    // Initialize Jury Judge SSE client for real-time updates
    (function() {
        const submissionId = '{{ submission.id }}';
        const judgeState = '{{ submission.state }}';
        const urlPrefix = '{{ url_prefix }}' || '';

        console.log('[DEBUG] Initializing Jury Judge stream client');
        console.log('[DEBUG] Submission ID:', submissionId);
        console.log('[DEBUG] Judge State:', judgeState);

        const juryStream = new JuryJudgeStream(submissionId, { basePath: urlPrefix });
        console.log('[DEBUG] JuryJudgeStream instance created:', juryStream);

    // Initialize SSE (primary path for real-time streaming)
    let jurySSE = null;
    function connectSSE() {
        const base = window.location.origin.replace(/\/$/, '');
        const sseUrl = `${base}${urlPrefix}/sse/submissions/${submissionId}/judge`;
        console.log('[DEBUG] Attempting SSE connection:', sseUrl);
        try {
            jurySSE = new EventSource(sseUrl, { withCredentials: false });

            jurySSE.onopen = () => {
                console.log('[DEBUG] üü¢ SSE connected');
                const wsStatus = document.getElementById('ws-status');
                if (wsStatus) {
                    wsStatus.textContent = 'Êé•Á∂öÊ∏à„Åø (SSE)';
                    wsStatus.className = 'ml-auto text-xs px-2 py-1 rounded bg-green-100 text-green-800';
                }
            };

            jurySSE.onmessage = (event) => {
                if (!event?.data) return;
                // Reuse existing handler pipeline
                juryStream.handleMessage({ data: event.data });
            };

            jurySSE.addEventListener('ping', () => {
                // Heartbeat; no-op
            });

            jurySSE.onerror = (err) => {
                console.error('[DEBUG] SSE error:', err);
                const wsStatus = document.getElementById('ws-status');
                if (wsStatus) {
                    wsStatus.textContent = 'ÂÜçÊé•Á∂ö‰∏≠ (SSE)';
                    wsStatus.className = 'ml-auto text-xs px-2 py-1 rounded bg-yellow-100 text-yellow-800';
                }
                // Browser auto-reconnects EventSource; no manual reconnect needed
            };
        } catch (e) {
            console.error('[DEBUG] SSE init failed:', e);
        }
    }

    // Connection status handlers
    juryStream.on('connected', () => {
        console.log('[DEBUG] üü¢ WebSocket connected event fired');

        // Update unified panel status badge
        const wsStatus = document.getElementById('ws-status');
        console.log('[DEBUG] ws-status element:', wsStatus);
        if (wsStatus) {
            wsStatus.textContent = 'Êé•Á∂öÊ∏à„Åø';
            wsStatus.className = 'ml-auto text-xs px-2 py-1 rounded bg-green-100 text-green-800';
            console.log('[DEBUG] Updated ws-status to "Êé•Á∂öÊ∏à„Åø"');
        }
    });

    juryStream.on('disconnected', () => {
        const wsStatus = document.getElementById('ws-status');
        if (wsStatus) {
            wsStatus.textContent = 'ÂàáÊñ≠';
            wsStatus.className = 'ml-auto text-xs px-2 py-1 rounded bg-red-100 text-red-800';
        }
    });

    // Phase change handler - MAGI System
    juryStream.on('phase_change', (data) => {
        console.log('[DEBUG] üîÑ phase_change event handler called with data:', data);

        // Update MAGI phase indicator
        const phaseIndicator = document.getElementById('magi-phase-indicator');
        if (phaseIndicator) {
            const phaseMap = {
                'initial_evaluation': 'Phase 1',
                'discussion': 'Phase 2',
                'final_judgment': 'Phase 3'
            };
            phaseIndicator.textContent = phaseMap[data.phase] || `Phase ${data.phaseNumber || '?'}`;
        }

        // Set all MAGI units to evaluating state at Phase 1 start
        if (data.phaseNumber === 1) {
            ['melchior', 'balthasar', 'casper'].forEach(unit => {
                const unitEl = document.getElementById(`magi-${unit}`);
                const statusEl = document.getElementById(`${unit}-status`);
                if (unitEl) unitEl.classList.add('evaluating');
                if (statusEl) statusEl.textContent = 'Ë©ï‰æ°‰∏≠...';
            });
        }
    });

    // Helper function to map juror IDs to MAGI unit names
    function getMAGIUnit(jurorId) {
        if (jurorId.includes('gpt-4o') || jurorId.includes('gpt4o')) return 'melchior';
        if (jurorId.includes('claude')) return 'balthasar';
        if (jurorId.includes('gemini')) return 'casper';
        // Fallback based on position
        return 'melchior';
    }

    function getMAGISpeaker(jurorId) {
        const unit = getMAGIUnit(jurorId);
        const names = { melchior: 'MELCHIOR-1', balthasar: 'BALTHASAR-2', casper: 'CASPER-3' };
        return names[unit] || jurorId;
    }

    // Juror evaluation handler (Phase 1) - MAGI System
    juryStream.on('juror_evaluation', (data) => {
        console.log('[DEBUG] üë®‚Äç‚öñÔ∏è juror_evaluation event handler called with data:', data);

        const unit = getMAGIUnit(data.juror);
        const unitEl = document.getElementById(`magi-${unit}`);
        const statusEl = document.getElementById(`${unit}-status`);
        const voteEl = document.getElementById(`${unit}-vote`);
        const scoresEl = document.getElementById(`${unit}-scores`);

        if (unitEl) {
            // Remove evaluating state, add completed
            unitEl.classList.remove('evaluating');
            unitEl.classList.add('vote-confirmed');

            // Set vote glow color based on verdict
            if (data.verdict === 'safe_pass') {
                unitEl.style.setProperty('--glow-color', '#51cf66');
            } else if (data.verdict === 'unsafe_fail') {
                unitEl.style.setProperty('--glow-color', '#ff6b6b');
            } else {
                unitEl.style.setProperty('--glow-color', '#ffd43b');
            }
        }

        if (statusEl) {
            statusEl.textContent = 'ÂÆå‰∫Ü';
        }

        if (voteEl) {
            const verdictMap = {
                'safe_pass': { text: 'PASS', class: 'magi-vote-pass' },
                'unsafe_fail': { text: 'FAIL', class: 'magi-vote-fail' },
                'needs_review': { text: 'REVIEW', class: 'magi-vote-review' }
            };
            const v = verdictMap[data.verdict] || { text: data.verdict, class: '' };
            voteEl.textContent = v.text;
            voteEl.className = `magi-unit-vote ${v.class}`;
        }

        // Update score bars
        if (scoresEl) {
            const tc = data.taskCompletion || 0;
            const tu = data.toolUsage || 0;
            const au = data.autonomy || 0;
            const sf = data.safety || 0;

            // Task bar (max 40)
            const taskBar = scoresEl.querySelector('[data-axis="task"] .fill');
            if (taskBar) taskBar.style.width = `${(tc / 40) * 100}%`;

            // Tool bar (max 30)
            const toolBar = scoresEl.querySelector('[data-axis="tool"] .fill');
            if (toolBar) toolBar.style.width = `${(tu / 30) * 100}%`;

            // Autonomy bar (max 20)
            const autoBar = scoresEl.querySelector('[data-axis="auto"] .fill');
            if (autoBar) autoBar.style.width = `${(au / 20) * 100}%`;

            // Safety bar (max 10)
            const safeBar = scoresEl.querySelector('[data-axis="safe"] .fill');
            if (safeBar) safeBar.style.width = `${(sf / 10) * 100}%`;
        }

        // Add to discussion log
        const discussionLog = document.getElementById('magi-discussion-log');
        if (discussionLog) {
            // Remove placeholder if exists
            const placeholder = discussionLog.querySelector('.magi-log-placeholder');
            if (placeholder) placeholder.remove();

            const tc = data.taskCompletion || 0;
            const tu = data.toolUsage || 0;
            const au = data.autonomy || 0;
            const sf = data.safety || 0;
            const trustScore = tc + tu + au + sf;

            const logEntry = document.createElement('div');
            logEntry.className = `magi-log-entry magi-log-evaluation`;
            logEntry.dataset.juror = data.juror;

            const verdictClass = data.verdict === 'safe_pass' ? 'pass' : (data.verdict === 'unsafe_fail' ? 'fail' : 'review');

            logEntry.innerHTML = `
                <div class="magi-log-header">
                    <span class="magi-log-speaker magi-speaker-${unit}">[${getMAGISpeaker(data.juror)}]</span>
                    <span class="magi-log-badge magi-badge-${verdictClass}">${data.verdict}</span>
                </div>
                <div class="magi-log-content">
                    Score: ${trustScore}/100
                    ${data.rationale ? `<details class="magi-log-details"><summary>Ë©≥Á¥∞</summary><div class="magi-log-rationale">${data.rationale}</div></details>` : ''}
                </div>
            `;
            discussionLog.appendChild(logEntry);
            discussionLog.scrollTop = discussionLog.scrollHeight;
        }
    });

    // Consensus check handler - MAGI System
    juryStream.on('consensus_check', (data) => {
        console.log('[DEBUG] ü§ù consensus_check event handler called with data:', data);

        // Add consensus info to discussion log
        const discussionLog = document.getElementById('magi-discussion-log');
        if (discussionLog) {
            const logEntry = document.createElement('div');
            logEntry.className = 'magi-log-entry magi-log-consensus';

            const statusClass = data.consensusReached ? 'magi-badge-pass' : 'magi-badge-review';
            const statusText = data.consensusReached
                ? `‚úì ÂêàÊÑèÊàêÁ´ã: ${data.consensusVerdict} (Round ${data.round})`
                : `‚è≥ ÂêàÊÑè„Å™„Åó - „Éá„Ç£„Çπ„Ç´„ÉÉ„Ç∑„Éß„É≥Á∂ôÁ∂ö (Round ${data.round})`;

            logEntry.innerHTML = `
                <div class="magi-log-header">
                    <span class="magi-log-speaker magi-speaker-system">[MAGI SYSTEM]</span>
                    <span class="magi-log-badge ${statusClass}">${data.consensusStatus || 'consensus_check'}</span>
                </div>
                <div class="magi-log-content">${statusText}</div>
            `;
            discussionLog.appendChild(logEntry);
            discussionLog.scrollTop = discussionLog.scrollHeight;
        }
    });

    // Discussion start handler (Phase 2) - MAGI System
    juryStream.on('discussion_start', (data) => {
        console.log('[DEBUG] üí¨ discussion_start event handler called with data:', data);

        // Update phase indicator
        const phaseIndicator = document.getElementById('magi-phase-indicator');
        if (phaseIndicator) {
            phaseIndicator.textContent = 'Phase 2';
        }

        // Add discussion start entry to log
        const discussionLog = document.getElementById('magi-discussion-log');
        if (discussionLog) {
            const logEntry = document.createElement('div');
            logEntry.className = 'magi-log-entry magi-log-system';
            logEntry.innerHTML = `
                <div class="magi-log-header">
                    <span class="magi-log-speaker magi-speaker-system">[MAGI SYSTEM]</span>
                    <span class="magi-log-badge magi-badge-info">Phase 2 ÈñãÂßã</span>
                </div>
                <div class="magi-log-content">Èô™ÂØ©Âì°Èñì„ÅÆË®éË´ñ„ÇíÈñãÂßã„Åó„Åæ„Åô...</div>
            `;
            discussionLog.appendChild(logEntry);
            discussionLog.scrollTop = discussionLog.scrollHeight;
        }
    });

    // Juror statement handler - MAGI System
    juryStream.on('juror_statement', (data) => {
        console.log('[DEBUG] üó£Ô∏è juror_statement event handler called with data:', data);

        const unit = getMAGIUnit(data.juror);

        // Add statement to discussion log
        const discussionLog = document.getElementById('magi-discussion-log');
        if (discussionLog) {
            const logEntry = document.createElement('div');
            logEntry.className = 'magi-log-entry magi-log-statement';
            logEntry.dataset.juror = data.juror;

            const positionBadge = data.positionChanged
                ? '<span class="magi-log-badge magi-badge-changed">Á´ãÂ†¥Â§âÊõ¥</span>'
                : '';

            logEntry.innerHTML = `
                <div class="magi-log-header">
                    <span class="magi-log-speaker magi-speaker-${unit}">[${getMAGISpeaker(data.juror)}]</span>
                    ${positionBadge}
                </div>
                <div class="magi-log-content">${data.statement}</div>
                ${data.positionChanged ? `<div class="magi-log-footer">Êñ∞„Åó„ÅÑÂà§ÂÆö: ${data.newVerdict} (${data.newScore?.toFixed(1) || '-'})</div>` : ''}
            `;
            discussionLog.appendChild(logEntry);
            discussionLog.scrollTop = discussionLog.scrollHeight;
        }

        // Update unit vote if position changed
        if (data.positionChanged && data.newVerdict) {
            const voteEl = document.getElementById(`${unit}-vote`);
            if (voteEl) {
                const verdictMap = {
                    'safe_pass': { text: 'PASS', class: 'magi-vote-pass' },
                    'unsafe_fail': { text: 'FAIL', class: 'magi-vote-fail' },
                    'needs_review': { text: 'REVIEW', class: 'magi-vote-review' }
                };
                const v = verdictMap[data.newVerdict] || { text: data.newVerdict, class: '' };
                voteEl.textContent = v.text;
                voteEl.className = `magi-unit-vote ${v.class}`;

                // Re-trigger glow animation
                const unitEl = document.getElementById(`magi-${unit}`);
                if (unitEl) {
                    unitEl.classList.remove('vote-confirmed');
                    void unitEl.offsetWidth; // Force reflow
                    unitEl.classList.add('vote-confirmed');

                    if (data.newVerdict === 'safe_pass') {
                        unitEl.style.setProperty('--glow-color', '#51cf66');
                    } else if (data.newVerdict === 'unsafe_fail') {
                        unitEl.style.setProperty('--glow-color', '#ff6b6b');
                    } else {
                        unitEl.style.setProperty('--glow-color', '#ffd43b');
                    }
                }
            }
        }
    });

    // Round complete handler - MAGI System
    juryStream.on('round_complete', (data) => {
        console.log('[DEBUG] üîÑ round_complete event handler called with data:', data);

        // Add round complete entry to discussion log
        const discussionLog = document.getElementById('magi-discussion-log');
        if (discussionLog) {
            const logEntry = document.createElement('div');
            logEntry.className = 'magi-log-entry magi-log-system';

            const status = data.consensusReached ? '‚úì ÂêàÊÑèÊàêÁ´ã' : (data.stagnant ? '‚ö† ÂÅúÊªûÊ§úÂá∫' : 'ÈÄ≤Ë°å‰∏≠');
            const statusClass = data.consensusReached ? 'magi-badge-pass' : (data.stagnant ? 'magi-badge-review' : 'magi-badge-info');

            logEntry.innerHTML = `
                <div class="magi-log-header">
                    <span class="magi-log-speaker magi-speaker-system">[MAGI SYSTEM]</span>
                    <span class="magi-log-badge ${statusClass}">Round ${data.round || '?'} ${status}</span>
                </div>
            `;
            discussionLog.appendChild(logEntry);
            discussionLog.scrollTop = discussionLog.scrollHeight;
        }
    });

    // Final judgment handler (Phase 3) - MAGI System
    juryStream.on('final_judgment', (data) => {
        console.log('[DEBUG] ‚öñÔ∏è final_judgment event handler called with data:', data);

        // Update phase indicator
        const phaseIndicator = document.getElementById('magi-phase-indicator');
        if (phaseIndicator) {
            phaseIndicator.textContent = 'Phase 3';
        }

        // Update final decision panel
        const decisionPanel = document.getElementById('magi-final-decision');
        if (decisionPanel) {
            const resultClass = data.finalVerdict === 'safe_pass' ? 'magi-result-pass'
                : (data.finalVerdict === 'unsafe_fail' ? 'magi-result-fail' : 'magi-result-review');

            const verdictText = data.finalVerdict === 'safe_pass' ? 'ÂèØÊ±∫'
                : (data.finalVerdict === 'unsafe_fail' ? 'Âê¶Ê±∫' : 'Ë¶ÅÁ¢∫Ë™ç');

            decisionPanel.innerHTML = `
                <div class="magi-decision-result ${resultClass}">
                    <div class="magi-decision-verdict">${verdictText}</div>
                    <div class="magi-decision-score">
                        <span class="magi-score-label">Trust Score</span>
                        <span class="magi-score-value">${Math.floor(data.finalScore)}/100</span>
                    </div>
                    <div class="magi-decision-confidence">
                        ‰ø°È†ºÂ∫¶: ${Math.floor((data.confidence || 0) * 100)}%
                    </div>
                    <div class="magi-decision-method">
                        Âà§ÂÆöÊñπÊ≥ï: ${data.method || 'N/A'}
                    </div>
                    ${data.rationale ? `<div class="magi-decision-rationale"><strong>ÁêÜÁî±:</strong> ${data.rationale}</div>` : ''}
                </div>
            `;
        }

        // Add to discussion log
        const discussionLog = document.getElementById('magi-discussion-log');
        if (discussionLog) {
            const logEntry = document.createElement('div');
            logEntry.className = 'magi-log-entry magi-log-final';

            const verdictClass = data.finalVerdict === 'safe_pass' ? 'pass'
                : (data.finalVerdict === 'unsafe_fail' ? 'fail' : 'review');

            logEntry.innerHTML = `
                <div class="magi-log-header">
                    <span class="magi-log-speaker magi-speaker-system">[MAGI SYSTEM]</span>
                    <span class="magi-log-badge magi-badge-${verdictClass}">ÊúÄÁµÇÂà§ÂÆö: ${data.finalVerdict}</span>
                </div>
                <div class="magi-log-content">
                    Trust Score: ${Math.floor(data.finalScore)}/100 | ‰ø°È†ºÂ∫¶: ${Math.floor((data.confidence || 0) * 100)}%
                    ${data.rationale ? `<br><em>${data.rationale}</em>` : ''}
                </div>
            `;
            discussionLog.appendChild(logEntry);
            discussionLog.scrollTop = discussionLog.scrollHeight;
        }
    });

            // Evaluation complete handler
    juryStream.on('evaluation_complete', (data) => {
        console.log('[DEBUG] üéâ Evaluation complete - keeping real-time display visible');
        console.log('[DEBUG] Evaluation complete data:', data);

                // Keep real-time display visible instead of reloading
                // User can manually reload or navigate to see static results

                // Update status to show evaluation is complete
        const wsStatus = document.getElementById('ws-status');
        if (wsStatus) {
            wsStatus.textContent = 'Ë©ï‰æ°ÂÆå‰∫Ü';
            wsStatus.className = 'ml-auto text-xs px-2 py-1 rounded bg-blue-100 text-blue-800';
                }

                // WebSocket-only architecture - no AJAX polling needed
                // All updates come via WebSocket in real-time
        console.log('[DEBUG] Evaluation complete - WebSocket-only mode (no polling)');
            });

            // Error handler
    juryStream.on('error', (data) => {
                console.error('Jury Judge WebSocket error:', data);
        const wsStatus = document.getElementById('ws-status');
        if (wsStatus) {
            wsStatus.textContent = '„Ç®„É©„Éº';
            wsStatus.className = 'ml-auto text-xs px-2 py-1 rounded bg-red-100 text-red-800';
                }
            });

    // Submission state change handler
    juryStream.on('submission_state_change', (data) => {
        console.log('[DEBUG] üîÑ submission_state_change event:', data);

        // Update state display without full page reload
        const stateEl = document.querySelector('[data-state-display]');
        if (stateEl && data.newState) {
            stateEl.textContent = data.newState;
            console.log(`[DEBUG] ‚úÖ Updated state display to: ${data.newState}`);
        }
    });

    // Score update handler - using data-score attributes
    juryStream.on('score_update', (data) => {
        console.log('[DEBUG] üìä score_update event:', data);

        // Update scores in real-time using data-score attributes
        if (data.scores) {
            // Update trust score
            if (data.scores.trust_score !== undefined) {
                const trustScoreEl = document.querySelector('[data-score="trust"]');
                if (trustScoreEl) {
                    trustScoreEl.textContent = data.scores.trust_score;
                    console.log(`[DEBUG] ‚úÖ Updated trust score to: ${data.scores.trust_score}`);
                }
            }

            // Update judge summary breakdown
            if (data.scores.judge_summary) {
                const js = data.scores.judge_summary;
                const taskEl = document.querySelector('[data-judge-task]');
                const toolEl = document.querySelector('[data-judge-tool]');
                const autoEl = document.querySelector('[data-judge-autonomy]');
                const safetyEl = document.querySelector('[data-judge-safety]');
                if (taskEl && js.taskCompletion !== undefined) taskEl.textContent = `${js.taskCompletion}/100`;
                if (toolEl && js.tool !== undefined) toolEl.textContent = `${js.tool}/100`;
                if (autoEl && js.autonomy !== undefined) autoEl.textContent = `${js.autonomy}/100`;
                if (safetyEl && js.safety !== undefined) safetyEl.textContent = `${js.safety}/100`;
            }

        }
    });

    // Stage update handler - for progress bar and content updates
    juryStream.on('stage_update', async (data) => {
        console.log('[DEBUG] üéØ stage_update event:', data);

        if (data.stage && data.status) {
            // Update progress bar icon immediately
            const stageEl = document.querySelector(`[data-stage="${data.stage}"]`);
            if (stageEl) {
                // Remove all status classes
                stageEl.classList.remove(
                    'bg-green-100', 'border-green-500',
                    'bg-red-100', 'border-red-500',
                    'bg-yellow-100', 'border-yellow-500', 'animate-pulse',
                    'bg-gray-100', 'border-gray-300'
                );

                // Add appropriate classes based on status
                if (data.status === 'completed') {
                    stageEl.classList.add('bg-green-100', 'border-green-500');
                    console.log(`[DEBUG] ‚úÖ Stage ${data.stage} marked as completed`);
                } else if (data.status === 'failed') {
                    stageEl.classList.add('bg-red-100', 'border-red-500');
                    console.log(`[DEBUG] ‚ùå Stage ${data.stage} marked as failed`);
                } else if (data.status === 'running') {
                    stageEl.classList.add('bg-yellow-100', 'border-yellow-500', 'animate-pulse');
                    console.log(`[DEBUG] ‚è≥ Stage ${data.stage} marked as running`);
                } else {
                    stageEl.classList.add('bg-gray-100', 'border-gray-300');
                    console.log(`[DEBUG] ‚è∏Ô∏è Stage ${data.stage} marked as pending`);
                }
            }

            // Update status badge text immediately
            const statusBadge = document.querySelector(`[data-stage-status="${data.stage}"]`);
            if (statusBadge) {
                const statusText = {
                    'completed': '‚úÖ ÂÆå‰∫Ü',
                    'failed': '‚ùå Â§±Êïó',
                    'running': '‚è≥ ÂÆüË°å‰∏≠'
                };
                statusBadge.textContent = statusText[data.status] || '‚è∏Ô∏è ÂæÖÊ©ü‰∏≠';
                console.log(`[DEBUG] üìù Updated status badge for ${data.stage} to: ${statusBadge.textContent}`);
            }

            // Fetch and update full content to refresh "Automated Review Steps"
            try {
                console.log('[DEBUG] üîÑ Fetching updated content...');
                const response = await fetch(window.location.href);
                if (!response.ok) {
                    console.error('[DEBUG] ‚ùå Failed to fetch updated content:', response.status);
                    return;
                }

                const htmlText = await response.text();
                const parser = new DOMParser();
                const newDoc = parser.parseFromString(htmlText, 'text/html');
                const newContent = newDoc.getElementById('main-content');
                const currentContent = document.getElementById('main-content');

                if (newContent && currentContent) {
                    // Capture current state
                    const scrollPos = window.scrollY;
                    const openDetails = Array.from(document.querySelectorAll('details[open]'))
                        .map(el => el.id)
                        .filter(id => id);

                    // Replace content
                    currentContent.innerHTML = newContent.innerHTML;

                    // Restore state
                    openDetails.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.open = true;
                    });

                    // Restore scroll position
                    window.scrollTo(0, scrollPos);

                    console.log('[DEBUG] ‚úÖ Content updated successfully');
                }
            } catch (error) {
                console.error('[DEBUG] ‚ùå Error updating content:', error);
            }
        }
    });

    // Connect SSE client
    juryStream.connect();

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        juryStream.disconnect();
        if (jurySSE) {
            jurySSE.close();
        }
    });
})();
</script>
