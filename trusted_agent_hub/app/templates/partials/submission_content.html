<!-- Toast Container for progress notifications -->
<div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2 pointer-events-none" style="max-width: 360px;"></div>

<style>
.toast {
    background: white;
    border-radius: 0.5rem;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    padding: 1rem;
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    transform: translateX(120%);
    opacity: 0;
    transition: all 0.3s ease-out;
    pointer-events: auto;
}
.toast.show {
    transform: translateX(0);
    opacity: 1;
}
.toast.hide {
    transform: translateX(120%);
    opacity: 0;
}
.toast-success { border-left: 4px solid #22c55e; }
.toast-warning { border-left: 4px solid #eab308; }
.toast-info { border-left: 4px solid #3b82f6; }
.toast-error { border-left: 4px solid #ef4444; }
.toast-icon {
    width: 1.25rem;
    height: 1.25rem;
    flex-shrink: 0;
}
.toast-success .toast-icon { color: #22c55e; }
.toast-warning .toast-icon { color: #eab308; }
.toast-info .toast-icon { color: #3b82f6; }
.toast-error .toast-icon { color: #ef4444; }
</style>

<div class="p-6 bg-gray-50 border-b border-gray-200">
    {% if submission.card_document.translations and submission.card_document.translations|length > 0 %}
    <h1 class="text-3xl font-bold text-gray-800">{{ submission.card_document.translations[0].displayName }}</h1>
    <p class="text-gray-600">{{ submission.card_document.translations[0].shortDescription }}</p>
    {% else %}
    <h1 class="text-3xl font-bold text-gray-800">{{ submission.card_document.name or submission.agent_id }}</h1>
    <p class="text-gray-600">{{ submission.card_document.description or "No description available" }}</p>
    {% endif %}
</div>

<div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-8">
    <div>
        <h2 class="text-xl font-semibold mb-4">Submission Details</h2>
        <div class="space-y-2">
            <p><span class="font-medium">ID:</span> {{ submission.id }}</p>
            <p><span class="font-medium">Organization:</span> {{ submission.organization_meta.name }}</p>
            <p><span class="font-medium">Status:</span> {{ submission.state }}</p>
            <p><span class="font-medium">Submitted At:</span> {{ submission.created_at }}</p>
        </div>
    </div>

    <div>
        <div class="bg-blue-50 p-4 rounded-lg">
            <div class="flex items-center justify-between mb-3">
                <div>
                    <span class="text-lg font-bold">Trust Score</span>
                </div>
                <span class="text-2xl font-bold text-blue-600"><span data-score="trust">{{ submission.trust_score }}</span> / 100</span>
            </div>
            <div class="space-y-2 text-sm text-gray-700">
                {% set sec = submission.score_breakdown.security_summary or {} %}
                <div>
                    <div class="text-xs text-gray-500">Security Gate</div>
                    <div class="text-xs text-gray-400 mb-1">æœ‰å®³ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè€æ€§ãƒ†ã‚¹ãƒˆ</div>
                    <div class="font-medium leading-tight">
                        passed <span id="summary-security-passed">{{ sec.passed or 0 }}</span>/<span class="summary-security-total">{{ sec.total or 0 }}</span><br>
                        needs <span id="summary-security-needs">{{ sec.needsReview or 0 }}</span>/<span class="summary-security-total">{{ sec.total or 0 }}</span><br>
                        failed <span id="summary-security-failed">{{ sec.failed or 0 }}</span>/<span class="summary-security-total">{{ sec.total or 0 }}</span>
                    </div>
                </div>
                {% set fn = submission.score_breakdown.functional_summary or {} %}
                <div>
                    <div class="text-xs text-gray-500">Agent Card Accuracy</div>
                    <div class="text-xs text-gray-400 mb-1">ã‚«ãƒ¼ãƒ‰è¨˜è¼‰ã¨å‹•ä½œã®æ•´åˆæ€§ç¢ºèª</div>
                    <div class="font-medium leading-tight">
                        passed <span id="summary-functional-passed">{{ fn.passed_scenarios or 0 }}</span>/<span class="summary-functional-total">{{ fn.total_scenarios or 0 }}</span><br>
                        needs <span id="summary-functional-needs">{{ fn.needsReview or 0 }}</span>/<span class="summary-functional-total">{{ fn.total_scenarios or 0 }}</span><br>
                        failed <span id="summary-functional-failed">{{ fn.failed_scenarios or 0 }}</span>/<span class="summary-functional-total">{{ fn.total_scenarios or 0 }}</span>
                    </div>
                </div>
                {% if submission.score_breakdown.jury_judge and submission.score_breakdown.jury_judge.rationale %}
                <details class="text-xs bg-white border rounded p-2">
                    <summary class="font-semibold cursor-pointer text-blue-700">ğŸ“‹ Final Judge Rationale</summary>
                    <div class="mt-2 whitespace-pre-wrap text-gray-700">{{ submission.score_breakdown.jury_judge.rationale }}</div>
                </details>
                {% endif %}
            </div>
        </div>
    </div>


</div>

<div class="p-6 border-t border-gray-200">
    <h2 class="text-xl font-semibold mb-4">Review Progress</h2>
    <div id="review-progress" class="flex items-center justify-between mb-8">
        {% include 'partials/progress_bar.html' %}
    </div>
</div>

<!-- W&B Report Section -->
<!-- DEBUG: score_breakdown exists: {{ 'yes' if submission.score_breakdown else 'no' }}, wandb exists: {{ 'yes' if submission.score_breakdown and submission.score_breakdown.wandb else 'no' }} -->
{% if submission.score_breakdown and submission.score_breakdown.wandb %}
<div class="p-6 border-t border-gray-200">
    <h2 class="text-xl font-semibold mb-4">Weights & Biases Reports</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- W&B Core Card -->
        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
            <div class="flex items-center gap-2 mb-3">
                <span class="text-2xl">ğŸ“Š</span>
                <div>
            <p class="text-sm font-medium text-gray-900">W&B Core Dashboard</p>
            <p class="text-xs text-gray-500">Experiment Tracking & Metrics</p>
                </div>
            </div>
            <div class="mb-3 text-xs text-gray-500">
                <p>Run ID: <span class="font-mono">{{ submission.score_breakdown.wandb.runId }}</span></p>
                <p>Project: {{ submission.score_breakdown.wandb.project }}</p>
                <p>Entity: {{ submission.score_breakdown.wandb.entity }}</p>
            </div>
            {% set wandb_base = submission.score_breakdown.wandb.baseUrl or "https://wandb.ai" %}
            {% set wandb_run_url = submission.score_breakdown.wandb.url or (wandb_base ~ "/" ~ submission.score_breakdown.wandb.entity ~ "/" ~ submission.score_breakdown.wandb.project ~ "/runs/" ~ submission.score_breakdown.wandb.runId) %}
            <a href="{{ wandb_run_url }}" target="_blank" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded inline-flex items-center justify-center transition duration-150 ease-in-out shadow-sm w-full">
                <span>Open Core Dashboard</span>
                <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                </svg>
            </a>
        </div>

        <!-- W&B Weave Card -->
        <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
            <div class="flex items-center gap-2 mb-3">
                <span class="text-2xl">ğŸ”®</span>
                <div>
            <p class="text-sm font-medium text-gray-900">W&B Weave Traces</p>
            <p class="text-xs text-gray-500">LLM Call Observability</p>
                </div>
            </div>
            <div class="mb-3 text-xs text-gray-500">
                <p>Project: {{ submission.score_breakdown.wandb.project }}</p>
                <p>Entity: {{ submission.score_breakdown.wandb.entity }}</p>
                <p class="mt-2 text-xs">Track LLM evaluations across Jury Judge, Security Gate, and Agent Card Accuracy stages</p>
            </div>
            {% set wandb_weave_base = submission.score_breakdown.wandb.baseUrl or "https://wandb.ai" %}
            <a href="{{ wandb_weave_base }}/{{ submission.score_breakdown.wandb.entity }}/{{ submission.score_breakdown.wandb.project }}/weave" target="_blank" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded inline-flex items-center justify-center transition duration-150 ease-in-out shadow-sm w-full">
                <span>Open Weave Traces</span>
                <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                </svg>
            </a>
        </div>
    </div>
</div>
{% endif %}

<div class="p-6 border-t border-gray-200">
    <h2 class="text-xl font-semibold mb-4">Automated Review Steps</h2>
    {% if submission.score_breakdown %}
    <!-- PreCheck -->
    <details id="details-precheck" class="mb-6 bg-gray-50 p-4 rounded-lg" open>
        <summary class="text-lg font-semibold mb-2 flex items-center cursor-pointer">
            <span class="mr-2">ğŸ§¾</span> PreCheck
        </summary>
        <!-- ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ï¼ˆSSEå—ä¿¡æ™‚ã«å‹•çš„ã«æ›¸ãæ›ã‚ã‚‹ï¼‰ -->
        <div id="precheck-content" class="ml-7 space-y-2 mt-2">
        {% if submission.score_breakdown.precheck_summary %}
            <p class="text-sm text-gray-700">
                <span class="font-semibold">Status:</span>
                <span class="{% if submission.score_breakdown.precheck_summary.passed %}text-green-600{% else %}text-red-600{% endif %}">
            {{ "Passed" if submission.score_breakdown.precheck_summary.passed else "Failed" }}
                </span>
            </p>
            {% if submission.score_breakdown.precheck_summary.warnings %}
            <p class="text-sm text-yellow-600">
                <span class="font-semibold">Warnings:</span> {{ submission.score_breakdown.precheck_summary.warnings|length }}
            </p>
            <ul class="ml-4 text-xs text-yellow-600">
                {% for warning in submission.score_breakdown.precheck_summary.warnings %}
                <li>â€¢ {{ warning }}</li>
                {% endfor %}
            </ul>
            {% endif %}
            {% if submission.score_breakdown.precheck_summary.errors %}
            <p class="text-sm text-red-600">
                <span class="font-semibold">Errors:</span>
            </p>
            <ul class="ml-4 text-xs text-red-600">
                {% for error in submission.score_breakdown.precheck_summary.errors %}
                <li>â€¢ {{ error }}</li>
                {% endfor %}
            </ul>
            {% endif %}
        {% else %}
            <p class="text-sm text-gray-500">å¾…æ©Ÿä¸­...</p>
        {% endif %}
        </div>
    </details>
    <!-- Security Gate -->
    <details id="details-security" class="mb-6 bg-gray-50 p-4 rounded-lg" open>
        <summary class="text-lg font-semibold mb-2 flex items-center cursor-pointer">
            <span class="mr-2">ğŸ›¡ï¸</span> Security Gate
        </summary>
        <!-- ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ï¼ˆSSEå—ä¿¡æ™‚ã«å‹•çš„ã«æ›¸ãæ›ã‚ã‚‹ï¼‰ -->
        <div id="security-content" class="ml-7 space-y-4 mt-2">
        {% if submission.score_breakdown.security_summary %}
            <!-- Basic Counts -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-white p-3 rounded border">
            <div class="text-xs text-gray-500">Total Tests</div>
            <div class="text-2xl font-bold">{{ submission.score_breakdown.security_summary.total or 0 }}</div>
                </div>
                <div class="bg-green-50 p-3 rounded border border-green-200">
            <div class="text-xs text-gray-500">Blocked (Safe)</div>
            <div class="text-2xl font-bold text-green-600">{{ submission.score_breakdown.security_summary.blocked or 0 }}</div>
                </div>
                <div class="bg-yellow-50 p-3 rounded border border-yellow-200">
            <div class="text-xs text-gray-500">Needs Review</div>
            <div class="text-2xl font-bold text-yellow-600">{{ submission.score_breakdown.security_summary.needsReview or 0 }}</div>
                </div>
                <div class="bg-red-50 p-3 rounded border border-red-200">
            <div class="text-xs text-gray-500">Errors</div>
            <div class="text-2xl font-bold text-red-600">{{ submission.score_breakdown.security_summary.errors or 0 }}</div>
                </div>
            </div>

            <!-- Security Test Scenarios (Needs Review) -->
            {% if submission.score_breakdown.security_summary.scenarios %}
            <div class="border-t pt-4">
                <h4 class="font-semibold mb-2">âš ï¸ è¦ç¢ºèªã‚·ãƒŠãƒªã‚ªï¼ˆNeeds Review/Errorï¼‰</h4>
                {% set needs_review_scenarios = submission.score_breakdown.security_summary.scenarios | selectattr('verdict', 'defined') | selectattr('verdict', 'in', ['needs_review', 'error']) | list %}
                {% if needs_review_scenarios | length > 0 %}
                <div class="space-y-3">
            {% for scenario in needs_review_scenarios[:10] %}
            <div class="border border-yellow-300 rounded-lg p-3 bg-yellow-50">
                <div class="font-semibold text-sm mb-1">
                    {{ scenario.promptId or 'åŒ¿å' }}
                    <span class="ml-2 text-xs px-2 py-1 rounded
                        {% if scenario.verdict == 'needs_review' %}bg-yellow-100 text-yellow-800
                        {% elif scenario.verdict == 'error' %}bg-red-100 text-red-800
                        {% elif scenario.verdict == 'blocked' %}bg-green-100 text-green-800
                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                        {{ scenario.verdict }}
                    </span>
                </div>
                <div class="text-xs text-gray-600 mb-2">
                    Category: {{ scenario.category or 'N/A' }}
                    {% if scenario.perspective %}
                    | Perspective: {{ scenario.perspective }}
                    {% endif %}
                </div>
                <div class="text-xs mb-2">
                    <strong>Prompt:</strong>
                    <pre class="mt-1 whitespace-pre-wrap bg-white p-2 rounded">{{ scenario.prompt or scenario.basePrompt or 'N/A' }}</pre>
                </div>
                {% if scenario.response %}
                <div class="text-xs mb-2">
                    <strong>Response:</strong>
                    <pre class="mt-1 whitespace-pre-wrap bg-white p-2 rounded">{{ scenario.response }}</pre>
                </div>
                {% endif %}
                {% if scenario.reason %}
                <div class="text-xs text-gray-700">
                    <strong>Reason:</strong> {{ scenario.reason }}
                </div>
                {% endif %}
            </div>
            {% endfor %}
                </div>
                {% else %}
                <div class="text-sm text-gray-600">è¦ç¢ºèªé …ç›®ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>
                {% endif %}
            </div>
            <!-- All Security Scenarios Table -->
            <div class="border-t pt-4">
                <h4 class="font-semibold mb-2">ğŸ“ å…¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆä¸€è¦§</h4>
                <div class="mb-3">
            <label class="text-xs">
                ãƒ•ã‚£ãƒ«ã‚¿:
                <select id="securityVerdictFilter" class="ml-2 text-xs border rounded px-2 py-1" onchange="filterSecurityScenarios()">
                    <option value="all">å…¨ä»¶</option>
                    <option value="blocked">Blocked</option>
                    <option value="needs_review">Needs Review</option>
                    <option value="error">Error</option>
                    <option value="not_executed">Not Executed</option>
                </select>
            </label>
                </div>
                <div class="max-h-80 overflow-auto border rounded">
            <table class="w-full text-xs border-collapse">
                <thead class="bg-gray-100 sticky top-0">
                    <tr>
                        <th class="text-left p-2 border-b">Prompt ID</th>
                        <th class="text-left p-2 border-b">Prompt</th>
                        <th class="text-left p-2 border-b">Response</th>
                        <th class="text-left p-2 border-b">Verdict</th>
                    </tr>
                </thead>
                <tbody id="securityScenariosTableBody">
                    {% for scenario in submission.score_breakdown.security_summary.scenarios %}
                    {% if scenario.verdict %}
                    <tr class="border-b security-scenario-row" data-verdict="{{ scenario.verdict }}">
                        <td class="p-2">
                            {{ scenario.promptId or 'IDãªã—' }}
                        </td>
                        <td class="p-2">
                            <pre class="whitespace-pre-wrap text-xs">{{ (scenario.prompt or scenario.basePrompt or '(æœªè¨­å®š)')[:100] }}...</pre>
                        </td>
                        <td class="p-2">
                            <pre class="whitespace-pre-wrap text-xs">{{ (scenario.response or '(å¿œç­”ãªã—)')[:100] }}...</pre>
                        </td>
                        <td class="p-2">
                            <span class="px-2 py-1 rounded text-xs
                                {% if scenario.verdict == 'blocked' %}bg-green-100 text-green-800
                                {% elif scenario.verdict == 'needs_review' %}bg-yellow-100 text-yellow-800
                                {% elif scenario.verdict == 'error' %}bg-red-100 text-red-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ scenario.verdict }}
                            </span>
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
                </div>
            </div>
            {% endif %}
            <!-- Confirmation Points -->
            <div class="border-t pt-4">
                <h4 class="font-semibold mb-2">ğŸ“‹ ç¢ºèªãƒã‚¤ãƒ³ãƒˆ</h4>
                <ul class="text-sm space-y-1 list-disc ml-5">
            <li><strong>Blocked (Safe)</strong>: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ”»æ’ƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’é©åˆ‡ã«ãƒ–ãƒ­ãƒƒã‚¯ã—ãŸã‚±ãƒ¼ã‚¹</li>
            <li><strong>Needs Review</strong>: äººæ‰‹ç¢ºèªãŒå¿…è¦ãªã‚±ãƒ¼ã‚¹ã€‚ã€Œè¦ç¢ºèªã‚·ãƒŠãƒªã‚ªã€ã§è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„</li>
            <li>å…¨ä½“ã®ãƒ–ãƒ­ãƒƒã‚¯ç‡ (Blocked/Total) ãŒé«˜ã„ã»ã©ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ãŒæœ‰åŠ¹ã§ã™</li>
                </ul>
            </div>

            <!-- Artifacts -->
            {% if submission.score_breakdown.security_summary.artifacts %}
            <div class="border-t pt-4">
                <h4 class="font-semibold mb-2">ğŸ“ Artifacts</h4>
                <div class="space-y-2">
            {% if submission.score_breakdown.security_summary.artifacts.prompts %}
            <div class="text-sm">
                <span class="font-medium">Prompts:</span>
                <code class="text-xs bg-gray-100 px-2 py-1 rounded">{{ submission.score_breakdown.security_summary.artifacts.prompts }}</code>
            </div>
            {% endif %}
            {% if submission.score_breakdown.security_summary.artifacts.report %}
            <div class="text-sm">
                <span class="font-medium">Report:</span>
                <code class="text-xs bg-gray-100 px-2 py-1 rounded">{{ submission.score_breakdown.security_summary.artifacts.report }}</code>
            </div>
            {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
        {% else %}
        <p class="ml-7 text-sm text-gray-500">No security test results available</p>
        {% endif %}
    </details>
    <!-- Agent Card Accuracy -->
    <details id="details-agent-card-accuracy" class="mb-6 bg-gray-50 p-4 rounded-lg" open>
        <summary class="text-lg font-semibold mb-2 flex items-center cursor-pointer">
            <span class="mr-2">ğŸ“‹</span> Agent Card Accuracy
        </summary>
        <!-- ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ï¼ˆSSEå—ä¿¡æ™‚ã«å‹•çš„ã«æ›¸ãæ›ã‚ã‚‹ï¼‰ -->
        <div id="agent-card-accuracy-content" class="ml-7 space-y-4 mt-2">
        {% if submission.score_breakdown.functional_summary %}
            <!-- Basic Counts -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-white p-3 rounded border">
            <div class="text-xs text-gray-500">Total Scenarios</div>
            <div class="text-2xl font-bold">{{ submission.score_breakdown.functional_summary.total_scenarios or 0 }}</div>
                </div>
                <div class="bg-green-50 p-3 rounded border border-green-200">
            <div class="text-xs text-gray-500">Passed</div>
            <div class="text-2xl font-bold text-green-600">{{ submission.score_breakdown.functional_summary.passed_scenarios or 0 }}</div>
                </div>
                <div class="bg-yellow-50 p-3 rounded border border-yellow-200">
            <div class="text-xs text-gray-500">Needs Review</div>
            <div class="text-2xl font-bold text-yellow-600">{{ submission.score_breakdown.functional_summary.needsReview or 0 }}</div>
                </div>
                <div class="bg-red-50 p-3 rounded border border-red-200">
            <div class="text-xs text-gray-500">Errors</div>
            <div class="text-2xl font-bold text-red-600">{{ submission.score_breakdown.functional_summary.responsesWithError or 0 }}</div>
                </div>
            </div>


            <!-- Failed Scenarios with Multi-turn Dialogue -->
            {% if submission.score_breakdown.functional_summary.scenarios %}
            <div class="border-t pt-4">
                <h4 class="font-semibold mb-2">âŒ å¤±æ•—ã‚·ãƒŠãƒªã‚ªã®è©³ç´°</h4>
                {% set failed_scenarios = submission.score_breakdown.functional_summary.scenarios | selectattr('evaluation.verdict', 'defined') | selectattr('evaluation.verdict', 'ne', 'pass') | list %}
                {% if failed_scenarios | length > 0 %}
                <div class="text-xs text-gray-500 mb-2">{{ failed_scenarios | length }}ä»¶ã®å¤±æ•—ã‚·ãƒŠãƒªã‚ª</div>
                <div class="space-y-3" id="failed-scenarios-container">
            {% for scenario in (failed_scenarios | sort(attribute='evaluation.distance', reverse=true)) %}
            <div class="border border-gray-300 rounded-lg p-3 bg-white failed-scenario-item" {% if loop.index > 10 %}style="display:none"{% endif %} data-index="{{ loop.index }}">
                <div class="font-semibold text-sm mb-1">
                    {{ scenario.scenarioId or 'åŒ¿å' }}
                    <span class="ml-2 text-xs px-2 py-1 rounded
                        {% if scenario.evaluation.verdict == 'fail' %}bg-red-100 text-red-800
                        {% elif scenario.evaluation.verdict == 'needs_review' %}bg-yellow-100 text-yellow-800
                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                        {{ scenario.evaluation.verdict }}
                    </span>
                </div>
                <div class="text-xs text-gray-600 mb-2">
                    Distance: {{ "%.4f"|format(scenario.evaluation.distance) if scenario.evaluation.distance is not none else '-' }}
                    {% if scenario.evaluation.get('topic_relevance') is not none %}
                    | Topic Relevance: {{ 'âœ“' if scenario.evaluation.topic_relevance else 'âœ—' }}
                    {% endif %}
                    {% if scenario.evaluation.get('dialogue_progress') is not none %}
                    | Dialogue Progress: {{ 'âœ“' if scenario.evaluation.dialogue_progress else 'âœ—' }}
                    {% endif %}
                    {% if scenario.evaluation.get('total_turns') %}
                    | Turns: {{ scenario.evaluation.total_turns }}
                    {% endif %}
                </div>

                <!-- Multi-turn Dialogue History -->
                {% if scenario.evaluation.dialogue_history %}
                <div class="text-xs mb-2 border-l-4 border-purple-400 pl-3">
                    <strong class="text-purple-700">ğŸ’¬ å¯¾è©±å±¥æ­´ ({{ scenario.evaluation.total_turns }} turns):</strong>
                    <div class="space-y-2 mt-2">
                        {% for turn in scenario.evaluation.dialogue_history %}
                        <div class="bg-white p-2 rounded border">
                            <div class="font-semibold text-purple-600 mb-1">Turn {{ turn.turn }}</div>
                            <div class="mb-1">
                                <span class="font-medium text-gray-700">User:</span>
                                <pre class="mt-0.5 whitespace-pre-wrap bg-blue-50 p-1.5 rounded text-xs">{{ turn.user }}</pre>
                            </div>
                            <div>
                                <span class="font-medium text-gray-700">Agent:</span>
                                <pre class="mt-0.5 whitespace-pre-wrap bg-green-50 p-1.5 rounded text-xs">{{ turn.agent }}</pre>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% else %}
                <!-- Single-turn display -->
                <div class="text-xs mb-2">
                    <strong>Prompt:</strong>
                    <pre class="mt-1 whitespace-pre-wrap bg-gray-50 p-2 rounded">{{ scenario.prompt or scenario.output or 'N/A' }}</pre>
                </div>
                <div class="text-xs mb-2">
                    <strong>Response:</strong>
                    {% if scenario.responseStatus == 'error' and scenario.responseError %}
                    <pre class="mt-1 whitespace-pre-wrap bg-red-50 p-2 rounded text-red-700">[ã‚¨ãƒ©ãƒ¼] {{ scenario.responseError }}</pre>
                    {% else %}
                    <pre class="mt-1 whitespace-pre-wrap bg-gray-50 p-2 rounded">{{ scenario.response or '(å¿œç­”ãªã—)' }}</pre>
                    {% endif %}
                </div>
                {% endif %}

                <div class="text-xs mb-2">
                    <strong>Expected:</strong>
                    <pre class="mt-1 whitespace-pre-wrap bg-gray-50 p-2 rounded">{{ scenario.expected or 'N/A' }}</pre>
                </div>

                <!-- Multi-turn Quality Metrics -->
                {% if scenario.evaluation.task_completion is not none %}
                <div class="text-xs mb-2 bg-purple-50 p-2 rounded border border-purple-200">
                    <strong class="text-purple-700">ãƒãƒ«ãƒã‚¿ãƒ¼ãƒ³å“è³ªæŒ‡æ¨™:</strong>
                    <div class="grid grid-cols-3 gap-2 mt-1">
                        <div>
                            <span class="text-gray-600">Task Completion:</span>
                            <span class="font-medium">{{ "%.2f"|format(scenario.evaluation.task_completion) }}</span>
                        </div>
                        {% if scenario.evaluation.dialogue_naturalness is not none %}
                        <div>
                            <span class="text-gray-600">Naturalness:</span>
                            <span class="font-medium">{{ "%.2f"|format(scenario.evaluation.dialogue_naturalness) }}</span>
                        </div>
                        {% endif %}
                        {% if scenario.evaluation.information_gathering is not none %}
                        <div>
                            <span class="text-gray-600">Info Gathering:</span>
                            <span class="font-medium">{{ "%.2f"|format(scenario.evaluation.information_gathering) }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                {% if scenario.evaluation.errors and scenario.evaluation.errors | length > 0 %}
                <div class="text-xs mb-2 text-red-600">
                    <strong>Errors:</strong> {{ scenario.evaluation.errors | join(', ') }}
                </div>
                {% endif %}
                {% if scenario.evaluation.rationale %}
                <div class="text-xs text-gray-700">
                    <strong>Rationale:</strong> {{ scenario.evaluation.rationale }}
                </div>
                {% endif %}
            </div>
            {% endfor %}
                </div>
                {% if failed_scenarios | length > 10 %}
                <button id="loadMoreFailedBtn" onclick="loadMoreFailedScenarios()" class="mt-3 px-4 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded border">
                    ã‚‚ã£ã¨è¦‹ã‚‹ (<span id="failedRemainingCount">{{ failed_scenarios | length - 10 }}</span>ä»¶)
                </button>
                {% endif %}
                {% else %}
                <div class="text-sm text-gray-600">ä»Šã®ã¨ã“ã‚å¤±æ•—åˆ¤å®šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>
                {% endif %}
            </div>
            <!-- Prompts/Responses Table -->
            <div class="border-t pt-4">
                <h4 class="font-semibold mb-2">ğŸ“ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ/å¿œç­”ä¸€è¦§</h4>
                <div class="mb-3">
            <label class="text-xs">
                ãƒ•ã‚£ãƒ«ã‚¿:
                <select id="verdictFilter" class="ml-2 text-xs border rounded px-2 py-1" onchange="filterScenarios()">
                    <option value="all">å…¨ä»¶</option>
                    <option value="pass">Pass</option>
                    <option value="needs_review">Needs Review</option>
                    <option value="fail">Fail</option>
                </select>
            </label>
                </div>
                <div class="max-h-80 overflow-auto border rounded">
            <table class="w-full text-xs border-collapse">
                <thead class="bg-gray-100 sticky top-0">
                    <tr>
                        <th class="text-left p-2 border-b">ã‚·ãƒŠãƒªã‚ª</th>
                        <th class="text-left p-2 border-b">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</th>
                        <th class="text-left p-2 border-b">å¿œç­”</th>
                        <th class="text-left p-2 border-b">åˆ¤å®š</th>
                    </tr>
                </thead>
                <tbody id="scenariosTableBody">
                    {% for scenario in submission.score_breakdown.functional_summary.scenarios %}
                    {% if scenario.evaluation and scenario.evaluation.verdict %}
                    <tr class="border-b scenario-row" data-verdict="{{ scenario.evaluation.verdict }}" data-index="{{ loop.index }}" {% if loop.index > 10 %}style="display:none"{% endif %}>
                        <td class="p-2">
                            {{ scenario.scenarioId or 'IDãªã—' }}
                            {% if scenario.scenarioId and 'advbench' in scenario.scenarioId.lower() %}
                            <span class="text-xs text-gray-500 ml-1">[AdvBench]</span>
                            {% endif %}
                        </td>
                        <td class="p-2">
                            <pre class="whitespace-pre-wrap text-xs">{{ scenario.prompt or '(æœªè¨­å®š)' }}</pre>
                        </td>
                        <td class="p-2">
                            <pre class="whitespace-pre-wrap text-xs">{{ scenario.response or '(å¿œç­”ãªã—)' }}</pre>
                        </td>
                        <td class="p-2">
                            <span class="px-2 py-1 rounded text-xs
                                {% if scenario.evaluation.verdict == 'pass' %}bg-green-100 text-green-800
                                {% elif scenario.evaluation.verdict == 'needs_review' %}bg-yellow-100 text-yellow-800
                                {% elif scenario.evaluation.verdict == 'fail' %}bg-red-100 text-red-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ scenario.evaluation.verdict }}
                            </span>
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
                </div>
                {% if submission.score_breakdown.functional_summary.scenarios | length > 10 %}
                <button id="loadMoreScenariosBtn" onclick="loadMoreScenarios()" class="mt-3 px-4 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded border">
                    ã‚‚ã£ã¨è¦‹ã‚‹ (<span id="scenariosRemainingCount">{{ submission.score_breakdown.functional_summary.scenarios | length - 10 }}</span>ä»¶)
                </button>
                {% endif %}
            </div>
            {% endif %}
            <!-- Confirmation Points -->
            <div class="border-t pt-4">
                <h4 class="font-semibold mb-2">ğŸ“‹ ç¢ºèªãƒã‚¤ãƒ³ãƒˆ</h4>
                <ul class="text-sm space-y-1 list-disc ml-5">
                    <li>Pass: ã‚·ãƒŠãƒªã‚ªã®æœŸå¾…ã«æ²¿ã£ãŸå¿œç­”ãŒã§ããŸã‚±ãƒ¼ã‚¹</li>
                    <li>Needs Review: äººæ‰‹ç¢ºèªãŒå¿…è¦ãªã‚±ãƒ¼ã‚¹ã€‚å¿œç­”å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„</li>
                    <li>Fail: æœŸå¾…ã¨ç•°ãªã‚‹å¿œç­”ã‚’ã—ãŸã‚±ãƒ¼ã‚¹ã€‚æ”¹å–„ãŒå¿…è¦ã§ã™</li>
                    <li>å…¨ä½“ã®Passç‡ (Pass/Total) ãŒé«˜ã„ã»ã©Agent Cardã®ç²¾åº¦ãŒé«˜ã„ã§ã™</li>
                </ul>
            </div>

            <!-- Artifacts -->
            {% if submission.score_breakdown.functional_summary.artifacts %}
            <div class="border-t pt-4">
                <h4 class="font-semibold mb-2">ğŸ“ Artifacts</h4>
                <div class="space-y-2">
            {% if submission.score_breakdown.functional_summary.artifacts.report %}
            <div class="text-sm">
                <span class="font-medium">Report (JSONL):</span>
                <code class="text-xs bg-gray-100 px-2 py-1 rounded">{{ submission.score_breakdown.functional_summary.artifacts.report }}</code>
            </div>
            {% endif %}
            {% if submission.score_breakdown.functional_summary.artifacts.prompts %}
            <div class="text-sm">
                <span class="font-medium">Prompts:</span>
                <code class="text-xs bg-gray-100 px-2 py-1 rounded">{{ submission.score_breakdown.functional_summary.artifacts.prompts }}</code>
            </div>
            {% endif %}
                </div>
            </div>
            {% endif %}
        {% else %}
        <p class="text-sm text-gray-500">å¾…æ©Ÿä¸­...</p>
        {% endif %}
        </div>
    </details>
    {% include 'partials/magi_system.html' with context %}

        {% if submission.state != 'judge_panel_running' and not submission.score_breakdown.judge_summary %}
        <p class="p-4 text-sm text-gray-400 text-center">No judge panel results available</p>
        {% endif %}
    </details>
    <!-- Publish -->
    <details id="details-publish" class="mb-6 bg-gray-50 p-4 rounded-lg">
        <summary class="text-lg font-semibold mb-2 flex items-center cursor-pointer">
            <span class="mr-2">ğŸš€</span> Publish
        </summary>
        {% if submission.score_breakdown.publish_summary %}
        <div class="ml-7 space-y-2 mt-2">
            <p class="text-sm text-gray-700">
                <span class="font-semibold">Status:</span>
                <span class="{% if submission.score_breakdown.publish_summary.status == 'published' %}text-green-600{% else %}text-yellow-600{% endif %}">
            {{ submission.score_breakdown.publish_summary.status }}
                </span>
            </p>
            {% if submission.score_breakdown.publish_summary.publishedAt %}
            <p class="text-sm text-gray-700">
                <span class="font-semibold">Published At:</span> {{ submission.score_breakdown.publish_summary.publishedAt }}
            </p>
            {% endif %}
            <p class="text-sm text-gray-700">
                <span class="font-semibold">Trust Score:</span> {{ submission.score_breakdown.publish_summary.trustScore }}/100
            </p>
        </div>
        {% else %}
        <p class="ml-7 text-sm text-gray-500">Not yet published</p>
        {% endif %}
    </details>
    {% else %}
    <!-- è©•ä¾¡æœªé–‹å§‹æ™‚ã‚‚ç©ºã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤ºï¼ˆSSEã§å‹•çš„ã«æ›´æ–°ã•ã‚Œã‚‹ï¼‰ -->
    <!-- PreCheck -->
    <details id="details-precheck" class="mb-6 bg-gray-50 p-4 rounded-lg">
        <summary class="text-lg font-semibold mb-2 flex items-center cursor-pointer">
            <span class="mr-2">ğŸ§¾</span> PreCheck
        </summary>
        <div id="precheck-content" class="ml-7 space-y-2 mt-2">
            <p class="text-sm text-gray-400">Waiting for evaluation...</p>
        </div>
    </details>

    <!-- Security Gate -->
    <details id="details-security" class="mb-6 bg-gray-50 p-4 rounded-lg">
        <summary class="text-lg font-semibold mb-2 flex items-center cursor-pointer">
            <span class="mr-2">ğŸ›¡ï¸</span> Security Gate
        </summary>
        <div id="security-content" class="ml-7 space-y-2 mt-2">
            <p class="text-sm text-gray-400">Waiting for evaluation...</p>
        </div>
    </details>

    <!-- Agent Card Accuracy -->
    <details id="details-functional" class="mb-6 bg-gray-50 p-4 rounded-lg">
        <summary class="text-lg font-semibold mb-2 flex items-center cursor-pointer">
            <span class="mr-2">ğŸ§ª</span> Agent Card Accuracy
        </summary>
        <div id="functional-content" class="ml-7 space-y-2 mt-2">
            <p class="text-sm text-gray-400">Waiting for evaluation...</p>
        </div>
    </details>

    {% set show_waiting_state = true %}
    {% include 'partials/magi_system.html' with context %}

    <!-- Human Review -->
    <details id="details-human-review" class="mb-6 bg-gray-50 p-4 rounded-lg">
        <summary class="text-lg font-semibold mb-2 flex items-center cursor-pointer">
            <span class="mr-2">ğŸ™‹</span> Human Review
        </summary>
        <div id="human-review-content" class="ml-7 space-y-2 mt-2">
            <p class="text-sm text-gray-400">Waiting for automated review to complete...</p>
        </div>
    </details>

    <!-- Publish -->
    <details id="details-publish" class="mb-6 bg-gray-50 p-4 rounded-lg">
        <summary class="text-lg font-semibold mb-2 flex items-center cursor-pointer">
            <span class="mr-2">ğŸš€</span> Publish
        </summary>
        <div id="publish-content" class="ml-7 space-y-2 mt-2">
            <p class="text-sm text-gray-400">Not yet published</p>
        </div>
    </details>
    {% endif %}
</div>

<script src="/static/judge-stream.js"></script>
<script>
    // ==== Toast Notification System ====
    function showToast(message, type = 'info', duration = 4000) {
        const container = document.getElementById('toast-container');
        if (!container) return;

        const icons = {
            success: '<svg class="toast-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>',
            warning: '<svg class="toast-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>',
            info: '<svg class="toast-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
            error: '<svg class="toast-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>'
        };

        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `
            ${icons[type] || icons.info}
            <div style="flex: 1;">
                <p style="font-size: 0.875rem; font-weight: 500; color: #111827; margin: 0;">${message}</p>
            </div>
            <button onclick="this.parentElement.classList.add('hide'); setTimeout(() => this.parentElement.remove(), 300);" style="color: #9ca3af; background: none; border: none; cursor: pointer; font-size: 1.25rem; line-height: 1;">&times;</button>
        `;
        container.appendChild(toast);

        // Trigger animation
        requestAnimationFrame(() => {
            toast.classList.add('show');
        });

        // Auto-remove after duration
        setTimeout(() => {
            toast.classList.remove('show');
            toast.classList.add('hide');
            setTimeout(() => toast.remove(), 300);
        }, duration);
    }

    // Track previous verdicts for stance change detection
    const previousVerdicts = {};
    // Store juror evaluation data for batch update at final_judgment
    const pendingJurorResults = {};

    // Initialize Jury Judge SSE client for real-time updates
    (function() {
        const submissionId = '{{ submission.id }}';
        const judgeState = '{{ submission.state }}';
        const urlPrefix = '{{ url_prefix }}' || '';

        console.log('[DEBUG] Initializing Jury Judge stream client');
        console.log('[DEBUG] Submission ID:', submissionId);
        console.log('[DEBUG] Judge State:', judgeState);

        const juryStream = new JuryJudgeStream(submissionId, { basePath: urlPrefix });
        console.log('[DEBUG] JuryJudgeStream instance created:', juryStream);

        // MCTSè¤‡æ•°ãƒ­ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆæ™‚ã®é‡è¤‡é˜²æ­¢ãƒ•ãƒ©ã‚°
        let finalJudgmentReceived = false;

    // ==== Typing Animation System for Streaming-like Display ====

    /**
     * ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã§ãƒ†ã‚­ã‚¹ãƒˆã‚’è¡¨ç¤º
     * @param {HTMLElement} container - è¡¨ç¤ºå…ˆã®è¦ç´ 
     * @param {string} text - è¡¨ç¤ºã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆ
     * @param {number} speed - 1æ–‡å­—ã‚ãŸã‚Šã®msï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 15msï¼‰
     * @returns {Promise} ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†æ™‚ã«resolve
     */
    function typeText(container, text, speed = 15) {
        return new Promise((resolve) => {
            // Guard: ç©ºã¾ãŸã¯undefinedã®å ´åˆã¯å³åº§ã«å®Œäº†
            if (!text || text.length === 0) {
                resolve();
                return;
            }

            container.classList.add('typing');
            const scrollContainer = container.closest('.magi-chat-log');
            let i = 0;

            // requestAnimationFrameãƒ™ãƒ¼ã‚¹ã®å®Ÿè£…ï¼ˆsetIntervalã‚ˆã‚Šä¿¡é ¼æ€§ãŒé«˜ã„ï¼‰
            let lastTime = 0;
            function animate(currentTime) {
                if (!lastTime) lastTime = currentTime;
                const elapsed = currentTime - lastTime;

                // speed msçµŒéã™ã‚‹ã”ã¨ã«1æ–‡å­—è¿½åŠ 
                if (elapsed >= speed) {
                    if (i < text.length) {
                        container.textContent += text[i];
                        i++;
                        lastTime = currentTime;

                        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ€ä¸‹éƒ¨ã«ç¶­æŒ
                        if (scrollContainer) {
                            scrollContainer.scrollTop = scrollContainer.scrollHeight;
                        }
                    }
                }

                if (i < text.length) {
                    requestAnimationFrame(animate);
                } else {
                    container.classList.remove('typing');
                    resolve();
                }
            }

            requestAnimationFrame(animate);
        });
    }

    // å„ãƒ‘ãƒãƒ«ç”¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚­ãƒ¥ãƒ¼
    const messageQueues = {
        balthasar: [],
        casper: [],
        melchior: []
    };

    // å„ãƒ‘ãƒãƒ«ã®å‡¦ç†ä¸­ãƒ•ãƒ©ã‚°
    const isProcessing = {
        balthasar: false,
        casper: false,
        melchior: false
    };

    /**
     * ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ã—ã€å‡¦ç†ã‚’é–‹å§‹
     */
    function queueMessage(unit, message, options = {}) {
        console.log(`[TypeAnimation] ğŸ“¥ queueMessage called for ${unit}, queue length before: ${messageQueues[unit].length}, isProcessing: ${isProcessing[unit]}`);
        console.log(`[TypeAnimation] ğŸ“¥ Message preview: "${(message || '').substring(0, 50)}..."`);
        messageQueues[unit].push({ message, options });
        if (!isProcessing[unit]) {
            console.log(`[TypeAnimation] ğŸš€ Starting processQueue for ${unit}`);
            processQueue(unit);
        } else {
            console.log(`[TypeAnimation] â³ ${unit} is already processing, message added to queue`);
        }
    }

    /**
     * ã‚­ãƒ¥ãƒ¼ã‚’é †æ¬¡å‡¦ç†
     */
    async function processQueue(unit) {
        console.log(`[TypeAnimation] ğŸ”„ processQueue started for ${unit}`);
        isProcessing[unit] = true;
        while (messageQueues[unit].length > 0) {
            const { message, options } = messageQueues[unit].shift();
            console.log(`[TypeAnimation] âœï¸ Processing message for ${unit}, remaining in queue: ${messageQueues[unit].length}`);
            await displayMessageWithTyping(unit, message, options);
            console.log(`[TypeAnimation] âœ… Finished typing for ${unit}`);
        }
        isProcessing[unit] = false;
        console.log(`[TypeAnimation] ğŸ processQueue finished for ${unit}`);
    }

    /**
     * ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…±é€šè­°è«–ãƒ­ã‚°ã«è¡¨ç¤º
     */
    async function displayMessageWithTyping(unit, message, options = {}) {
        const discussionLog = document.getElementById('magi-discussion-content');
        if (!discussionLog) return;

        // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼å‰Šé™¤
        const placeholder = discussionLog.querySelector('.magi-discussion-placeholder');
        if (placeholder) placeholder.remove();

        // ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼åãƒãƒƒãƒ”ãƒ³ã‚°
        const speakerMap = {
            'balthasar': 'BALTHASAR-2',
            'casper': 'CASPER-3',
            'melchior': 'MELCHIOR-1'
        };

        // ã‚¨ãƒ³ãƒˆãƒªä½œæˆ
        const chatEntry = document.createElement('div');
        chatEntry.className = `magi-discussion-entry magi-speaker-${unit}${options.positionChanged ? ' magi-discussion-changed' : ''}`;

        // ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã‚¿ã‚°ã‚’å…ˆã«è¿½åŠ 
        const speakerTag = document.createElement('span');
        speakerTag.className = 'magi-speaker-tag';
        speakerTag.textContent = `[${speakerMap[unit]}] `;
        chatEntry.appendChild(speakerTag);

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”¨ã®span
        const messageSpan = document.createElement('span');
        chatEntry.appendChild(messageSpan);

        discussionLog.appendChild(chatEntry);

        // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆçœç•¥ãªã—ã§å…¨æ–‡è¡¨ç¤ºï¼‰
        await typeText(messageSpan, message, 15);  // 15ms/æ–‡å­—

        discussionLog.scrollTop = discussionLog.scrollHeight;

        // æŠ•ç¥¨å¤‰æ›´ãŒã‚ã‚Œã°æ›´æ–°
        if (options.positionChanged && options.newVerdict) {
            updateVoteForUnit(unit, options.newVerdict);
        }
    }

    /**
     * æŠ•ç¥¨çŠ¶æ…‹ã‚’æ›´æ–°ï¼ˆã‚¿ã‚¤ãƒ”ãƒ³ã‚°å®Œäº†å¾Œï¼‰
     */
    function updateVoteForUnit(unit, newVerdict) {
        const voteEl = document.getElementById(`${unit}-vote`);
        if (voteEl) {
            const verdictMap = {
                'safe_pass': { text: 'PASS', class: 'magi-vote-pass' },
                'unsafe_fail': { text: 'FAIL', class: 'magi-vote-fail' },
                'needs_review': { text: 'REVIEW', class: 'magi-vote-review' }
            };
            const v = verdictMap[newVerdict] || { text: newVerdict, class: '' };
            voteEl.textContent = v.text;
            voteEl.className = `magi-unit-vote ${v.class}`;

            // Re-trigger glow animation
            const unitEl = document.getElementById(`magi-${unit}`);
            if (unitEl) {
                unitEl.classList.remove('vote-confirmed');
                void unitEl.offsetWidth; // Force reflow
                unitEl.classList.add('vote-confirmed');

                if (newVerdict === 'safe_pass') {
                    unitEl.style.setProperty('--glow-color', '#51cf66');
                } else if (newVerdict === 'unsafe_fail') {
                    unitEl.style.setProperty('--glow-color', '#ff6b6b');
                } else {
                    unitEl.style.setProperty('--glow-color', '#ffd43b');
                }
            }
        }
    }

    // ==== End of Typing Animation System ====

    // Initialize SSE (primary path for real-time streaming)
    let jurySSE = null;
    function connectSSE() {
        const base = window.location.origin.replace(/\/$/, '');
        const sseUrl = `${base}${urlPrefix}/sse/submissions/${submissionId}/judge`;
        console.log('[DEBUG] Attempting SSE connection:', sseUrl);
        try {
            jurySSE = new EventSource(sseUrl, { withCredentials: false });

            jurySSE.onopen = () => {
                console.log('[DEBUG] ğŸŸ¢ SSE connected');
                const wsStatus = document.getElementById('ws-status');
                if (wsStatus) {
                    wsStatus.textContent = 'æ¥ç¶šæ¸ˆã¿ (SSE)';
                    wsStatus.className = 'ml-auto text-xs px-2 py-1 rounded bg-green-100 text-green-800';
                }
            };

            jurySSE.onmessage = (event) => {
                if (!event?.data) return;
                // Reuse existing handler pipeline
                juryStream.handleMessage({ data: event.data });
            };

            jurySSE.addEventListener('ping', () => {
                // Heartbeat; no-op
            });

            jurySSE.onerror = (err) => {
                console.error('[DEBUG] SSE error:', err);
                const wsStatus = document.getElementById('ws-status');
                if (wsStatus) {
                    wsStatus.textContent = 'å†æ¥ç¶šä¸­ (SSE)';
                    wsStatus.className = 'ml-auto text-xs px-2 py-1 rounded bg-yellow-100 text-yellow-800';
                }
                // Browser auto-reconnects EventSource; no manual reconnect needed
            };
        } catch (e) {
            console.error('[DEBUG] SSE init failed:', e);
        }
    }

    // ==== Section Streaming Renderer for PreCheck/Security/Functional ====

    /**
     * ã‚»ã‚¯ã‚·ãƒ§ãƒ³å…¨ä½“ã‚’ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°è¡¨ç¤ºã™ã‚‹ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼
     * - ãƒ©ãƒ™ãƒ«ã‚‚å€¤ã‚‚å…¨ã¦1æ–‡å­—ãšã¤ã‚¿ã‚¤ãƒ”ãƒ³ã‚°
     * - HTMLã‚¿ã‚°ã¯å³åº§ã«é©ç”¨ã€ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ã‚¿ã‚¤ãƒ”ãƒ³ã‚°
     */
    class SectionStreamRenderer {
        constructor(containerSelector, options = {}) {
            this.container = document.querySelector(containerSelector);
            this.speed = options.speed || 15; // ms per character
            this.queue = [];
            this.isTyping = false;
        }

        // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’é–‹ã„ã¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        openSection() {
            const details = this.container?.closest('details');
            if (details && !details.open) {
                details.open = true;
            }
            details?.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚¯ãƒªã‚¢
        clear() {
            if (this.container) {
                this.container.innerHTML = '';
            }
            // ã‚­ãƒ¥ãƒ¼ã‚‚ç©ºã«ã™ã‚‹
            this.queue = [];
        }

        // å³æ™‚è¡¨ç¤ºï¼ˆã‚¿ã‚¤ãƒ”ãƒ³ã‚°ãªã—ï¼‰
        setContent(html) {
            if (this.container) {
                this.container.innerHTML = html;
            }
        }

        // ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ã—ã¦ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°è¡¨ç¤º
        async streamLine(html, options = {}) {
            return new Promise(resolve => {
                this.queue.push({ html, options, resolve });
                this.processQueue();
            });
        }

        async processQueue() {
            if (this.isTyping || this.queue.length === 0) return;
            this.isTyping = true;

            const { html, options, resolve } = this.queue.shift();
            await this.renderWithTyping(html, options);
            resolve();

            this.isTyping = false;
            this.processQueue();
        }

        // HTMLã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦ãƒ†ã‚­ã‚¹ãƒˆéƒ¨åˆ†ã®ã¿ã‚¿ã‚¤ãƒ”ãƒ³ã‚°
        async renderWithTyping(html, options = {}) {
            const wrapper = document.createElement('div');
            wrapper.className = options.className || '';

            // HTMLã‚’ãƒ‘ãƒ¼ã‚¹
            const template = document.createElement('template');
            template.innerHTML = html;

            // ã‚³ãƒ³ãƒ†ãƒŠã«è¿½åŠ 
            this.container.appendChild(wrapper);

            // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã§è¡¨ç¤º
            await this.typeHTML(wrapper, template.content, options.speed || this.speed);
        }

        // HTMLæ§‹é€ ã‚’ä¿æŒã—ãªãŒã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¿ã‚¤ãƒ”ãƒ³ã‚°
        async typeHTML(container, fragment, speed) {
            for (const node of fragment.childNodes) {
                if (node.nodeType === Node.TEXT_NODE) {
                    // ãƒ†ã‚­ã‚¹ãƒˆãƒãƒ¼ãƒ‰ã¯1æ–‡å­—ãšã¤
                    await this.typeTextNode(container, node.textContent, speed);
                } else if (node.nodeType === Node.ELEMENT_NODE) {
                    // è¦ç´ ãƒãƒ¼ãƒ‰ã¯æ§‹é€ ã‚’ä½œæˆã—ã¦ã‹ã‚‰ä¸­èº«ã‚’ã‚¿ã‚¤ãƒ”ãƒ³ã‚°
                    const el = document.createElement(node.tagName);
                    // å±æ€§ã‚’ã‚³ãƒ”ãƒ¼
                    for (const attr of node.attributes) {
                        el.setAttribute(attr.name, attr.value);
                    }
                    container.appendChild(el);
                    // å­ãƒãƒ¼ãƒ‰ã‚’å†å¸°çš„ã«å‡¦ç†
                    await this.typeHTML(el, node, speed);
                }
            }
        }

        async typeTextNode(container, text, speed) {
            for (const char of text) {
                container.appendChild(document.createTextNode(char));
                await this.delay(speed);
            }
        }

        delay(ms) {
            return new Promise(r => setTimeout(r, ms));
        }
    }

    // Initialize stream renderers for each section
    const precheckRenderer = new SectionStreamRenderer('#precheck-content');
    const securityRenderer = new SectionStreamRenderer('#security-content');
    const functionalRenderer = new SectionStreamRenderer('#functional-content');

    // State management for progressive display
    let securityState = { total: 0, blocked: 0, needsReview: 0, errors: 0 };
    let securityTestsStarted = 0;  // é–‹å§‹ã—ãŸãƒ†ã‚¹ãƒˆæ•°ï¼ˆãƒ—ãƒ­ã‚°ãƒ¬ã‚¹è¡¨ç¤ºç”¨ï¼‰
    let functionalState = { total: 0, passed: 0, failed: 0, needsReview: 0, currentScenario: 0, currentTurn: 0, currentTotalTurns: 0 };

    // ==== PreCheck Event Handlers ====
    juryStream.on('precheck_started', async () => {
        console.log('[Streaming] precheck_started received');
        precheckRenderer.openSection();
        precheckRenderer.clear();

        // ã€ŒStatus:ã€ãƒ©ãƒ™ãƒ«ã‹ã‚‰ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°é–‹å§‹
        await precheckRenderer.streamLine(
            '<p class="text-sm text-gray-700"><span class="font-semibold">Status:</span> <span class="text-blue-600">æ¤œè¨¼ä¸­...</span></p>'
        );
    });

    juryStream.on('precheck_completed', async (data) => {
        console.log('[Streaming] precheck_completed received:', data);
        precheckRenderer.clear();

        // Toast notification
        const warningCount = data.warnings?.length || 0;
        const toastMsg = `PreCheck: ${data.passed ? 'å®Œäº†' : 'å¤±æ•—'}${warningCount > 0 ? ` (è­¦å‘Š${warningCount}ä»¶)` : ''}`;
        showToast(toastMsg, data.passed ? (warningCount > 0 ? 'warning' : 'success') : 'error');

        // Statusè¡Œã‚’ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°
        const statusClass = data.passed ? 'text-green-600' : 'text-red-600';
        const statusText = data.passed ? 'Passed âœ“' : 'Failed âœ—';
        await precheckRenderer.streamLine(
            `<p class="text-sm text-gray-700"><span class="font-semibold">Status:</span> <span class="${statusClass}">${statusText}</span></p>`
        );

        // Warnings ãŒã‚ã‚Œã°è¡¨ç¤º
        if (data.warnings && data.warnings.length > 0) {
            await precheckRenderer.streamLine(
                '<p class="text-sm text-yellow-600 mt-2"><span class="font-semibold">Warnings:</span></p>'
            );
            for (const warning of data.warnings) {
                await precheckRenderer.streamLine(
                    `<p class="text-xs text-yellow-600 ml-4">â€¢ ${warning}</p>`
                );
            }
        }

        // Errors ãŒã‚ã‚Œã°è¡¨ç¤º
        if (data.errors && data.errors.length > 0) {
            await precheckRenderer.streamLine(
                '<p class="text-sm text-red-600 mt-2"><span class="font-semibold">Errors:</span></p>'
            );
            for (const error of data.errors) {
                await precheckRenderer.streamLine(
                    `<p class="text-xs text-red-600 ml-4">â€¢ ${error}</p>`
                );
            }
        }
    });

    // ==== Security Gate Event Handlers ====
    // ã‚·ãƒŠãƒªã‚ªçµæœã‚’è“„ç©
    let securityScenarios = [];
    let securityTableReady = false;  // ãƒ†ãƒ¼ãƒ–ãƒ«ãŒæº–å‚™å®Œäº†ã—ãŸã‹ã©ã†ã‹
    let securityEventQueue = [];     // ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚­ãƒ¥ãƒ¼ã‚¤ãƒ³ã‚°
    let securityProcessingQueue = false;  // ã‚­ãƒ¥ãƒ¼å‡¦ç†ä¸­ãƒ•ãƒ©ã‚°

    // ã‚·ãƒŠãƒªã‚ªçµæœã‚’å‡¦ç†ã™ã‚‹å…±é€šé–¢æ•°
    async function processSecurityScenarioResult(data) {
        // ãƒãƒƒãƒæ›´æ–°ã®å ´åˆã¯ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼å‡¦ç†ã‚’èª¿æ•´ï¼ˆpendingâ†’æœ€çµ‚verdictã¸ã®å¤‰æ›ï¼‰
        if (data.is_batch_update) {
            // ãƒãƒƒãƒæ›´æ–°ï¼špendingã‹ã‚‰æœ€çµ‚verdictã¸ã®å¤‰æ›
            if (securityState.pending > 0) {
                securityState.pending--;
            }
            if (data.verdict === 'blocked') securityState.blocked++;
            else if (data.verdict === 'needs_review') securityState.needsReview++;
            else if (data.verdict === 'error') securityState.errors++;
            // â€» ãƒãƒƒãƒæ›´æ–°æ™‚ã¯verdictã‚«ãƒ©ãƒ ã®ã¿æ›´æ–°ã™ã‚‹ãŸã‚ã€prompt/responseã®ãƒãƒ¼ã‚¸ã¯ä¸è¦
        } else {
            // é€šå¸¸æ›´æ–°ï¼šã‚«ãƒ†ã‚´ãƒªã«å¿œã˜ã¦ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼æ›´æ–°
            if (data.category === 'pending') {
                securityState.pending++;
            } else {
                if (securityState.pending > 0 && data.verdict !== 'blocked' && data.verdict !== 'error') {
                    securityState.pending--;
                }
                if (data.verdict === 'blocked') securityState.blocked++;
                else if (data.verdict === 'needs_review') securityState.needsReview++;
                else if (data.verdict === 'error') securityState.errors++;
            }

            // ã‚·ãƒŠãƒªã‚ªã‚’è“„ç©ï¼ˆãƒãƒƒãƒæ›´æ–°æ™‚ã¯é‡è¤‡ã™ã‚‹ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ï¼‰
            securityScenarios.push(data);
        }

        // UIã‚’å¢—åˆ†æ›´æ–°
        updateSecurityCounts();
        updateSecurityProgress();

        // Phase 1ã®ã¿å¿œç­”ã‚’è¡¨ç¤ºï¼ˆis_batch_updateãŒfalseã¾ãŸã¯æœªå®šç¾©ã®å ´åˆï¼‰
        if (!data.is_batch_update && data.response) {
            await updateSecurityCurrentTestResponse(data);
        }

        // Phase 1: ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¡Œã‚’è¿½åŠ ï¼ˆprompt/responseå«ã‚€ï¼‰
        // Phase 2: Verdictã®ã¿æ›´æ–°ï¼ˆprompt/responseã¯ãã®ã¾ã¾ä¿æŒï¼‰
        if (!data.is_batch_update) {
            await appendSecurityScenarioToTable(data);
        } else {
            // Phase 2: Verdictã ã‘ã‚’æ›´æ–°
            // promptIdãŒç„¡ã„å ´åˆã¯securityScenariosã‹ã‚‰å–å¾—
            let promptId = data.promptId;
            if (!promptId && data.scenario_index !== undefined) {
                const savedScenario = securityScenarios.find(s => s.scenario_index === data.scenario_index);
                if (savedScenario) {
                    promptId = savedScenario.promptId;
                }
            }
            const rowId = `security-row-${promptId || data.scenario_index}`;
            const row = document.getElementById(rowId);
            if (row) {
                const verdictCell = row.querySelector('td:last-child span');
                if (verdictCell) {
                    const verdictClass = data.verdict === 'blocked' ? 'bg-green-100 text-green-800' :
                                         data.verdict === 'needs_review' ? 'bg-yellow-100 text-yellow-800' :
                                         data.verdict === 'error' ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800';
                    verdictCell.className = `px-2 py-1 rounded text-xs ${verdictClass}`;
                    verdictCell.textContent = data.verdict;
                }
            }
        }
        if (data.verdict === 'needs_review' || data.verdict === 'error') {
            // Phase 2ã®å ´åˆã¯securityScenariosã‹ã‚‰prompt/responseã‚’å–å¾—
            let enrichedData = data;
            if (data.is_batch_update && data.scenario_index !== undefined) {
                const savedScenario = securityScenarios.find(s => s.scenario_index === data.scenario_index);
                if (savedScenario) {
                    enrichedData = { ...data, prompt: savedScenario.prompt, response: savedScenario.response };
                }
            }
            await appendSecurityNeedsReviewScenario(enrichedData);
        }
    }

    // ã€Œç¾åœ¨ã®ãƒ†ã‚¹ãƒˆã€è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°ï¼ˆãƒ†ã‚¹ãƒˆé–‹å§‹æ™‚ã«å‘¼ã°ã‚Œã‚‹ï¼‰
    async function updateSecurityCurrentTest(data) {
        const testBox = document.getElementById('security-current-test');
        const headerEl = document.getElementById('security-test-header');
        const contentEl = document.getElementById('security-test-content');

        if (!testBox || !contentEl) return;

        // è¡¨ç¤º
        testBox.style.display = 'block';

        // ãƒ˜ãƒƒãƒ€ãƒ¼æ›´æ–°ï¼ˆã‚«ã‚¦ãƒ³ãƒˆã¯ã€Œãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå®Ÿè¡Œä¸­ã€ã«çµ±ä¸€ï¼‰
        if (headerEl) {
            headerEl.textContent = `ç¾åœ¨ã®ãƒ†ã‚¹ãƒˆ`;
        }

        // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚¯ãƒªã‚¢ã—ã¦æ–°ã—ã„è¦ç´ ã‚’ä½œæˆ
        contentEl.innerHTML = '';

        // Prompt IDéƒ¨åˆ†
        if (data.promptId) {
            const idDiv = document.createElement('div');
            idDiv.className = 'text-xs text-gray-500';
            contentEl.appendChild(idDiv);
            await typeTextInElement(idDiv, `ğŸ“‹ ID: ${data.promptId}`, 5);
        }

        // Promptéƒ¨åˆ†ã‚’ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°è¡¨ç¤º
        if (data.prompt) {
            const promptDiv = document.createElement('div');
            promptDiv.className = 'text-red-700';
            contentEl.appendChild(promptDiv);
            const promptText = data.prompt.length > 150 ? data.prompt.substring(0, 150) + '...' : data.prompt;
            await typeTextInElement(promptDiv, `ğŸ¯ æ”»æ’ƒ: ${promptText}`, 3);
        }

        // å¾…æ©Ÿä¸­è¡¨ç¤ºã‚’è¿½åŠ 
        const waitingDiv = document.createElement('div');
        waitingDiv.className = 'text-gray-400 animate-pulse';
        waitingDiv.id = 'security-test-waiting';
        waitingDiv.textContent = 'ğŸ”„ å¿œç­”å¾…ã¡...';
        contentEl.appendChild(waitingDiv);
    }

    // ã€Œç¾åœ¨ã®ãƒ†ã‚¹ãƒˆã€ã«å¿œç­”ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°ï¼ˆPhase 1ã®ã¿ï¼‰
    async function updateSecurityCurrentTestResponse(data) {
        const contentEl = document.getElementById('security-test-content');
        if (!contentEl) return;

        // å¾…æ©Ÿä¸­è¡¨ç¤ºã‚’å‰Šé™¤
        const waitingDiv = document.getElementById('security-test-waiting');
        if (waitingDiv) waitingDiv.remove();

        // Responseéƒ¨åˆ†ã‚’è¡¨ç¤º
        if (data.response) {
            const responseDiv = document.createElement('div');
            responseDiv.className = 'text-blue-700';
            contentEl.appendChild(responseDiv);
            const responseText = data.response.length > 150 ? data.response.substring(0, 150) + '...' : data.response;
            await typeTextInElement(responseDiv, `ğŸ¤– å¿œç­”: ${responseText}`, 3);
        }
    }

    // ã‚­ãƒ¥ãƒ¼ã‚’é€æ¬¡å‡¦ç†ã™ã‚‹é–¢æ•°
    async function processSecurityEventQueue() {
        if (securityProcessingQueue) return;  // æ—¢ã«å‡¦ç†ä¸­ãªã‚‰ä½•ã‚‚ã—ãªã„
        securityProcessingQueue = true;

        while (securityEventQueue.length > 0) {
            const data = securityEventQueue.shift();
            if (data._eventType === 'test_started') {
                // ãƒ†ã‚¹ãƒˆé–‹å§‹ã‚¤ãƒ™ãƒ³ãƒˆï¼šç¾åœ¨ã®ãƒ†ã‚¹ãƒˆè¡¨ç¤ºã‚’æ›´æ–°
                securityTestsStarted++;  // é–‹å§‹ãƒ†ã‚¹ãƒˆæ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
                updateSecurityProgress();  // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹è¡¨ç¤ºã‚’æ›´æ–°
                await updateSecurityCurrentTest(data);
            } else {
                // ã‚·ãƒŠãƒªã‚ªçµæœã‚¤ãƒ™ãƒ³ãƒˆï¼šçµæœå‡¦ç†
                await processSecurityScenarioResult(data);
            }
        }

        securityProcessingQueue = false;
    }

    juryStream.on('security_started', async (data) => {
        console.log('[Streaming] security_started received:', data);
        securityRenderer.openSection();
        securityScenarios = [];  // ãƒªã‚»ãƒƒãƒˆ
        securityTableReady = false;  // ãƒ†ãƒ¼ãƒ–ãƒ«æº–å‚™ä¸­
        securityEventQueue = [];  // ã‚­ãƒ¥ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
        securityProcessingQueue = false;  // å‡¦ç†ä¸­ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
        securityTestsStarted = 0;  // é–‹å§‹ãƒ†ã‚¹ãƒˆæ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
        securityState = { total: data.total_scenarios || 0, blocked: 0, needsReview: 0, errors: 0, pending: 0 };
        // åˆæœŸãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆãƒ•ãƒ«æ§‹é€ ï¼‰ã‚’ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°è¡¨ç¤º
        await renderSecuritySectionStreaming();

        // ãƒ†ãƒ¼ãƒ–ãƒ«æº–å‚™å®Œäº†
        securityTableReady = true;

        // ã‚­ãƒ¥ãƒ¼ã«è“„ç©ã•ã‚ŒãŸã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†
        console.log(`[Streaming] Processing ${securityEventQueue.length} queued security events`);
        processSecurityEventQueue();
    });

    // ãƒ†ã‚¹ãƒˆé–‹å§‹æ™‚ã«ã€Œç¾åœ¨ã®ãƒ†ã‚¹ãƒˆã€ã‚’è¡¨ç¤ºï¼ˆã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ã—ã¦é †åºä¿è¨¼ï¼‰
    juryStream.on('security_test_started', (data) => {
        console.log('[Streaming] security_test_started received:', data);
        // test_startedã‚¤ãƒ™ãƒ³ãƒˆã¨ã—ã¦ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ 
        securityEventQueue.push({ ...data, _eventType: 'test_started' });

        // ãƒ†ãƒ¼ãƒ–ãƒ«ãŒæº–å‚™å®Œäº†ã—ã¦ã„ã‚Œã°ã‚­ãƒ¥ãƒ¼å‡¦ç†ã‚’é–‹å§‹
        if (securityTableReady) {
            processSecurityEventQueue();
        }
    });

    juryStream.on('security_scenario_result', (data) => {
        // asyncã‚’å‰Šé™¤ã€å¸¸ã«ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ã—ã¦é€æ¬¡å‡¦ç†
        console.log('[Streaming] security_scenario_result received:', data);
        securityEventQueue.push({ ...data, _eventType: 'scenario_result' });

        // ãƒ†ãƒ¼ãƒ–ãƒ«ãŒæº–å‚™å®Œäº†ã—ã¦ã„ã‚Œã°ã‚­ãƒ¥ãƒ¼å‡¦ç†ã‚’é–‹å§‹
        if (securityTableReady) {
            processSecurityEventQueue();
        }
    });

    juryStream.on('security_completed', async (data) => {
        console.log('[Streaming] security_completed received:', data);

        // Toast notification
        const blocked = data.data?.blocked || 0;
        const total = data.data?.attempted || 0;
        const toastType = blocked === total ? 'success' : 'warning';
        showToast(`Security Gate: ${blocked}/${total} é€šé`, toastType);

        // ã€Œç¾åœ¨ã®ãƒ†ã‚¹ãƒˆã€ã‚’éè¡¨ç¤º
        const testBox = document.getElementById('security-current-test');
        if (testBox) testBox.style.display = 'none';

        // å®Œäº†çŠ¶æ…‹ã«æ›´æ–°ï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°è¡¨ç¤ºï¼‰
        const progressEl = document.getElementById('security-progress');
        if (progressEl) {
            progressEl.innerHTML = '';
            progressEl.className = 'text-sm text-green-600 font-semibold';
            await typeTextInElement(progressEl, 'âœ… å®Œäº†', 30);
        }
        // è©•ä¾¡å¾…ã¡è¡¨ç¤ºã‚’æ¶ˆã™
        const pendingEl = document.getElementById('security-pending');
        if (pendingEl) pendingEl.style.display = 'none';

        // ã€Œè¦ç¢ºèªã‚·ãƒŠãƒªã‚ªã€ãŒç©ºã®å ´åˆã¯ã€Œè©²å½“ãªã—ã€ã«å¤‰æ›´ï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°è¡¨ç¤ºï¼‰
        const noIssuesEl = document.getElementById('security-no-issues');
        if (noIssuesEl) {
            noIssuesEl.textContent = '';
            noIssuesEl.className = 'text-sm text-green-600';
            await typeTextInElement(noIssuesEl, 'âœ… è©²å½“ãªã—ï¼ˆå…¨ã¦ãƒ–ãƒ­ãƒƒã‚¯æ¸ˆã¿ï¼‰', 20);
        }
    });

    async function renderSecuritySectionStreaming() {
        // ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¯ãƒªã‚¢
        securityRenderer.clear();

        // 1. åŸºæœ¬ã‚«ã‚¦ãƒ³ãƒˆã‚’ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°
        await securityRenderer.streamLine(`
            <div id="security-counts" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                <div class="bg-white p-3 rounded border">
                    <div class="text-xs text-gray-500">Total Tests</div>
                    <div class="text-2xl font-bold" id="security-total">${securityState.total}</div>
                </div>
                <div class="bg-green-50 p-3 rounded border border-green-200">
                    <div class="text-xs text-gray-500">Blocked (Safe)</div>
                    <div class="text-2xl font-bold text-green-600" id="security-blocked">${securityState.blocked}</div>
                </div>
                <div class="bg-yellow-50 p-3 rounded border border-yellow-200">
                    <div class="text-xs text-gray-500">Needs Review</div>
                    <div class="text-2xl font-bold text-yellow-600" id="security-needs-review-count">${securityState.needsReview}</div>
                </div>
                <div class="bg-red-50 p-3 rounded border border-red-200">
                    <div class="text-xs text-gray-500">Errors</div>
                    <div class="text-2xl font-bold text-red-600" id="security-errors">${securityState.errors}</div>
                </div>
            </div>
        `, { speed: 3 });  // ã‚«ã‚¦ãƒ³ãƒˆã¯é€Ÿã‚ã«

        // 2. é€²æ—è¡¨ç¤ºã‚’ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°
        await securityRenderer.streamLine(`
            <p id="security-pending" class="text-sm text-blue-600 mb-2" style="display:none;">ğŸ“ è©•ä¾¡å¾…ã¡: <span id="security-pending-count">0</span>ä»¶</p>
            <p id="security-progress" class="text-sm text-gray-500 mb-4">ğŸ”„ å®Ÿè¡Œä¸­... (0/${securityState.total})</p>
        `, { speed: 10 });

        // 2.5. ç¾åœ¨ã®ãƒ†ã‚¹ãƒˆè¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
        await securityRenderer.streamLine(`
            <div id="security-current-test" class="border rounded-lg p-3 bg-red-50 mb-4" style="display: none;">
                <div class="flex items-center gap-2 text-sm font-semibold text-red-700 mb-2">
                    <span>ğŸ”</span>
                    <span id="security-test-header">ç¾åœ¨ã®ãƒ†ã‚¹ãƒˆ</span>
                </div>
                <div id="security-test-content" class="text-sm bg-white rounded p-2 border space-y-2">
                    <div class="text-gray-400">ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...</div>
                </div>
            </div>
        `, { speed: 5 });

        // 3. è¦ç¢ºèªã‚·ãƒŠãƒªã‚ªã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°
        await securityRenderer.streamLine(`
            <div class="border-t pt-4">
                <h4 class="font-semibold mb-2">âš ï¸ è¦ç¢ºèªã‚·ãƒŠãƒªã‚ªï¼ˆNeeds Review/Errorï¼‰</h4>
                <div id="security-needs-review-list" class="space-y-3">
                    <p class="text-sm text-gray-400" id="security-no-issues">è©•ä¾¡ä¸­...</p>
                </div>
            </div>
        `, { speed: 8 });

        // 4. ãƒ†ãƒ¼ãƒ–ãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°
        await securityRenderer.streamLine(`
            <div class="border-t pt-4 mt-4">
                <h4 class="font-semibold mb-2">ğŸ“ å…¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆä¸€è¦§</h4>
                <div class="max-h-80 overflow-auto border rounded">
                    <table class="w-full text-xs border-collapse">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr>
                                <th class="text-left p-2 border-b">Prompt ID</th>
                                <th class="text-left p-2 border-b">Prompt</th>
                                <th class="text-left p-2 border-b">Response</th>
                                <th class="text-left p-2 border-b">Verdict</th>
                            </tr>
                        </thead>
                        <tbody id="security-table-body"></tbody>
                    </table>
                </div>
            </div>
        `, { speed: 5 });

        // 5. ç¢ºèªãƒã‚¤ãƒ³ãƒˆã‚’ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°
        await securityRenderer.streamLine(`
            <div class="border-t pt-4 mt-4">
                <h4 class="font-semibold mb-2">ğŸ“‹ ç¢ºèªãƒã‚¤ãƒ³ãƒˆ</h4>
                <ul class="text-sm space-y-1 list-disc ml-5">
                    <li><strong>Blocked (Safe)</strong>: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ”»æ’ƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’é©åˆ‡ã«ãƒ–ãƒ­ãƒƒã‚¯ã—ãŸã‚±ãƒ¼ã‚¹</li>
                    <li><strong>Needs Review</strong>: äººæ‰‹ç¢ºèªãŒå¿…è¦ãªã‚±ãƒ¼ã‚¹ã€‚ã€Œè¦ç¢ºèªã‚·ãƒŠãƒªã‚ªã€ã§è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„</li>
                    <li>å…¨ä½“ã®ãƒ–ãƒ­ãƒƒã‚¯ç‡ (Blocked/Total) ãŒé«˜ã„ã»ã©ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ãŒæœ‰åŠ¹ã§ã™</li>
                </ul>
            </div>
        `, { speed: 8 });
    }

    function renderSecuritySectionFull() {
        // åˆæœŸãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆãƒ•ãƒ«æ§‹é€ ï¼‰- å³æ™‚è¡¨ç¤ºç”¨ï¼ˆéã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ï¼‰
        securityRenderer.setContent(`
            <!-- åŸºæœ¬ã‚«ã‚¦ãƒ³ãƒˆ -->
            <div id="security-counts" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                <div class="bg-white p-3 rounded border">
                    <div class="text-xs text-gray-500">Total Tests</div>
                    <div class="text-2xl font-bold" id="security-total">${securityState.total}</div>
                </div>
                <div class="bg-green-50 p-3 rounded border border-green-200">
                    <div class="text-xs text-gray-500">Blocked (Safe)</div>
                    <div class="text-2xl font-bold text-green-600" id="security-blocked">${securityState.blocked}</div>
                </div>
                <div class="bg-yellow-50 p-3 rounded border border-yellow-200">
                    <div class="text-xs text-gray-500">Needs Review</div>
                    <div class="text-2xl font-bold text-yellow-600" id="security-needs-review-count">${securityState.needsReview}</div>
                </div>
                <div class="bg-red-50 p-3 rounded border border-red-200">
                    <div class="text-xs text-gray-500">Errors</div>
                    <div class="text-2xl font-bold text-red-600" id="security-errors">${securityState.errors}</div>
                </div>
            </div>

            <!-- é€²æ—è¡¨ç¤º -->
            <p id="security-pending" class="text-sm text-blue-600 mb-2" style="display:none;">ğŸ“ è©•ä¾¡å¾…ã¡: <span id="security-pending-count">0</span>ä»¶</p>
            <p id="security-progress" class="text-sm text-gray-500 mb-4">ğŸ”„ å®Ÿè¡Œä¸­... (0/${securityState.total})</p>

            <!-- è¦ç¢ºèªã‚·ãƒŠãƒªã‚ª -->
            <div class="border-t pt-4">
                <h4 class="font-semibold mb-2">âš ï¸ è¦ç¢ºèªã‚·ãƒŠãƒªã‚ªï¼ˆNeeds Review/Errorï¼‰</h4>
                <div id="security-needs-review-list" class="space-y-3">
                    <p class="text-sm text-gray-400" id="security-no-issues">è©•ä¾¡ä¸­...</p>
                </div>
            </div>

            <!-- å…¨ã‚·ãƒŠãƒªã‚ªãƒ†ãƒ¼ãƒ–ãƒ« -->
            <div class="border-t pt-4 mt-4">
                <h4 class="font-semibold mb-2">ğŸ“ å…¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆä¸€è¦§</h4>
                <div class="max-h-80 overflow-auto border rounded">
                    <table class="w-full text-xs border-collapse">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr>
                                <th class="text-left p-2 border-b">Prompt ID</th>
                                <th class="text-left p-2 border-b">Prompt</th>
                                <th class="text-left p-2 border-b">Response</th>
                                <th class="text-left p-2 border-b">Verdict</th>
                            </tr>
                        </thead>
                        <tbody id="security-table-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- ç¢ºèªãƒã‚¤ãƒ³ãƒˆ -->
            <div class="border-t pt-4 mt-4">
                <h4 class="font-semibold mb-2">ğŸ“‹ ç¢ºèªãƒã‚¤ãƒ³ãƒˆ</h4>
                <ul class="text-sm space-y-1 list-disc ml-5">
                    <li><strong>Blocked (Safe)</strong>: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ”»æ’ƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’é©åˆ‡ã«ãƒ–ãƒ­ãƒƒã‚¯ã—ãŸã‚±ãƒ¼ã‚¹</li>
                    <li><strong>Needs Review</strong>: äººæ‰‹ç¢ºèªãŒå¿…è¦ãªã‚±ãƒ¼ã‚¹ã€‚ã€Œè¦ç¢ºèªã‚·ãƒŠãƒªã‚ªã€ã§è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„</li>
                    <li>å…¨ä½“ã®ãƒ–ãƒ­ãƒƒã‚¯ç‡ (Blocked/Total) ãŒé«˜ã„ã»ã©ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ãŒæœ‰åŠ¹ã§ã™</li>
                </ul>
            </div>
        `);
    }

    function updateSecurityCounts() {
        const totalEl = document.getElementById('security-total');
        const blockedEl = document.getElementById('security-blocked');
        const needsReviewEl = document.getElementById('security-needs-review-count');
        const errorsEl = document.getElementById('security-errors');

        if (totalEl) totalEl.textContent = securityState.total;
        if (blockedEl) blockedEl.textContent = securityState.blocked;
        if (needsReviewEl) needsReviewEl.textContent = securityState.needsReview;
        if (errorsEl) errorsEl.textContent = securityState.errors;
    }

    function updateSecurityProgress() {
        const evaluated = securityState.blocked + securityState.needsReview + securityState.errors;

        // é€²æ—ãƒ†ã‚­ã‚¹ãƒˆæ›´æ–°
        const progressEl = document.getElementById('security-progress');
        if (progressEl) {
            if (securityTestsStarted > 0 && securityTestsStarted < securityState.total) {
                // Phase 1: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­ï¼ˆé–‹å§‹æ¸ˆã¿ãƒ†ã‚¹ãƒˆæ•°/å…¨ä½“ï¼‰
                progressEl.textContent = `â³ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå®Ÿè¡Œä¸­... (${securityTestsStarted}/${securityState.total})`;
            } else if (securityTestsStarted >= securityState.total && evaluated < securityState.total) {
                // Phase 2: LLMè©•ä¾¡ä¸­ï¼ˆå…¨ãƒ†ã‚¹ãƒˆå®Œäº†å¾Œï¼‰
                progressEl.textContent = `ğŸ” è©•ä¾¡ä¸­... (${evaluated}/${securityState.total})`;
            } else if (evaluated >= securityState.total) {
                // å®Œäº†
                progressEl.textContent = `âœ… è©•ä¾¡å®Œäº† (${evaluated}/${securityState.total})`;
            } else {
                // åˆæœŸçŠ¶æ…‹
                progressEl.textContent = `ğŸ”„ æº–å‚™ä¸­...`;
            }
        }

        // è©•ä¾¡å¾…ã¡è¡¨ç¤º
        const pendingEl = document.getElementById('security-pending');
        const pendingCountEl = document.getElementById('security-pending-count');
        if (pendingEl && pendingCountEl) {
            if (securityState.pending > 0) {
                pendingEl.style.display = 'block';
                pendingCountEl.textContent = securityState.pending;
            } else {
                pendingEl.style.display = 'none';
            }
        }
    }

    async function appendSecurityScenarioToTable(data) {
        const tbody = document.getElementById('security-table-body');
        if (!tbody) return;

        // promptIdãƒ™ãƒ¼ã‚¹ã§è¡Œã‚’ç‰¹å®š
        const rowId = `security-row-${data.promptId || data.scenario_index}`;
        let row = document.getElementById(rowId);

        // â˜… æ—¢å­˜ã®è¡ŒãŒã‚ã‚‹å ´åˆã¯ä½•ã‚‚ã—ãªã„ï¼ˆä¸Šæ›¸ãé˜²æ­¢ï¼‰
        if (row) {
            return;
        }

        const verdictClass = data.verdict === 'blocked' ? 'bg-green-100 text-green-800' :
                             data.verdict === 'needs_review' ? 'bg-yellow-100 text-yellow-800' :
                             data.verdict === 'error' ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800';

        const promptText = (data.prompt || '').substring(0, 100);
        const responseText = (data.response || '').substring(0, 100);

        // æ–°è¦è¡Œã‚’ä½œæˆ
        row = document.createElement('tr');
        row.id = rowId;
        row.className = 'border-b hover:bg-gray-50';
        tbody.appendChild(row);

        // è¡Œã®ã‚»ãƒ«ã‚’ä½œæˆ
        const cells = [
            { content: data.promptId || 'N/A', className: 'p-2 text-xs' },
            { content: promptText + (promptText.length >= 100 ? '...' : ''), className: 'p-2', isCode: true },
            { content: responseText + (responseText.length >= 100 ? '...' : ''), className: 'p-2', isCode: true },
            { content: data.verdict, className: 'p-2', badge: verdictClass }
        ];
        for (const cell of cells) {
            const td = document.createElement('td');
            td.className = cell.className;
            row.appendChild(td);

            if (cell.badge) {
                const span = document.createElement('span');
                span.className = `px-2 py-1 rounded text-xs ${cell.badge}`;
                td.appendChild(span);
                await typeTextInElement(span, cell.content, 5);
            } else if (cell.isCode) {
                const pre = document.createElement('pre');
                pre.className = 'whitespace-pre-wrap text-xs';
                td.appendChild(pre);
                await typeTextInElement(pre, cell.content, 8);
            } else {
                await typeTextInElement(td, cell.content, 5);
            }
        }
    }

    // ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã§è¦ç´ ã«è¿½åŠ 
    async function typeTextInElement(element, text, speed = 10) {
        for (const char of text) {
            element.appendChild(document.createTextNode(char));
            await new Promise(r => setTimeout(r, speed));
        }
    }

    async function appendSecurityNeedsReviewScenario(data) {
        const container = document.getElementById('security-needs-review-list');
        if (!container) return;

        // ã€Œè©•ä¾¡ä¸­...ã€ã‚’æ¶ˆã™
        const noIssuesEl = document.getElementById('security-no-issues');
        if (noIssuesEl) noIssuesEl.remove();

        const div = document.createElement('div');
        div.className = 'border border-yellow-300 rounded-lg p-3 bg-yellow-50';
        container.appendChild(div);

        const verdictClass = data.verdict === 'error' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800';
        const promptText = data.prompt || 'N/A';
        const responseText = data.response || 'N/A';

        // ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†ï¼ˆPrompt ID + Verdict ãƒãƒƒã‚¸ï¼‰
        const headerDiv = document.createElement('div');
        headerDiv.className = 'font-semibold text-sm mb-1';
        div.appendChild(headerDiv);
        await typeTextInElement(headerDiv, data.promptId || 'åŒ¿å', 5);

        const verdictSpan = document.createElement('span');
        verdictSpan.className = `ml-2 text-xs px-2 py-1 rounded ${verdictClass}`;
        headerDiv.appendChild(verdictSpan);
        await typeTextInElement(verdictSpan, data.verdict, 10);

        // Category/Perspective
        const metaDiv = document.createElement('div');
        metaDiv.className = 'text-xs text-gray-600 mb-2';
        div.appendChild(metaDiv);
        await typeTextInElement(metaDiv, `Category: ${data.category || 'N/A'}${data.perspective ? ` | Perspective: ${data.perspective}` : ''}`, 3);

        // Prompt
        const promptLabelDiv = document.createElement('div');
        promptLabelDiv.className = 'text-xs mb-2';
        div.appendChild(promptLabelDiv);

        const promptStrong = document.createElement('strong');
        promptLabelDiv.appendChild(promptStrong);
        await typeTextInElement(promptStrong, 'Prompt:', 10);

        const promptPre = document.createElement('pre');
        promptPre.className = 'mt-1 whitespace-pre-wrap bg-white p-2 rounded text-xs';
        promptLabelDiv.appendChild(promptPre);
        await typeTextInElement(promptPre, promptText, 2);

        // Response
        const responseLabelDiv = document.createElement('div');
        responseLabelDiv.className = 'text-xs mb-2';
        div.appendChild(responseLabelDiv);

        const responseStrong = document.createElement('strong');
        responseLabelDiv.appendChild(responseStrong);
        await typeTextInElement(responseStrong, 'Response:', 10);

        const responsePre = document.createElement('pre');
        responsePre.className = 'mt-1 whitespace-pre-wrap bg-white p-2 rounded text-xs';
        responseLabelDiv.appendChild(responsePre);
        await typeTextInElement(responsePre, responseText, 2);

        // Reason
        const reasonDiv = document.createElement('div');
        reasonDiv.className = 'text-xs text-gray-700';
        div.appendChild(reasonDiv);

        const reasonStrong = document.createElement('strong');
        reasonDiv.appendChild(reasonStrong);
        await typeTextInElement(reasonStrong, 'Reason: ', 10);

        const reasonSpan = document.createElement('span');
        reasonDiv.appendChild(reasonSpan);
        await typeTextInElement(reasonSpan, data.rationale || 'N/A', 3);
    }

    // ==== Agent Card Accuracy (Functional) Event Handlers ====
    // ã‚·ãƒŠãƒªã‚ªçµæœã‚’è“„ç©
    let functionalScenarios = [];

    juryStream.on('functional_started', async (data) => {
        console.log('[Streaming] functional_started received:', data);
        functionalRenderer.openSection();
        functionalScenarios = [];  // ãƒªã‚»ãƒƒãƒˆ
        functionalState = { total: data.total_scenarios || 0, passed: 0, failed: 0, needsReview: 0, currentScenario: 0, currentTurn: 0, currentTotalTurns: 0 };
        // ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤ºã«å¤‰æ›´
        await renderFunctionalSectionStreaming();
    });

    juryStream.on('functional_scenario_result', async (data) => {
        console.log('[Streaming] functional_scenario_result received:', data);
        // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼æ›´æ–°
        if (data.verdict === 'pass') functionalState.passed++;
        else if (data.verdict === 'fail') functionalState.failed++;
        else if (data.verdict === 'needs_review') functionalState.needsReview++;
        else if (data.verdict === 'error') functionalState.failed++;

        // ã‚¿ãƒ¼ãƒ³é€²æ—ã‚’ãƒªã‚»ãƒƒãƒˆ
        functionalState.currentTurn = 0;
        functionalState.currentTotalTurns = 0;

        // å¯¾è©±ãƒœãƒƒã‚¯ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆæ¬¡ã®ã‚·ãƒŠãƒªã‚ªç”¨ã«å¿œç­”å¾…ã¡çŠ¶æ…‹ã«ï¼‰
        const dialogueContent = document.getElementById('functional-dialogue-content');
        if (dialogueContent) {
            dialogueContent.innerHTML = '<div class="text-gray-400">æ¬¡ã®ã‚·ãƒŠãƒªã‚ªã‚’å¾…æ©Ÿä¸­...</div>';
        }

        // ã‚·ãƒŠãƒªã‚ªã‚’è“„ç©
        functionalScenarios.push(data);

        // ã€Œè©•ä¾¡ä¸­...ã€ãƒ†ã‚­ã‚¹ãƒˆã‚’éè¡¨ç¤ºï¼ˆpassã§ã‚‚éè¡¨ç¤ºã«ã™ã‚‹ï¼‰
        const noFailuresEl = document.getElementById('functional-no-failures');
        if (noFailuresEl) noFailuresEl.style.display = 'none';

        // UIã‚’å¢—åˆ†æ›´æ–°
        updateFunctionalCounts();
        updateFunctionalProgress();

        // å…¨ã‚·ãƒŠãƒªã‚ªä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¿½åŠ ï¼ˆPass/Failé–¢ä¿‚ãªãå…¨ã¦ï¼‰
        await appendFunctionalScenarioToTable(data);

        // å¤±æ•—ã‚·ãƒŠãƒªã‚ªã®è©³ç´°è¡¨ç¤ºï¼ˆå¤±æ•—/Needs Reviewã®ã¿ï¼‰
        if (data.verdict !== 'pass') {
            await appendFunctionalFailedScenario(data);
        }
    });

    juryStream.on('functional_turn_progress', async (data) => {
        console.log('[Streaming] functional_turn_progress received:', data);
        functionalState.currentScenario = data.scenario_index;
        functionalState.currentTurn = data.turn;
        functionalState.currentTotalTurns = data.total_turns;
        updateFunctionalProgress();

        // å¯¾è©±ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
        const dialogueBox = document.getElementById('functional-current-dialogue');
        const headerEl = document.getElementById('functional-dialogue-header');
        const contentEl = document.getElementById('functional-dialogue-content');

        if (dialogueBox && contentEl) {
            dialogueBox.style.display = 'block';
            if (headerEl) {
                headerEl.textContent = `ç¾åœ¨ã®å¯¾è©± (ã‚¿ãƒ¼ãƒ³ ${data.turn}/${data.total_turns})`;
            }

            // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚¯ãƒªã‚¢ã—ã¦æ–°ã—ã„è¦ç´ ã‚’ä½œæˆ
            contentEl.innerHTML = '';

            // Useréƒ¨åˆ†ã‚’ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°è¡¨ç¤º
            if (data.user_prompt) {
                const userDiv = document.createElement('div');
                userDiv.className = 'text-gray-600 mb-1';
                contentEl.appendChild(userDiv);
                await typeTextInElement(userDiv, `ğŸ‘¤ User: ${data.user_prompt}`, 8);
            }

            // Agentéƒ¨åˆ†ã‚’ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°è¡¨ç¤º
            if (data.agent_response_preview) {
                const agentDiv = document.createElement('div');
                agentDiv.className = 'text-blue-700';
                contentEl.appendChild(agentDiv);
                await typeTextInElement(agentDiv, `ğŸ¤– Agent: ${data.agent_response_preview}`, 8);
            }

            // ä¸¡æ–¹ãªã„å ´åˆã¯å¾…æ©Ÿè¡¨ç¤º
            if (!data.user_prompt && !data.agent_response_preview) {
                contentEl.innerHTML = '<div class="text-gray-400">å¿œç­”å¾…ã¡...</div>';
            }
        }
    });

    juryStream.on('functional_completed', async (data) => {
        console.log('[Streaming] functional_completed received:', data);

        // Toast notification
        const passed = functionalState.passed || 0;
        const total = functionalState.total || 0;
        const toastType = passed === total ? 'success' : 'warning';
        showToast(`Agent Card Accuracy: ${passed}/${total} ã‚·ãƒŠãƒªã‚ªé€šé`, toastType);

        // å¯¾è©±ãƒœãƒƒã‚¯ã‚¹ã‚’éè¡¨ç¤º
        const dialogueBox = document.getElementById('functional-current-dialogue');
        if (dialogueBox) {
            dialogueBox.style.display = 'none';
        }

        // å®Œäº†çŠ¶æ…‹ã«æ›´æ–°ï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°è¡¨ç¤ºï¼‰
        const progressEl = document.getElementById('functional-progress');
        if (progressEl) {
            progressEl.innerHTML = '';
            progressEl.className = 'text-sm text-green-600 font-semibold';
            await typeTextInElement(progressEl, `âœ… è©•ä¾¡å®Œäº† (${functionalState.total}/${functionalState.total})`, 30);
        }

        // ã€Œè©•ä¾¡ä¸­...ã€ãƒ†ã‚­ã‚¹ãƒˆã‚’é©åˆ‡ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å¤‰æ›´ï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°è¡¨ç¤ºï¼‰
        const noFailuresEl = document.getElementById('functional-no-failures');
        if (noFailuresEl) {
            if (functionalState.failed === 0 && functionalState.needsReview === 0) {
                noFailuresEl.textContent = '';
                noFailuresEl.style.display = 'block';
                noFailuresEl.className = 'text-sm text-green-600';
                await typeTextInElement(noFailuresEl, 'âœ… ã™ã¹ã¦ã®ã‚·ãƒŠãƒªã‚ªãŒãƒ‘ã‚¹ã—ã¾ã—ãŸ', 20);
            } else {
                noFailuresEl.style.display = 'none';
            }
        }
    });

    async function renderFunctionalSectionStreaming() {
        // ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¯ãƒªã‚¢
        functionalRenderer.clear();

        // 1. åŸºæœ¬ã‚«ã‚¦ãƒ³ãƒˆã‚’ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°
        await functionalRenderer.streamLine(`
            <div id="functional-counts" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                <div class="bg-white p-3 rounded border">
                    <div class="text-xs text-gray-500">Total Scenarios</div>
                    <div class="text-2xl font-bold" id="functional-total">${functionalState.total}</div>
                </div>
                <div class="bg-green-50 p-3 rounded border border-green-200">
                    <div class="text-xs text-gray-500">Passed</div>
                    <div class="text-2xl font-bold text-green-600" id="functional-passed">${functionalState.passed}</div>
                </div>
                <div class="bg-yellow-50 p-3 rounded border border-yellow-200">
                    <div class="text-xs text-gray-500">Needs Review</div>
                    <div class="text-2xl font-bold text-yellow-600" id="functional-needs-review">${functionalState.needsReview}</div>
                </div>
                <div class="bg-red-50 p-3 rounded border border-red-200">
                    <div class="text-xs text-gray-500">Failed</div>
                    <div class="text-2xl font-bold text-red-600" id="functional-failed">${functionalState.failed}</div>
                </div>
            </div>
        `, { speed: 3 });

        // 2. é€²æ—è¡¨ç¤ºã‚’ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°
        await functionalRenderer.streamLine(`
            <p id="functional-progress" class="text-sm text-gray-500 mb-4">ğŸ”„ è©•ä¾¡ä¸­... (0/${functionalState.total})</p>
        `, { speed: 10 });

        // 2.5. ç¾åœ¨ã®å¯¾è©±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºç”¨ï¼‰
        await functionalRenderer.streamLine(`
            <div id="functional-current-dialogue" class="border rounded-lg p-3 bg-blue-50 mb-4" style="display: none;">
                <div class="flex items-center gap-2 text-sm font-semibold text-blue-700 mb-2">
                    <span>ğŸ’¬</span>
                    <span id="functional-dialogue-header">ç¾åœ¨ã®å¯¾è©±</span>
                </div>
                <div id="functional-dialogue-content" class="text-sm bg-white rounded p-2 border">
                    <div class="text-gray-400">å¿œç­”å¾…ã¡...</div>
                </div>
            </div>
        `, { speed: 5 });

        // 3. å¤±æ•—ã‚·ãƒŠãƒªã‚ªã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°
        await functionalRenderer.streamLine(`
            <div class="border-t pt-4">
                <h4 class="font-semibold mb-2">âŒ å¤±æ•—ã‚·ãƒŠãƒªã‚ªã®è©³ç´°</h4>
                <div id="functional-failed-list" class="space-y-3">
                    <p class="text-sm text-gray-400" id="functional-no-failures">è©•ä¾¡ä¸­...</p>
                </div>
            </div>
        `, { speed: 8 });

        // 4. å…¨ã‚·ãƒŠãƒªã‚ªä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°
        await functionalRenderer.streamLine(`
            <div class="border-t pt-4 mt-4">
                <h4 class="font-semibold mb-2">ğŸ“ å…¨ã‚·ãƒŠãƒªã‚ªä¸€è¦§</h4>
                <div class="max-h-80 overflow-auto border rounded">
                    <table class="w-full text-xs border-collapse">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr>
                                <th class="text-left p-2 border-b">Prompt</th>
                                <th class="text-left p-2 border-b">Response</th>
                                <th class="text-left p-2 border-b">Turns</th>
                                <th class="text-left p-2 border-b">Verdict</th>
                            </tr>
                        </thead>
                        <tbody id="functional-table-body"></tbody>
                    </table>
                </div>
            </div>
        `, { speed: 5 });

        // 5. ç¢ºèªãƒã‚¤ãƒ³ãƒˆã‚’ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°
        await functionalRenderer.streamLine(`
            <div class="border-t pt-4 mt-4">
                <h4 class="font-semibold mb-2">ğŸ“‹ ç¢ºèªãƒã‚¤ãƒ³ãƒˆ</h4>
                <ul class="text-sm space-y-1 list-disc ml-5">
                    <li><strong>Passed</strong>: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒæ­£ã—ãå¿œç­”ã—ãŸã‚±ãƒ¼ã‚¹</li>
                    <li><strong>Needs Review</strong>: äººæ‰‹ç¢ºèªãŒå¿…è¦ãªã‚±ãƒ¼ã‚¹</li>
                    <li><strong>Failed</strong>: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å¿œç­”ãŒæœŸå¾…ã¨ç•°ãªã‚‹ã‚±ãƒ¼ã‚¹</li>
                </ul>
            </div>
        `, { speed: 8 });
    }

    function renderFunctionalSectionFull() {
        functionalRenderer.setContent(`
            <!-- åŸºæœ¬ã‚«ã‚¦ãƒ³ãƒˆ -->
            <div id="functional-counts" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                <div class="bg-white p-3 rounded border">
                    <div class="text-xs text-gray-500">Total Scenarios</div>
                    <div class="text-2xl font-bold" id="functional-total">${functionalState.total}</div>
                </div>
                <div class="bg-green-50 p-3 rounded border border-green-200">
                    <div class="text-xs text-gray-500">Passed</div>
                    <div class="text-2xl font-bold text-green-600" id="functional-passed">${functionalState.passed}</div>
                </div>
                <div class="bg-yellow-50 p-3 rounded border border-yellow-200">
                    <div class="text-xs text-gray-500">Needs Review</div>
                    <div class="text-2xl font-bold text-yellow-600" id="functional-needs-review">${functionalState.needsReview}</div>
                </div>
                <div class="bg-red-50 p-3 rounded border border-red-200">
                    <div class="text-xs text-gray-500">Failed</div>
                    <div class="text-2xl font-bold text-red-600" id="functional-failed">${functionalState.failed}</div>
                </div>
            </div>

            <!-- é€²æ—è¡¨ç¤º -->
            <p id="functional-progress" class="text-sm text-gray-500 mb-4">ğŸ”„ è©•ä¾¡ä¸­... (0/${functionalState.total})</p>

            <!-- ç¾åœ¨ã®å¯¾è©±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºç”¨ï¼‰ -->
            <div id="functional-current-dialogue" class="border rounded-lg p-3 bg-blue-50 mb-4" style="display: none;">
                <div class="flex items-center gap-2 text-sm font-semibold text-blue-700 mb-2">
                    <span>ğŸ’¬</span>
                    <span id="functional-dialogue-header">ç¾åœ¨ã®å¯¾è©±</span>
                </div>
                <div id="functional-dialogue-content" class="text-sm bg-white rounded p-2 border">
                    <div class="text-gray-400">å¿œç­”å¾…ã¡...</div>
                </div>
            </div>

            <!-- å¤±æ•—ã‚·ãƒŠãƒªã‚ªè©³ç´° -->
            <div class="border-t pt-4">
                <h4 class="font-semibold mb-2">âŒ å¤±æ•—ã‚·ãƒŠãƒªã‚ªã®è©³ç´°</h4>
                <div id="functional-failed-list" class="space-y-3">
                    <p class="text-sm text-gray-400" id="functional-no-failures">è©•ä¾¡ä¸­...</p>
                </div>
            </div>

            <!-- å…¨ã‚·ãƒŠãƒªã‚ªä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ« -->
            <div class="border-t pt-4 mt-4">
                <h4 class="font-semibold mb-2">ğŸ“ å…¨ã‚·ãƒŠãƒªã‚ªä¸€è¦§</h4>
                <div class="max-h-80 overflow-auto border rounded">
                    <table class="w-full text-xs border-collapse">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr>
                                <th class="text-left p-2 border-b">Prompt</th>
                                <th class="text-left p-2 border-b">Response</th>
                                <th class="text-left p-2 border-b">Turns</th>
                                <th class="text-left p-2 border-b">Verdict</th>
                            </tr>
                        </thead>
                        <tbody id="functional-table-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- ç¢ºèªãƒã‚¤ãƒ³ãƒˆ -->
            <div class="border-t pt-4 mt-4">
                <h4 class="font-semibold mb-2">ğŸ“‹ ç¢ºèªãƒã‚¤ãƒ³ãƒˆ</h4>
                <ul class="text-sm space-y-1 list-disc ml-5">
                    <li><strong>Passed</strong>: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒæ­£ã—ãå¿œç­”ã—ãŸã‚±ãƒ¼ã‚¹</li>
                    <li><strong>Needs Review</strong>: äººæ‰‹ç¢ºèªãŒå¿…è¦ãªã‚±ãƒ¼ã‚¹</li>
                    <li><strong>Failed</strong>: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å¿œç­”ãŒæœŸå¾…ã¨ç•°ãªã‚‹ã‚±ãƒ¼ã‚¹</li>
                </ul>
            </div>
        `);
    }

    function updateFunctionalCounts() {
        const totalEl = document.getElementById('functional-total');
        const passedEl = document.getElementById('functional-passed');
        const needsReviewEl = document.getElementById('functional-needs-review');
        const failedEl = document.getElementById('functional-failed');

        if (totalEl) totalEl.textContent = functionalState.total;
        if (passedEl) passedEl.textContent = functionalState.passed;
        if (needsReviewEl) needsReviewEl.textContent = functionalState.needsReview;
        if (failedEl) failedEl.textContent = functionalState.failed;
    }

    function updateFunctionalProgress() {
        const current = functionalState.passed + functionalState.failed + functionalState.needsReview;
        const progressEl = document.getElementById('functional-progress');
        if (!progressEl) return;

        if (functionalState.currentTurn > 0) {
            progressEl.textContent = `ğŸ’¬ ã‚·ãƒŠãƒªã‚ª ${functionalState.currentScenario + 1}/${functionalState.total} - å¯¾è©±ä¸­: ã‚¿ãƒ¼ãƒ³ ${functionalState.currentTurn}/${functionalState.currentTotalTurns}`;
        } else {
            progressEl.textContent = `ğŸ”„ è©•ä¾¡ä¸­... (${current}/${functionalState.total})`;
        }
    }

    async function appendFunctionalScenarioToTable(data) {
        const tbody = document.getElementById('functional-table-body');
        if (!tbody) return;

        const verdictClass = data.verdict === 'pass' ? 'bg-green-100 text-green-800' :
                             data.verdict === 'fail' ? 'bg-red-100 text-red-800' :
                             data.verdict === 'needs_review' ? 'bg-yellow-100 text-yellow-800' :
                             'bg-gray-100 text-gray-800';

        // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å–å¾—ï¼ˆ100æ–‡å­—ã«åˆ‡ã‚Šè©°ã‚ï¼‰
        const promptText = (data.prompt || '').substring(0, 100);

        // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å–å¾—ï¼ˆ100æ–‡å­—ã«åˆ‡ã‚Šè©°ã‚ï¼‰- ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã‹ã‚‰ç›´æ¥å–å¾—
        const responseText = (data.response || '').substring(0, 100);

        const turnsText = data.totalTurns || 1;

        const rowId = `functional-row-${data.scenario_index || 0}`;

        let row = document.getElementById(rowId);
        if (!row) {
            row = document.createElement('tr');
            row.id = rowId;
            row.className = 'border-b hover:bg-gray-50';
            tbody.appendChild(row);
        }

        // å†…å®¹ã‚’ã‚»ãƒƒãƒˆ
        row.innerHTML = `
            <td class="p-2 max-w-xs truncate" title="${promptText}">${promptText || '-'}</td>
            <td class="p-2 max-w-xs truncate" title="${responseText}">${responseText || '-'}</td>
            <td class="p-2 text-center">${turnsText}</td>
            <td class="p-2"><span class="px-2 py-1 rounded text-xs ${verdictClass}">${data.verdict}</span></td>
        `;
    }

    async function appendFunctionalFailedScenario(data) {
        const container = document.getElementById('functional-failed-list');
        if (!container) return;

        // ã€Œè©•ä¾¡ä¸­...ã€ã‚’éè¡¨ç¤ºï¼ˆå‰Šé™¤ã§ã¯ãªãéè¡¨ç¤ºã«ã—ã¦ã€å®Œäº†æ™‚ã«å†åˆ©ç”¨å¯èƒ½ã«ï¼‰
        const noFailuresEl = document.getElementById('functional-no-failures');
        if (noFailuresEl) noFailuresEl.style.display = 'none';

        const div = document.createElement('div');
        div.className = 'border border-gray-300 rounded-lg p-3 bg-white';
        container.appendChild(div);

        const verdictClass = data.verdict === 'fail' ? 'bg-red-100 text-red-800' :
                             data.verdict === 'needs_review' ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800';

        // ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†ï¼ˆã‚·ãƒŠãƒªã‚ªå + Verdict ãƒãƒƒã‚¸ï¼‰
        const headerDiv = document.createElement('div');
        headerDiv.className = 'font-semibold text-sm mb-1';
        div.appendChild(headerDiv);
        await typeTextInElement(headerDiv, data.scenarioId || data.scenario_name || 'åŒ¿å', 5);

        const verdictSpan = document.createElement('span');
        verdictSpan.className = `ml-2 text-xs px-2 py-1 rounded ${verdictClass}`;
        headerDiv.appendChild(verdictSpan);
        await typeTextInElement(verdictSpan, data.verdict, 10);

        // Turnsè¡¨ç¤º
        if (data.totalTurns) {
            const turnsDiv = document.createElement('div');
            turnsDiv.className = 'text-xs text-gray-600 mb-2';
            div.appendChild(turnsDiv);
            await typeTextInElement(turnsDiv, `Turns: ${data.totalTurns}`, 5);
        }

        // å¯¾è©±å±¥æ­´ï¼ˆã‚ã‚Œã°ï¼‰
        if (data.dialogueHistory && data.dialogueHistory.length > 0) {
            const dialogueContainer = document.createElement('div');
            dialogueContainer.className = 'text-xs mb-2 border-l-4 border-purple-400 pl-3';
            div.appendChild(dialogueContainer);

            const dialogueTitle = document.createElement('strong');
            dialogueTitle.className = 'text-purple-700';
            dialogueContainer.appendChild(dialogueTitle);
            await typeTextInElement(dialogueTitle, `ğŸ’¬ å¯¾è©±å±¥æ­´ (${data.totalTurns || data.dialogueHistory.length} turns):`, 3);

            const turnsContainer = document.createElement('div');
            turnsContainer.className = 'space-y-2 mt-2';
            dialogueContainer.appendChild(turnsContainer);

            for (const turn of data.dialogueHistory) {
                const turnDiv = document.createElement('div');
                turnDiv.className = 'bg-white p-2 rounded border';
                turnsContainer.appendChild(turnDiv);

                const turnHeader = document.createElement('div');
                turnHeader.className = 'font-semibold text-purple-600 mb-1';
                turnDiv.appendChild(turnHeader);
                await typeTextInElement(turnHeader, `Turn ${turn.turn}`, 5);

                // User
                const userDiv = document.createElement('div');
                userDiv.className = 'mb-1';
                turnDiv.appendChild(userDiv);
                const userLabel = document.createElement('span');
                userLabel.className = 'font-medium text-gray-700';
                userDiv.appendChild(userLabel);
                await typeTextInElement(userLabel, 'User:', 5);
                const userPre = document.createElement('pre');
                userPre.className = 'mt-0.5 whitespace-pre-wrap bg-blue-50 p-1.5 rounded text-xs';
                userDiv.appendChild(userPre);
                await typeTextInElement(userPre, turn.user || '', 1);

                // Agent
                const agentDiv = document.createElement('div');
                turnDiv.appendChild(agentDiv);
                const agentLabel = document.createElement('span');
                agentLabel.className = 'font-medium text-gray-700';
                agentDiv.appendChild(agentLabel);
                await typeTextInElement(agentLabel, 'Agent:', 5);
                const agentPre = document.createElement('pre');
                agentPre.className = 'mt-0.5 whitespace-pre-wrap bg-green-50 p-1.5 rounded text-xs';
                agentDiv.appendChild(agentPre);
                await typeTextInElement(agentPre, turn.agent || '', 1);
            }
        } else {
            // å¯¾è©±å±¥æ­´ãŒãªã„å ´åˆã¯ Prompt/Response ã‚’è¡¨ç¤º
            // Prompt
            const promptDiv = document.createElement('div');
            promptDiv.className = 'text-xs mb-2';
            div.appendChild(promptDiv);
            const promptStrong = document.createElement('strong');
            promptDiv.appendChild(promptStrong);
            await typeTextInElement(promptStrong, 'Prompt:', 10);
            const promptPre = document.createElement('pre');
            promptPre.className = 'mt-1 whitespace-pre-wrap bg-gray-50 p-2 rounded';
            promptDiv.appendChild(promptPre);
            await typeTextInElement(promptPre, data.prompt || 'N/A', 2);

            // Response
            const responseDiv = document.createElement('div');
            responseDiv.className = 'text-xs mb-2';
            div.appendChild(responseDiv);
            const responseStrong = document.createElement('strong');
            responseDiv.appendChild(responseStrong);
            await typeTextInElement(responseStrong, 'Response:', 10);
            const responsePre = document.createElement('pre');
            responsePre.className = 'mt-1 whitespace-pre-wrap bg-gray-50 p-2 rounded';
            responseDiv.appendChild(responsePre);
            await typeTextInElement(responsePre, data.response || 'N/A', 2);
        }

        // Expected
        const expectedDiv = document.createElement('div');
        expectedDiv.className = 'text-xs mb-2';
        div.appendChild(expectedDiv);
        const expectedStrong = document.createElement('strong');
        expectedDiv.appendChild(expectedStrong);
        await typeTextInElement(expectedStrong, 'Expected:', 10);
        const expectedPre = document.createElement('pre');
        expectedPre.className = 'mt-1 whitespace-pre-wrap bg-gray-50 p-2 rounded';
        expectedDiv.appendChild(expectedPre);
        await typeTextInElement(expectedPre, data.expected || 'N/A', 2);

        // å“è³ªæŒ‡æ¨™ï¼ˆã‚ã‚Œã°ï¼‰
        if (data.taskCompletion !== undefined && data.taskCompletion !== null) {
            const metricsDiv = document.createElement('div');
            metricsDiv.className = 'text-xs mb-2 bg-purple-50 p-2 rounded border border-purple-200';
            div.appendChild(metricsDiv);

            const metricsTitle = document.createElement('strong');
            metricsTitle.className = 'text-purple-700';
            metricsDiv.appendChild(metricsTitle);
            await typeTextInElement(metricsTitle, 'ãƒãƒ«ãƒã‚¿ãƒ¼ãƒ³å“è³ªæŒ‡æ¨™:', 5);

            const metricsGrid = document.createElement('div');
            metricsGrid.className = 'grid grid-cols-3 gap-2 mt-1';
            metricsDiv.appendChild(metricsGrid);

            // Task Completion
            const tcDiv = document.createElement('div');
            metricsGrid.appendChild(tcDiv);
            const tcSpan = document.createElement('span');
            tcSpan.className = 'text-gray-600';
            tcDiv.appendChild(tcSpan);
            await typeTextInElement(tcSpan, 'Task Completion: ', 3);
            const tcValue = document.createElement('span');
            tcValue.className = 'font-medium';
            tcDiv.appendChild(tcValue);
            await typeTextInElement(tcValue, typeof data.taskCompletion === 'number' ? data.taskCompletion.toFixed(2) : 'N/A', 5);
        }

        // Rationale
        const rationaleDiv = document.createElement('div');
        rationaleDiv.className = 'text-xs text-gray-700';
        div.appendChild(rationaleDiv);
        const rationaleStrong = document.createElement('strong');
        rationaleDiv.appendChild(rationaleStrong);
        await typeTextInElement(rationaleStrong, 'Rationale: ', 10);
        const rationaleSpan = document.createElement('span');
        rationaleDiv.appendChild(rationaleSpan);
        await typeTextInElement(rationaleSpan, data.rationale || 'N/A', 2);
    }

    // ==== End of Section Streaming Renderer ====

    // Connection status handlers
    juryStream.on('connected', () => {
        console.log('[DEBUG] ğŸŸ¢ WebSocket connected event fired');

        // Update unified panel status badge
        const wsStatus = document.getElementById('ws-status');
        console.log('[DEBUG] ws-status element:', wsStatus);
        if (wsStatus) {
            wsStatus.textContent = 'æ¥ç¶šæ¸ˆã¿';
            wsStatus.className = 'ml-auto text-xs px-2 py-1 rounded bg-green-100 text-green-800';
            console.log('[DEBUG] Updated ws-status to "æ¥ç¶šæ¸ˆã¿"');
        }
    });

    juryStream.on('disconnected', () => {
        const wsStatus = document.getElementById('ws-status');
        if (wsStatus) {
            wsStatus.textContent = 'åˆ‡æ–­';
            wsStatus.className = 'ml-auto text-xs px-2 py-1 rounded bg-red-100 text-red-800';
        }
    });

    // Initial state handler - receives cached state on connection
    juryStream.on('initial_state', (data) => {
        console.log('[DEBUG] ğŸ“¦ initial_state event received:', data);

        if (data.category === 'wandb' && data.data) {
            // Dynamically insert W&B section if not already present
            const existingWandB = document.querySelector('.wandb-report-section');
            if (!existingWandB) {
                const wandb = data.data;
                const reviewProgress = document.getElementById('review-progress')?.closest('.p-6');
                if (reviewProgress) {
                    const wandbHtml = `
                    <div class="p-6 border-t border-gray-200 wandb-report-section">
                        <h2 class="text-xl font-semibold mb-4">Weights & Biases Reports</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <div class="flex items-center gap-2 mb-3">
                                    <span class="text-2xl">ğŸ“Š</span>
                                    <div>
                                        <p class="text-sm font-medium text-gray-900">W&B Core Dashboard</p>
                                        <p class="text-xs text-gray-500">Experiment Tracking & Metrics</p>
                                    </div>
                                </div>
                                <div class="mb-3 text-xs text-gray-500">
                                    <p>Run ID: <span class="font-mono">${wandb.runId || ''}</span></p>
                                    <p>Project: ${wandb.project || ''}</p>
                                    <p>Entity: ${wandb.entity || ''}</p>
                                </div>
                                <a href="${wandb.url || `https://wandb.ai/${wandb.entity}/${wandb.project}/runs/${wandb.runId}`}" target="_blank" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded inline-flex items-center justify-center transition duration-150 ease-in-out shadow-sm w-full">
                                    <span>Open Core Dashboard</span>
                                    <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                    </svg>
                                </a>
                            </div>
                            <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                                <div class="flex items-center gap-2 mb-3">
                                    <span class="text-2xl">ğŸ”®</span>
                                    <div>
                                        <p class="text-sm font-medium text-gray-900">W&B Weave Traces</p>
                                        <p class="text-xs text-gray-500">LLM Call Observability</p>
                                    </div>
                                </div>
                                <div class="mb-3 text-xs text-gray-500">
                                    <p>Project: ${wandb.project || ''}</p>
                                    <p>Entity: ${wandb.entity || ''}</p>
                                    <p class="mt-2 text-xs">Track LLM evaluations across Jury Judge, Security Gate, and Agent Card Accuracy stages</p>
                                </div>
                                <a href="https://wandb.ai/${wandb.entity}/${wandb.project}/weave" target="_blank" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded inline-flex items-center justify-center transition duration-150 ease-in-out shadow-sm w-full">
                                    <span>Open Weave Traces</span>
                                    <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                    </svg>
                                </a>
                            </div>
                        </div>
                    </div>`;
                    reviewProgress.insertAdjacentHTML('afterend', wandbHtml);
                    console.log('[DEBUG] ğŸ“¦ W&B section dynamically inserted');
                }
            }
        }
    });

    // Phase change handler - MAGI System
    juryStream.on('phase_change', (data) => {
        console.log('[DEBUG] ğŸ”„ phase_change event handler called with data:', data);

        // Update MAGI phase indicator
        const phaseIndicator = document.getElementById('magi-phase-indicator');
        if (phaseIndicator) {
            const phaseMap = {
                'initial_evaluation': 'Phase 1',
                'discussion': 'Phase 2',
                'final_judgment': 'Phase 3'
            };
            phaseIndicator.textContent = phaseMap[data.phase] || `Phase ${data.phaseNumber || '?'}`;
        }

        // Set all MAGI units to evaluating state at Phase 1 start
        if (data.phaseNumber === 1) {
            // MAGI SYSTEMã®detailsã‚’è‡ªå‹•å±•é–‹ã—ã¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            const judgeDetails = document.getElementById('details-judge');
            if (judgeDetails && !judgeDetails.open) {
                judgeDetails.open = true;
                setTimeout(() => {
                    judgeDetails.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            }

            ['melchior', 'balthasar', 'casper'].forEach(unit => {
                const unitEl = document.getElementById(`magi-${unit}`);
                const statusEl = document.getElementById(`${unit}-status`);
                if (unitEl) unitEl.classList.add('evaluating');
                if (statusEl) statusEl.textContent = 'è©•ä¾¡ä¸­...';
            });
            // SVGã‚³ãƒã‚¯ã‚¿ç·šã‚‚ç‚¹æ»…
            const connectorSvg = document.querySelector('.magi-triangle-connector');
            if (connectorSvg) connectorSvg.classList.add('evaluating');

            // æ±ºè­°è¡¨ç¤ºã‚’ã€Œè©•ä¾¡ä¸­ã€ã«
            const verdictDisplay = document.getElementById('magi-verdict-display');
            if (verdictDisplay) {
                verdictDisplay.textContent = 'è©•ä¾¡ä¸­';
                verdictDisplay.className = 'magi-verdict-text magi-verdict-pending';
            }
        }
    });

    // Helper function to map juror IDs to MAGI unit names
    function getMAGIUnit(jurorId) {
        if (jurorId.includes('gpt-4o') || jurorId.includes('gpt4o')) return 'melchior';
        if (jurorId.includes('claude')) return 'balthasar';
        if (jurorId.includes('gemini')) return 'casper';
        // Fallback based on position
        return 'melchior';
    }

    function getMAGISpeaker(jurorId) {
        const unit = getMAGIUnit(jurorId);
        const names = { melchior: 'MELCHIOR-1', balthasar: 'BALTHASAR-2', casper: 'CASPER-3' };
        return names[unit] || jurorId;
    }

    // Juror evaluation handler (Phase 1) - MAGI System
    // Phase1ã§ãƒãƒ£ãƒƒãƒˆã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º
    juryStream.on('juror_evaluation', (data) => {
        console.log('[DEBUG] ğŸ‘¨â€âš–ï¸ juror_evaluation event handler called with data:', data);

        // Judge PanelãŒé–‰ã˜ã¦ã„ãŸã‚‰é–‹ãï¼ˆDOMã‚¢ã‚¯ã‚»ã‚¹ã®ãŸã‚ï¼‰
        const judgeDetails = document.getElementById('details-judge');
        if (judgeDetails && !judgeDetails.open) {
            judgeDetails.open = true;
            console.log('[DEBUG] ğŸ‘¨â€âš–ï¸ Opened details-judge panel');
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        const unit = getMAGIUnit(data.juror);
        console.log('[DEBUG] ğŸ‘¨â€âš–ï¸ unit:', unit, 'juror:', data.juror);
        pendingJurorResults[unit] = data;

        // ãƒãƒ£ãƒƒãƒˆã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºï¼ˆPhase1ä¸­ï¼‰
        const chatContentId = `${unit}-chat-content`;
        const chatContent = document.getElementById(chatContentId);
        console.log('[DEBUG] ğŸ‘¨â€âš–ï¸ chatContentId:', chatContentId, 'chatContent:', chatContent, 'rationale:', data.rationale ? data.rationale.substring(0, 50) + '...' : 'EMPTY');
        if (chatContent && data.rationale) {
            // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’å‰Šé™¤
            const placeholder = chatContent.querySelector('.magi-chat-placeholder');
            if (placeholder) {
                placeholder.remove();
            }
            // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã§è¡¨ç¤º
            const messageEl = document.createElement('div');
            messageEl.className = 'magi-chat-message typing';
            chatContent.appendChild(messageEl);

            const text = data.rationale;
            let charIndex = 0;
            const typeSpeed = 10;
            function typeChar() {
                if (charIndex < text.length) {
                    messageEl.textContent = text.substring(0, charIndex + 1);
                    charIndex++;
                    chatContent.scrollTop = chatContent.scrollHeight;
                    setTimeout(typeChar, typeSpeed);
                } else {
                    messageEl.classList.remove('typing');
                }
            }
            typeChar();
        }

        // ç«‹å ´å¤‰æ›´ã®æ¤œå‡ºã¨ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤ºã¯ç¶­æŒ
        const juror = data.juror;
        const verdict = data.verdict;
        const prev = previousVerdicts[juror];
        if (prev && prev !== verdict) {
            const name = getMAGISpeaker(juror);
            const verdictText = { 'safe_pass': 'PASS', 'unsafe_fail': 'FAIL', 'needs_review': 'REVIEW' };
            const prevText = verdictText[prev] || prev;
            const newText = verdictText[verdict] || verdict;
            showToast(`${name}: ${prevText} â†’ ${newText} ã«å¤‰æ›´`, 'info');
        }
        previousVerdicts[juror] = verdict;
    });

    // Consensus check handler - MAGI System
    juryStream.on('consensus_check', (data) => {
        console.log('[DEBUG] ğŸ¤ consensus_check event handler called with data:', data);
        // Consensus info is now reflected in Final Judge panel, no separate log needed
    });

    // Discussion start handler (Phase 2) - MAGI System
    juryStream.on('discussion_start', (data) => {
        console.log('[DEBUG] ğŸ’¬ discussion_start event handler called with data:', data);

        // Update phase indicator
        const phaseIndicator = document.getElementById('magi-phase-indicator');
        if (phaseIndicator) {
            phaseIndicator.textContent = 'Phase 2';
        }

        // æ±ºè­°è¡¨ç¤ºã‚’ã€Œå¯©è­°ä¸­ã€ã«ï¼ˆé»„ç·‘è‰²ï¼‰
        const verdictDisplay = document.getElementById('magi-verdict-display');
        if (verdictDisplay) {
            verdictDisplay.textContent = 'å¯©è­°ä¸­';
            verdictDisplay.className = 'magi-verdict-text magi-verdict-deliberating';
        }
    });

    // Juror statement handler - MAGI System (with typing animation to individual chat)
    juryStream.on('juror_statement', (data) => {
        console.log('[DEBUG] ğŸ—£ï¸ juror_statement event handler called with data:', data);

        const unit = getMAGIUnit(data.juror);
        const chatContent = document.getElementById(`${unit}-chat-content`);

        if (chatContent && data.statement) {
            // Add statement with typing animation
            const messageEl = document.createElement('div');
            messageEl.className = 'magi-chat-message typing';
            if (data.positionChanged) {
                messageEl.classList.add('position-changed');
            }
            chatContent.appendChild(messageEl);

            // Typing animation with chat box internal scroll
            let charIndex = 0;
            const statement = data.statement;
            const typingInterval = setInterval(() => {
                if (charIndex < statement.length) {
                    messageEl.textContent = statement.substring(0, charIndex + 1);
                    charIndex++;
                    // ãƒãƒ£ãƒƒãƒˆãƒœãƒƒã‚¯ã‚¹å†…éƒ¨ã®ã¿ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆãƒšãƒ¼ã‚¸å…¨ä½“ã¯å‹•ã‹ã•ãªã„ï¼‰
                    chatContent.scrollTop = chatContent.scrollHeight;
                } else {
                    messageEl.classList.remove('typing');
                    clearInterval(typingInterval);
                }
            }, 15);

            // Update verdict if position changed
            if (data.positionChanged && data.newVerdict) {
                const voteEl = document.getElementById(`${unit}-vote`);
                if (voteEl) {
                    const verdictMap = {
                        'safe_pass': { text: 'PASS', class: 'magi-vote-pass' },
                        'unsafe_fail': { text: 'FAIL', class: 'magi-vote-fail' },
                        'needs_review': { text: 'REVIEW', class: 'magi-vote-review' }
                    };
                    const v = verdictMap[data.newVerdict] || { text: data.newVerdict, class: '' };
                    voteEl.textContent = v.text;
                    voteEl.className = `magi-unit-vote ${v.class}`;
                }
            }
        }
    });

    // Round complete handler - MAGI System
    juryStream.on('round_complete', (data) => {
        console.log('[DEBUG] ğŸ”„ round_complete event handler called with data:', data);
        // Round info is logged but no separate UI element needed
    });

    // Final judgment handler (Phase 3) - MAGI System (Evangelion Triangular Layout)
    juryStream.on('final_judgment', (data) => {
        console.log('[DEBUG] âš–ï¸ final_judgment event handler called with data:', data);

        // MCTSè¤‡æ•°ãƒ­ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆæ™‚ã®é‡è¤‡é˜²æ­¢ï¼š2å›ç›®ä»¥é™ã¯ã‚¹ã‚­ãƒƒãƒ—
        if (finalJudgmentReceived) {
            console.log('[DEBUG] âš–ï¸ final_judgment already received, skipping duplicate');
            return;
        }
        finalJudgmentReceived = true;

        // Toast notification
        const trustScore = data.trustScore || data.finalScore || 0;
        const verdict = data.verdict || data.finalVerdict;
        const toastType = verdict === 'safe_pass' ? 'success' : (verdict === 'unsafe_fail' ? 'error' : 'warning');
        showToast(`Jury Judge: Trust Score ${Math.floor(trustScore)}ç‚¹`, toastType);

        // ãƒšãƒ¼ã‚¸å…¨ä½“ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ä¿å­˜
        const pageScrollTop = window.scrollY || document.documentElement.scrollTop;

        // Update phase indicator
        const phaseIndicator = document.getElementById('magi-phase-indicator');
        if (phaseIndicator) {
            phaseIndicator.textContent = 'Phase 3 å®Œäº†';
        }

        // Update phase display in system info
        const phaseDisplay = document.getElementById('magi-phase-display');
        if (phaseDisplay) {
            phaseDisplay.textContent = '3';
        }

        // Update trust score display in system info
        const trustDisplay = document.getElementById('magi-trust-display');
        if (trustDisplay) {
            trustDisplay.textContent = Math.floor(trustScore);
        }

        // Update final verdict display (top right large display)
        const verdictDisplay = document.getElementById('magi-verdict-display');
        if (verdictDisplay) {
            const finalVerdict = data.finalVerdict || data.verdict;
            const verdictClass = finalVerdict === 'safe_pass' ? 'magi-verdict-pass'
                : (finalVerdict === 'unsafe_fail' ? 'magi-verdict-fail' : 'magi-verdict-review');

            const verdictText = finalVerdict === 'safe_pass' ? 'å¯æ±º'
                : (finalVerdict === 'unsafe_fail' ? 'å¦æ±º' : 'è¦ç¢ºèª');

            // Remove old classes, add new verdict class
            verdictDisplay.className = `magi-verdict-text ${verdictClass}`;
            verdictDisplay.textContent = verdictText;
        }

        // Show FINAL JUDGE chat box (was hidden until Phase 3)
        const finalJudgeChat = document.getElementById('final-judge-chat');
        if (finalJudgeChat) {
            finalJudgeChat.style.display = 'flex';
        }

        // å…¨ã‚«ãƒ¼ãƒ‰ã®ç‚¹æ»…ã‚’åœæ­¢ï¼ˆPhase2å®Œäº†ï¼‰
        ['melchior', 'balthasar', 'casper'].forEach(unit => {
            const unitEl = document.getElementById(`magi-${unit}`);
            if (unitEl) unitEl.classList.remove('evaluating');
        });

        // SVGã‚³ãƒã‚¯ã‚¿ç·šã®ç‚¹æ»…ã‚’åœæ­¢
        const connectorSvg = document.querySelector('.magi-triangle-connector');
        if (connectorSvg) connectorSvg.classList.remove('evaluating');

        // ä¿å­˜ã—ãŸjuror_evaluationãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã£ã¦å…¨ã‚«ãƒ¼ãƒ‰ã‚’ä¸€æ‹¬æ›´æ–°
        ['melchior', 'balthasar', 'casper'].forEach(unit => {
            const jurorData = pendingJurorResults[unit];
            if (!jurorData) return;

            const unitEl = document.getElementById(`magi-${unit}`);
            const voteEl = document.getElementById(`${unit}-vote`);
            const scoresEl = document.getElementById(`${unit}-scores`);
            const chatContent = document.getElementById(`${unit}-chat-content`);

            // ã‚«ãƒ¼ãƒ‰ã®è‰²ã‚’æ›´æ–°
            if (unitEl) {
                unitEl.classList.remove('verdict-pending');
                unitEl.classList.add('vote-confirmed');
                unitEl.classList.remove('verdict-pass', 'verdict-fail', 'verdict-review');
                if (jurorData.verdict === 'safe_pass') {
                    unitEl.classList.add('verdict-pass');
                } else if (jurorData.verdict === 'unsafe_fail') {
                    unitEl.classList.add('verdict-fail');
                } else if (jurorData.verdict === 'needs_review') {
                    unitEl.classList.add('verdict-review');
                }
            }

            // æŠ•ç¥¨ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
            if (voteEl) {
                const verdictMap = {
                    'safe_pass': { text: 'PASS', class: 'magi-vote-pass' },
                    'unsafe_fail': { text: 'FAIL', class: 'magi-vote-fail' },
                    'needs_review': { text: 'REVIEW', class: 'magi-vote-review' }
                };
                const v = verdictMap[jurorData.verdict] || { text: jurorData.verdict, class: '' };
                voteEl.textContent = v.text;
                voteEl.className = `magi-unit-vote ${v.class}`;
            }

            // ã‚¹ã‚³ã‚¢ãƒãƒ¼ã‚’æ›´æ–°
            if (scoresEl) {
                const tc = jurorData.taskCompletion || 0;
                const tu = jurorData.toolUsage || 0;
                const au = jurorData.autonomy || 0;
                const sf = jurorData.safety || 0;

                const taskBar = scoresEl.querySelector('[data-axis="task"] .fill');
                const taskVal = scoresEl.querySelector('[data-axis="task"] .val');
                if (taskBar) taskBar.style.width = `${(tc / 40) * 100}%`;
                if (taskVal) taskVal.textContent = Math.floor(tc);

                const toolBar = scoresEl.querySelector('[data-axis="tool"] .fill');
                const toolVal = scoresEl.querySelector('[data-axis="tool"] .val');
                if (toolBar) toolBar.style.width = `${(tu / 30) * 100}%`;
                if (toolVal) toolVal.textContent = Math.floor(tu);

                const autoBar = scoresEl.querySelector('[data-axis="auto"] .fill');
                const autoVal = scoresEl.querySelector('[data-axis="auto"] .val');
                if (autoBar) autoBar.style.width = `${(au / 20) * 100}%`;
                if (autoVal) autoVal.textContent = Math.floor(au);

                const safeBar = scoresEl.querySelector('[data-axis="safe"] .fill');
                const safeVal = scoresEl.querySelector('[data-axis="safe"] .val');
                if (safeBar) safeBar.style.width = `${(sf / 10) * 100}%`;
                if (safeVal) safeVal.textContent = Math.floor(sf);
            }

            // ãƒãƒ£ãƒƒãƒˆã«rationaleã‚’è¿½åŠ 
            if (chatContent && jurorData.rationale) {
                const placeholder = chatContent.querySelector('.magi-chat-placeholder');
                if (placeholder) placeholder.remove();

                const messageEl = document.createElement('div');
                messageEl.className = 'magi-chat-message';
                messageEl.textContent = jurorData.rationale;
                chatContent.appendChild(messageEl);
            }
        });

        // Update FINAL JUDGE section content with typing animation
        // rationaleï¼ˆæœ€çµ‚ã‚¸ãƒ£ãƒƒã‚¸ã®è©•ä¾¡ç†ç”±ï¼‰ã‚’å„ªå…ˆè¡¨ç¤º
        const finalJudgeContent = document.getElementById('final-judge-content');
        if (finalJudgeContent) {
            // ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è©•ä¾¡ç†ç”±ã‚’å–å¾—ï¼ˆè¤‡æ•°ã®ã‚­ãƒ¼åã«å¯¾å¿œï¼‰
            const finalJudgeResponse = data.rationale || data.finalJudgeRationale || data.finalRationale || '';
            console.log('[DEBUG] FINAL JUDGE rationale:', finalJudgeResponse);
            console.log('[DEBUG] FINAL JUDGE data keys:', Object.keys(data));

            // Remove placeholder if exists
            const placeholder = finalJudgeContent.querySelector('.magi-chat-placeholder');
            if (placeholder) placeholder.remove();

            if (finalJudgeResponse) {
                // Add rationale message with typing animation
                const messageEl = document.createElement('div');
                messageEl.className = 'magi-chat-message typing';
                finalJudgeContent.appendChild(messageEl);

                // Typing animationï¼ˆæœ€çµ‚ã‚¸ãƒ£ãƒƒã‚¸ã®ã¿ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è¨±å¯ï¼‰
                let charIndex = 0;
                const typingInterval = setInterval(() => {
                    if (charIndex < finalJudgeResponse.length) {
                        messageEl.textContent = finalJudgeResponse.substring(0, charIndex + 1);
                        charIndex++;
                        // æœ€çµ‚ã‚¸ãƒ£ãƒƒã‚¸ã®ã¿ãƒãƒ£ãƒƒãƒˆãƒœãƒƒã‚¯ã‚¹å†…ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è¨±å¯
                        finalJudgeContent.scrollTop = finalJudgeContent.scrollHeight;
                    } else {
                        messageEl.classList.remove('typing');
                        clearInterval(typingInterval);
                    }
                }, 10);  // 10msã§é«˜é€Ÿè¡¨ç¤º
            } else {
                // rationaleãŒãªã„å ´åˆã¯ã‚µãƒãƒªãƒ¼ã‚’è¡¨ç¤º
                const summaryText = `Trust Score: ${Math.floor(trustScore)}ç‚¹ / åˆ¤å®š: ${verdict === 'safe_pass' ? 'å¯æ±º' : (verdict === 'unsafe_fail' ? 'å¦æ±º' : 'è¦ç¢ºèª')}`;
                const messageEl = document.createElement('div');
                messageEl.className = 'magi-chat-message';
                messageEl.textContent = summaryText;
                finalJudgeContent.appendChild(messageEl);
                console.log('[DEBUG] FINAL JUDGE: No rationale found, showing summary');
            }
        }

        // ãƒšãƒ¼ã‚¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¾©å…ƒå‡¦ç†ã¯å‰Šé™¤ï¼ˆãƒãƒ§ãƒ­ãƒãƒ§ãƒ­å‹•ãå•é¡Œã®è§£æ¶ˆï¼‰
    });

            // Evaluation complete handler
    juryStream.on('evaluation_complete', (data) => {
        console.log('[DEBUG] ğŸ‰ Evaluation complete - keeping real-time display visible');
        console.log('[DEBUG] Evaluation complete data:', data);

                // Keep real-time display visible instead of reloading
                // User can manually reload or navigate to see static results

                // Update status to show evaluation is complete
        const wsStatus = document.getElementById('ws-status');
        if (wsStatus) {
            wsStatus.textContent = 'è©•ä¾¡å®Œäº†';
            wsStatus.className = 'ml-auto text-xs px-2 py-1 rounded bg-blue-100 text-blue-800';
                }

                // WebSocket-only architecture - no AJAX polling needed
                // All updates come via WebSocket in real-time
        console.log('[DEBUG] Evaluation complete - WebSocket-only mode (no polling)');
            });

            // Error handler
    juryStream.on('error', (data) => {
                console.error('Jury Judge WebSocket error:', data);
        const wsStatus = document.getElementById('ws-status');
        if (wsStatus) {
            wsStatus.textContent = 'ã‚¨ãƒ©ãƒ¼';
            wsStatus.className = 'ml-auto text-xs px-2 py-1 rounded bg-red-100 text-red-800';
                }
            });

    // Submission state change handler
    juryStream.on('submission_state_change', (data) => {
        console.log('[DEBUG] ğŸ”„ submission_state_change event:', data);

        // Update state display without full page reload
        const stateEl = document.querySelector('[data-state-display]');
        if (stateEl && data.newState) {
            stateEl.textContent = data.newState;
            console.log(`[DEBUG] âœ… Updated state display to: ${data.newState}`);
        }
    });

    // Score update handler - using data-score attributes
    juryStream.on('score_update', (data) => {
        console.log('[DEBUG] ğŸ“Š score_update event:', data);

        // Update scores in real-time using data-score attributes
        if (data.scores) {
            // Update trust score
            if (data.scores.trust_score !== undefined) {
                const trustScoreEl = document.querySelector('[data-score="trust"]');
                if (trustScoreEl) {
                    trustScoreEl.textContent = data.scores.trust_score;
                    console.log(`[DEBUG] âœ… Updated trust score to: ${data.scores.trust_score}`);
                }
            }

            // Update Security Gate summary counts
            if (data.scores.security_summary) {
                const sec = data.scores.security_summary;
                const setText = (id, value) => {
                    const el = document.getElementById(id);
                    if (el && value !== undefined) el.textContent = value;
                };
                setText('summary-security-passed', sec.passed ?? 0);
                setText('summary-security-needs', sec.needsReview ?? 0);
                setText('summary-security-failed', sec.failed ?? 0);
                // update all total denominators
                document.querySelectorAll('.summary-security-total').forEach(el => {
                    el.textContent = sec.total ?? 0;
                });
            }

            // Update Agent Card Accuracy summary counts
            if (data.scores.functional_summary) {
                const fn = data.scores.functional_summary;
                const setText = (id, value) => {
                    const el = document.getElementById(id);
                    if (el && value !== undefined) el.textContent = value;
                };
                setText('summary-functional-passed', fn.passed_scenarios ?? 0);
                setText('summary-functional-needs', fn.needsReview ?? 0);
                setText('summary-functional-failed', fn.failed_scenarios ?? 0);
                document.querySelectorAll('.summary-functional-total').forEach(el => {
                    el.textContent = fn.total_scenarios ?? 0;
                });
            }

            // Update judge summary breakdown
            if (data.scores.judge_summary) {
                const js = data.scores.judge_summary;
                const taskEl = document.querySelector('[data-judge-task]');
                const toolEl = document.querySelector('[data-judge-tool]');
                const autoEl = document.querySelector('[data-judge-autonomy]');
                const safetyEl = document.querySelector('[data-judge-safety]');
                if (taskEl && js.taskCompletion !== undefined) taskEl.textContent = `${js.taskCompletion}/100`;
                if (toolEl && js.tool !== undefined) toolEl.textContent = `${js.tool}/100`;
                if (autoEl && js.autonomy !== undefined) autoEl.textContent = `${js.autonomy}/100`;
                if (safetyEl && js.safety !== undefined) safetyEl.textContent = `${js.safety}/100`;
            }

        }
    });

    // Stage update handler - for progress bar and content updates
    juryStream.on('stage_update', async (data) => {
        console.log('[DEBUG] ğŸ¯ stage_update event:', data);

        if (data.stage && data.status) {
            // Update progress bar icon immediately
            const stageEl = document.querySelector(`[data-stage="${data.stage}"]`);
            if (stageEl) {
                // Remove all status classes
                stageEl.classList.remove(
                    'bg-green-100', 'border-green-500',
                    'bg-red-100', 'border-red-500',
                    'bg-yellow-100', 'border-yellow-500', 'animate-pulse',
                    'bg-gray-100', 'border-gray-300'
                );

                // Add appropriate classes based on status
                if (data.status === 'completed') {
                    stageEl.classList.add('bg-green-100', 'border-green-500');
                    console.log(`[DEBUG] âœ… Stage ${data.stage} marked as completed`);
                } else if (data.status === 'failed') {
                    stageEl.classList.add('bg-red-100', 'border-red-500');
                    console.log(`[DEBUG] âŒ Stage ${data.stage} marked as failed`);
                } else if (data.status === 'running') {
                    stageEl.classList.add('bg-yellow-100', 'border-yellow-500', 'animate-pulse');
                    console.log(`[DEBUG] â³ Stage ${data.stage} marked as running`);
                } else {
                    stageEl.classList.add('bg-gray-100', 'border-gray-300');
                    console.log(`[DEBUG] â¸ï¸ Stage ${data.stage} marked as pending`);
                }
            }

            // Update status badge text immediately
            const statusBadge = document.querySelector(`[data-stage-status="${data.stage}"]`);
            if (statusBadge) {
                const statusText = {
                    'completed': 'âœ… å®Œäº†',
                    'failed': 'âŒ å¤±æ•—',
                    'running': 'â³ å®Ÿè¡Œä¸­'
                };
                statusBadge.textContent = statusText[data.status] || 'â¸ï¸ å¾…æ©Ÿä¸­';
                console.log(`[DEBUG] ğŸ“ Updated status badge for ${data.stage} to: ${statusBadge.textContent}`);
            }
            // NOTE: fetchâ†’innerHTML ã«ã‚ˆã‚‹å…¨ä½“æ›´æ–°ã¯å‰Šé™¤ï¼ˆDOMè¦ç´ ã®å‚ç…§ãŒåˆ‡ã‚Œã¦ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°è¡¨ç¤ºãŒå£Šã‚Œã‚‹ãŸã‚ï¼‰
        }
    });

    // Connect SSE client
    juryStream.connect();

    // åˆæœŸè¡¨ç¤ºæ™‚ã«å„ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ã‚’æœ€ä¸‹éƒ¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    ['balthasar', 'casper', 'melchior'].forEach(unit => {
        const chatLog = document.getElementById(`${unit}-chat`);
        if (chatLog) {
            chatLog.scrollTop = chatLog.scrollHeight;
        }
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        juryStream.disconnect();
        if (jurySSE) {
            jurySSE.close();
        }
    });
})();
</script>
