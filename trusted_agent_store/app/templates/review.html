{% extends "base.html" %}

{% block title %}å¯©æŸ»çŠ¶æ³ - Agent Store{% endblock %}

{% block content %}
<div class="container">
    <h1>å¯©æŸ»çŠ¶æ³: {{ submission.id }}</h1>

    <div style="margin: 2rem 0;">
        <div
            style="padding: 1rem; background: #f7fafc; border-left: 4px solid #667eea; border-radius: 4px; margin-bottom: 1.5rem;">
            <strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</strong>
            <span style="font-size: 1.2rem; color: #667eea; font-weight: 600;">
                {{ submission.status }}
            </span>
        </div>

        <div style="margin-bottom: 1rem;">
            <strong>Agent Card URL:</strong><br>
            <a href="{{ submission.agent_card_url }}" target="_blank" style="color: #667eea;">
                {{ submission.agent_card_url }}
            </a>
        </div>

        <div style="margin-bottom: 1rem;">
            <strong>Endpoint URL:</strong><br>
            <a href="{{ submission.endpoint_url }}" target="_blank" style="color: #667eea;">
                {{ submission.endpoint_url }}
            </a>
        </div>

        <div style="margin-bottom: 1rem;">
            <strong>ç™»éŒ²æ—¥æ™‚:</strong> {{ submission.created_at.strftime('%Y-%m-%d %H:%M:%S') }}
        </div>
    </div>

    <h2 style="margin-top: 2rem; margin-bottom: 1rem;">å¯©æŸ»ã‚¹ãƒ†ãƒ¼ã‚¸</h2>

    <div style="display: grid; gap: 1rem;">
        {% if submission.stages and submission.stages.get('precheck') %}
        <div style="padding: 1rem; border: 2px solid #667eea; border-radius: 8px;">
            <h3 style="color: #667eea; margin-bottom: 0.5rem;">1ï¸âƒ£ PreCheck</h3>
            <pre
                style="background: #f7fafc; padding: 1rem; border-radius: 4px; overflow-x: auto;">{{ submission.stages.precheck | tojson(indent=2) }}</pre>
        </div>
        {% endif %}

        {% if submission.stages and submission.stages.get('security') %}
        <div style="padding: 1rem; border: 2px solid #48bb78; border-radius: 8px;">
            <h3 style="color: #48bb78; margin-bottom: 0.5rem;">2ï¸âƒ£ Security Gate</h3>
            <pre
                style="background: #f7fafc; padding: 1rem; border-radius: 4px; overflow-x: auto;">{{ submission.stages.security | tojson(indent=2) }}</pre>
        </div>
        {% endif %}

        {% if submission.stages and submission.stages.get('functional') %}
        <div style="padding: 1rem; border: 2px solid #ed8936; border-radius: 8px;">
            <h3 style="color: #ed8936; margin-bottom: 0.5rem;">3ï¸âƒ£ Functional Accuracy</h3>
            <pre
                style="background: #f7fafc; padding: 1rem; border-radius: 4px; overflow-x: auto;">{{ submission.stages.functional | tojson(indent=2) }}</pre>
        </div>
        {% endif %}

        {% if submission.stages and submission.stages.get('judge') %}
        <div style="padding: 1rem; border: 2px solid #9f7aea; border-radius: 8px;">
            <h3 style="color: #9f7aea; margin-bottom: 0.5rem;">4ï¸âƒ£ Judge Panel</h3>
            <pre
                style="background: #f7fafc; padding: 1rem; border-radius: 4px; overflow-x: auto;">{{ submission.stages.judge | tojson(indent=2) }}</pre>
        </div>
        {% endif %}
    </div>

    {% if submission.status == 'human_review_pending' %}
    <div style="margin-top: 2rem; padding: 1.5rem; background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px;">
        <h3 style="color: #856404; margin-bottom: 1rem;">âš ï¸ Human Review ãŒå¿…è¦ã§ã™</h3>
        <p style="margin-bottom: 1rem;">ã“ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯è‡ªå‹•å¯©æŸ»ã‚’å®Œäº†ã—ã¾ã—ãŸã€‚æœ€çµ‚æ‰¿èªã‚’è¡Œã£ã¦ãã ã•ã„ã€‚</p>

        <div style="display: flex; gap: 1rem;">
            <button onclick="approve('{{ submission.id }}')" class="btn">âœ… æ‰¿èª</button>
            <button onclick="reject('{{ submission.id }}')" class="btn btn-secondary">âŒ å·®æˆ»ã—</button>
        </div>
    </div>
    {% endif %}

    {% if submission.status == 'approved' %}
    <div style="margin-top: 2rem; padding: 1.5rem; background: #d4edda; border: 1px solid #28a745; border-radius: 8px;">
        <h3 style="color: #155724;">âœ… æ‰¿èªæ¸ˆã¿</h3>
        <p>ã“ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯å…¬é–‹ã•ã‚Œã¾ã—ãŸã€‚</p>
    </div>
    {% endif %}

    {% if submission.status == 'rejected' %}
    <div style="margin-top: 2rem; padding: 1.5rem; background: #f8d7da; border: 1px solid #dc3545; border-radius: 8px;">
        <h3 style="color: #721c24;">âŒ å·®æˆ»ã—</h3>
        {% if submission.stages and submission.stages.get('rejection_reason') %}
        <p><strong>ç†ç”±:</strong> {{ submission.stages.rejection_reason }}</p>
        {% endif %}
    </div>
    {% endif %}

    <div style="margin-top: 2rem;">
        <button onclick="location.reload()" class="btn btn-secondary">ğŸ”„ æ›´æ–°</button>
        <a href="/submissions" class="btn btn-secondary"
            style="margin-left: 1rem; display: inline-block; text-decoration: none;">ğŸ“‹ ä¸€è¦§ã«æˆ»ã‚‹</a>
    </div>
</div>

<script>
    async function approve(id) {
        if (!confirm('ã“ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’æ‰¿èªã—ã¾ã™ã‹ï¼Ÿ')) return;

        try {
            const response = await fetch(`/api/review/${id}/approve`, {
                method: 'POST'
            });

            if (response.ok) {
                alert('æ‰¿èªã—ã¾ã—ãŸ');
                location.reload();
            } else {
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        } catch (error) {
            alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
        }
    }

    async function reject(id) {
        const reason = prompt('å·®æˆ»ã—ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
        if (!reason) return;

        try {
            const response = await fetch(`/api/review/${id}/reject?reason=${encodeURIComponent(reason)}`, {
                method: 'POST'
            });

            if (response.ok) {
                alert('å·®æˆ»ã—ã¾ã—ãŸ');
                location.reload();
            } else {
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        } catch (error) {
            alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
        }
    }

    // Auto-refresh every 5 seconds if in progress
    {% if submission.status.endswith('_running') or submission.status.endswith('_pending') %}
    setTimeout(() => location.reload(), 5000);
    {% endif %}
</script>
{% endblock %}